<style>
    #tutorial-container {
        position: relative;
        text-align: center;
        overflow: hidden;
    }
    .tutorial-step {
        display: none; /* All steps are hidden by default */
        text-align: left;
    }
    #tutorial-step-0, #tutorial-step-final, #tutorial-cancelled {
        text-align: center;
        padding: 50px 0;
    }
    #tutorial-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
        border-top: 1px solid var(--border-color);
        padding-top: 20px;
    }
    .tutorial-prompt {
        background: rgba(0,0,0,0.85);
        border: 1px solid var(--accent-color);
        padding: 15px;
        margin-top: 20px;
        line-height: 1.6;
    }
    .tutorial-prompt h3 {
        color: var(--accent-color);
        margin: 0 0 10px 0;
        text-transform: uppercase;
    }
    .image-container {
        position: relative;
        border: 1px solid var(--border-color);
    }
    .image-container img {
        display: block;
        width: 100%;
        height: auto;
    }
    .dim-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 1;
    }
    .highlight-box {
        position: absolute;
        z-index: 2;
        box-shadow: 0 0 0 3px var(--accent-color), 0 0 15px var(--accent-color) inset;
        background: rgba(0, 255, 85, 0.1);
        pointer-events: none;
    }
</style>

<div id="tutorial-container" class="content-menu">
    <audio id="tutorial-audio" loop src="https://github.com/Cain-in-the-Abel/VTM-V5-Houserules/raw/main/Splinter%20Cell%201%20HD%20OST%20-%20Training%20Covert%20Ops.mp3"></audio>

    <!-- Step 0: Initial "Begin" Screen -->
    <div id="tutorial-step-0" class="tutorial-step" style="display: block;">
        <p style="margin-bottom: 25px;">Welcome, Agent. This tutorial will guide you through the N.E.M.E.S.I.S. operative interface.</p>
        <button onclick="document.getElementById('tutorial-step-0').style.display='none'; document.getElementById('tutorial-step-1').style.display='block';">> BEGIN</button>
    </div>

    <!-- Step 1: Confirmation -->
    <div id="tutorial-step-1" class="tutorial-step">
        <h2 style="text-align:center;">AGENT FILE CREATION</h2>
        <p>This tutorial will demonstrate how to create and manage your agent's digital file using the SOCOM websheet. The process is critical for mission readiness and long-term operational tracking. All data is logged and monitored by N.E.M.E.S.I.S. command.</p>
        <p>Proceed with the training simulation?</p>
        <div id="tutorial-controls">
            <button onclick="startTutorial()">CONTINUE</button>
            <button class="remove-btn" style="color: var(--danger-color); border-color: var(--danger-color);" onclick="cancelTutorial()">CANCEL</button>
        </div>
    </div>

    <!-- Steps 2-16: Main Tutorial Content -->
    <div id="tutorial-content" style="display: none;">
        <div id="image-map">
            <!-- This will be populated by JS -->
        </div>
        <div id="prompt-area">
            <!-- This will be populated by JS -->
        </div>
        <div id="tutorial-controls">
            <button onclick="prevStep()">BACK</button>
            <button onclick="nextStep()">NEXT</button>
            <button class="remove-btn" style="color: var(--danger-color); border-color: var(--danger-color);" onclick="cancelTutorial()">CANCEL</button>
        </div>
    </div>

    <!-- Final Step -->
    <div id="tutorial-step-final" class="tutorial-step">
        <h2>BRIEFING COMPLETE</h2>
        <p>You have concluded the agent file tutorial. Remember your training. Your performance reflects directly on this unit.</p>
        <p>Key reminders:</p>
        <ul style="text-align: left; max-width: 400px; margin: 20px auto;">
            <li>SAVE your character sheet after every session to prevent data loss.</li>
            <li>CHECK the box next to any skill you FAIL during an operation. This marks it for potential improvement.</li>
        </ul>
        <button onclick="showView('main')">> RETURN TO MENU</button>
    </div>
    
    <!-- Cancellation Message -->
    <div id="tutorial-cancelled" class="tutorial-step">
        <h2>TUTORIAL CANCELLED</h2>
        <p>You have aborted the training simulation. A record of this action has been logged.</p>
        <button onclick="showView('main')">> RETURN TO MENU</button>
    </div>

</div>

<script>
    let currentStep = 0;
    const audio = document.getElementById('tutorial-audio');
    audio.volume = 0.3;

    // Each object in the array represents a step of the tutorial.
    const tutorialSteps = [
        { // 0: This is a placeholder for the initial screens. Logic is handled separately.
            image: '',
            highlight: {},
            prompt: ''
        },
        { // 1: Initial screens part 2
            image: '',
            highlight: {},
            prompt: ''
        },
        { // 2: Click "Create New Agent File"
            image: 'https://i.imgur.com/83nOAtS.png', // Represents main menu
            highlight: { top: '65.8%', left: '26.2%', width: '47.6%', height: '8.5%' },
            prompt: '<h3>FILE CREATION</h3>To begin, you must create a new file for your operative. This initializes their digital presence within the N.E.M.E.S.I.S. network. Select "> CREATE NEW AGENT FILE" to proceed.'
        },
        { // 3: Full Name
            image: 'https://i.imgur.com/K4gX2i3.png', // Represents blank character sheet
            highlight: { top: '7.8%', left: '2.5%', width: '31%', height: '7.2%' },
            prompt: '<h3>IDENTIFICATION</h3>Your agent\'s full name. This is their official designation in all reports. Enter the name and proceed.'
        },
        { // 4: Branch
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '7.8%', left: '34.5%', width: '31%', height: '7.2%' },
            prompt: '<h3>BRANCH</h3>Select your agent\'s military or agency branch. This choice primarily dictates available ranks and provides operational flavor.<ul><li><b>NSA/CIA:</b> Choose for operations centered on intelligence, espionage, and infiltration.</li><li><b>Army/Navy/Marines/Air Force:</b> Choose for direct action, field combat, and special warfare roles.</li></ul>Gameplay is not heavily restricted by this choice, but it sets the tone for your agent\'s background.'
        },
        { // 5: Theme
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '1.2%', left: '94.5%', width: '4.5%', height: '5.2%'},
            prompt: '<h3>INTERFACE THEME</h3>The user interface can be customized. Based on your branch selection, a default theme is applied. You can manually override the theme at any time by accessing the settings gear in the top-right corner. Officer ranks (O-1+) have a unique "Command" theme.'
        },
        { // 6: Rank
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '7.8%', left: '66.5%', width: '31%', height: '7.2%' },
            prompt: '<h3>RANK/GRADE</h3>New agents begin at a foundational rank (E-5 for enlisted, GS-11 for officers). Promotion is earned through successful operations. Higher ranks (E-8+, GS-14+) are locked and represent significant field experience and are difficult to obtain.'
        },
        { // 7: Team, Sex, DOB, etc.
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '15.5%', left: '2.5%', width: '95%', height: '7.2%' },
            prompt: '<h3>PERSONNEL DATA</h3>Fill in the remaining identification details. For now, select Team 1 or 2. The Employer field should detail their specific unit, like "U.S. Army Rangers" or "CIA SAD." Education and other details can be added later to flesh out your agent\'s backstory.'
        },
        { // 8: Core Attributes
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '24.2%', left: '1.4%', width: '42.5%', height: '24%' },
            prompt: '<h3>CORE ATTRIBUTES</h3>You have 25 points to define your agent\'s core capabilities. Each stat begins at 8. Distribute points to raise them, to a maximum of 18.<ul><li><b>STR (Strength):</b> Physical power.</li><li><b>DEX (Dexterity):</b> Agility and precision.</li><li><b>CON (Constitution):</b> Health and endurance.</li><li><b>INT (Intelligence):</b> Logic and reasoning.</li><li><b>POW (Power):</b> Willpower and mental fortitude.</li><li><b>CHA (Charisma):</b> Influence and force of personality.</li></ul>'
        },
        { // 9: Derived Attributes
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '48.8%', left: '1.4%', width: '42.5%', height: '17%' },
            prompt: '<h3>DERIVED ATTRIBUTES</h3>These values are calculated from your Core Attributes.<ul><li><b>HP (Hit Points):</b> Physical health. Reaches 0, you are incapacitated or dead.</li><li><b>AP (Armor Points):</b> Damage reduction from armor. We will cover this later.</li><li><b>WP (Willpower Points):</b> Mental fuel for difficult tasks.</li><li><b>SAN (Sanity):</b> Your grip on reality. Reduced by trauma.</li><li><b>BP (Breaking Point):</b> If your SAN drops to this level, you suffer a psychotic episode.</li></ul>'
        },
        { // 10: Bonds
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '66.2%', left: '1.4%', width: '42.5%', height: '12%' },
            prompt: '<h3>BONDS</h3>Bonds represent connections to people and ideals that keep your agent grounded. They are your primary defense against sanity loss between missions. The maximum score for each Bond is equal to your CHA stat.'
        },
        { // 11: Psych Profile
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '78.8%', left: '1.4%', width: '42.5%', height: '12.5%' },
            prompt: '<h3>PSYCH PROFILE</h3>Exposure to trauma hardens an agent. Every time you suffer SAN loss from Violence or Helplessness, check a box. Once all three boxes in a category are checked, you become "Adapted." You no longer lose SAN from that type of trauma, but you lose a piece of your humanity in the process.'
        },
        { // 12: Skills
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '24.2%', left: '44.8%', width: '53.8%', height: '67%' },
            prompt: '<h3>SKILLS</h3>You have 300 points to customize your professional skills, and an additional 50 points reserved for Foreign Languages. No skill can exceed 80% during creation. Hover over a skill name to see its description and applications in the field. Choose wisely; your life will depend on it.'
        },
        { // 13: Skill Improvement
            image: 'https://i.imgur.com/jV7Dct0.png', // Represents skill with checkbox
            highlight: { top: '27.4%', left: '46.1%', width: '25.2%', height: '3.6%' },
            prompt: '<h3>SKILL IMPROVEMENT</h3>During an operation, if you fail a roll for a skill, you must check the box next to it. At the end of the session, the "Roll 1d4s" button will appear. Activating it will roll 1d4 and add the result to every checked skill, representing field experience. For this tutorial, we will check "Alertness" and roll.'
        },
         { // 14: Weapons
            image: 'https://i.imgur.com/K4gX2i3.png',
            highlight: { top: '92.2%', left: '1.4%', width: '97.2%', height: '7%' },
            prompt: '<h3>WEAPONS & EQUIPMENT</h3>This section is for your gear. You can fill out Armor, Gear, and Notes later. Notes are useful for tracking injuries, mission objectives, or character details. We will now add a standard sidearm. Click the "+ ADD WEAPON" button.'
        },
        { // 15: Add Medium Pistol
            image: 'https://i.imgur.com/g0nUnRR.png', // Represents weapon modal
            highlight: { top: '42.8%', left: '3.4%', width: '93.2%', height: '12.2%' },
            prompt: '<h3>WEAPON SELECTION</h3>The weapon database contains numerous preset options. Select the "Firearms" category, then find the "Medium Pistol" and click "SELECT." This will add a standard service pistol, like a Glock 19 or Beretta M9, to your sheet with all its relevant stats pre-filled.'
        },
    ];

    function startTutorial() {
        currentStep = 2; // Start at the first real step
        document.getElementById('tutorial-step-1').style.display = 'none';
        document.getElementById('tutorial-content').style.display = 'block';
        audio.play().catch(e => console.log("Audio autoplay failed:", e));
        showStep(currentStep);
    }

    function cancelTutorial() {
        audio.pause();
        audio.currentTime = 0;
        document.querySelectorAll('.tutorial-step, #tutorial-content').forEach(el => el.style.display = 'none');
        document.getElementById('tutorial-cancelled').style.display = 'block';
    }

    function endTutorial() {
        audio.pause();
        audio.currentTime = 0;
        document.getElementById('tutorial-content').style.display = 'none';
        document.getElementById('tutorial-step-final').style.display = 'block';
    }

    function showStep(index) {
        const stepData = tutorialSteps[index];
        const imageMap = document.getElementById('image-map');
        const promptArea = document.getElementById('prompt-area');

        // Build the HTML for the current step's image and highlight
        let imageHtml = `<div class="image-container">
            <img src="${stepData.image}" alt="Tutorial Step ${index}">
            <div class="dim-overlay"></div>
            <div class="highlight-box" style="top:${stepData.highlight.top}; left:${stepData.highlight.left}; width:${stepData.highlight.width}; height:${stepData.highlight.height};"></div>
        </div>`;
        
        // Build the prompt
        let promptHtml = `<div class="tutorial-prompt">${stepData.prompt}</div>`;

        imageMap.innerHTML = imageHtml;
        promptArea.innerHTML = promptHtml;
    }

    function nextStep() {
        if (currentStep < tutorialSteps.length - 1) {
            currentStep++;
            showStep(currentStep);
        } else {
            endTutorial();
        }
    }

    function prevStep() {
        if (currentStep > 2) { // Can't go back before step 2
            currentStep--;
            showStep(currentStep);
        }
    }
</script>
