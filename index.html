<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.O.C.O.M.</title>
    <link rel="icon" type="image/png" href="https://www.socom.mil/SOF-ATL/PublishingImages/eSOF-Logo.png">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @keyframes flicker { 0%, 100% { opacity: 0.95; } 50% { opacity: 1; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        :root {
            --bg-color: #050805; --scanline-color: rgba(0, 255, 85, 0.1); --text-color: #00ff55;
            --accent-color: #00ff55; --border-color: #00521d; --input-bg: rgba(0, 31, 9, 0.95);
            --danger-color: #ff4141; --danger-bg: rgba(255, 65, 65, 0.15); --container-bg: rgba(0,0,0,0.4);
        }
        body.officer-theme {
            --bg-color: #1a160d; --scanline-color: rgba(255, 196, 0, 0.1); --text-color: #ffc400;
            --accent-color: #ffc400; --border-color: #6d530e; --input-bg: rgba(43, 34, 13, 0.95);
            --container-bg: rgba(10, 8, 3, 0.4);
        }
        body.navy-theme {
            --bg-color: #0a1128; --text-color: #7bceff; --accent-color: #7bceff; 
            --border-color: #00306b; --input-bg: rgba(20, 39, 87, 0.95); --container-bg: rgba(4, 7, 15, 0.4);
        }
        body.marines-theme {
            --bg-color: #1a0b0b; --text-color: #ff5252; --accent-color: #ff5252; 
            --border-color: #6a0d0d; --input-bg: rgba(64, 13, 13, 0.95); --container-bg: rgba(10, 3, 3, 0.4);
        }
        body.airforce-theme {
            --bg-color: #1d1d1f; --text-color: #d1d1d6; --accent-color: #d1d1d6; 
            --border-color: #424245; --input-bg: rgba(50, 50, 56, 0.95); --container-bg: rgba(11, 11, 12, 0.4);
        }
        body.intelligence-theme {
            --bg-color: #000000; --text-color: #ffffff; --accent-color: #ffffff;
            --border-color: #555555; --input-bg: rgba(40, 40, 40, 0.95); --container-bg: rgba(10, 10, 10, 0.4);
        }
        body.plain-theme {
            font-family: Arial, Helvetica, sans-serif;
            --bg-color: #ffffff; --text-color: #000000; --accent-color: #005fcc;
            --border-color: #cccccc; --input-bg: #f9f9f9; --danger-color: #dc3545;
            --container-bg: rgba(248,248,248,0.8);
            text-shadow: none; animation: none;
        }
        body.plain-theme .logo { filter: none; }
        body.plain-theme h1::after { animation: none; content: ''; }
        body.plain-theme button:hover { text-shadow: none; }
        body.plain-theme::before { background: none; }
        body.plain-theme .themed-link { color: var(--accent-color); filter: none; }
        body.plain-theme #skill-tooltip { text-shadow: none; }


        body {
            font-family: 'Courier New', Courier, monospace; margin: 0; background-color: var(--bg-color); color: var(--text-color);
            text-shadow: 0 0 4px var(--accent-color); animation: flicker 0.15s infinite; overflow-y: scroll;
        }
        body::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(0deg, var(--scanline-color) 1px, transparent 1px);
            background-size: 100% 2px; z-index: 100; pointer-events: none;
        }

        .container { position: relative; max-width: 1400px; margin: 10px auto; padding: 10px; border: 1px solid var(--border-color); background: var(--container-bg); }
        .header { display: flex; align-items: center; border-bottom: 1px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 15px; }
        .logo { max-width: 80px; margin-right: 15px; filter: grayscale(100%) brightness(200%) contrast(150%); }

        h1 { font-size: 22px; text-transform: uppercase; }
        h1::after { content: '_'; animation: blink 1s step-end infinite; }
        h2 { font-size: 16px; margin-top: 10px; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; }
        h3, h3.sub-skill-header { font-size: 14px; text-transform: uppercase; border: none; margin: 0 0 5px 0; padding: 0;}

        .main-menu, .loader-menu, .content-menu { text-align: center; padding: 30px; border: 1px solid var(--border-color); margin: 20px; background: var(--input-bg); }
        .content-menu { text-align: left; }
        .content-menu p, .content-menu li { line-height: 1.6; }
        .content-menu ul { padding-left: 20px; list-style-type: none; }
        .content-menu li::before { content: "- "; }
        .themed-link {
            color: inherit;
            text-decoration: underline;
            filter: brightness(130%);
            transition: filter 0.2s;
        }
        .themed-link:hover {
            filter: brightness(160%);
        }

        button, .button {
            background: transparent; color: var(--accent-color); border: 1px solid var(--accent-color);
            padding: 8px 15px; font-size: 14px; cursor: pointer; margin: 5px;
            font-family: 'Courier New', Courier, monospace; text-transform: uppercase;
        }
        body.plain-theme button { font-family: Arial, Helvetica, sans-serif; }
        button:hover, .button:hover { background: var(--accent-color); color: var(--bg-color); text-shadow: none; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }

        .hidden { display: none !important; }

        #character-sheet-container { padding: 10px; border: 1px solid var(--border-color); }
        .form-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; align-items: start;}
        .col-1, .col-2 { display: flex; flex-direction: column; gap: 10px; }
        .col-1 .form-section:last-child { flex-grow: 1; }
        .form-section { background: var(--input-bg); padding: 10px; border: 1px solid var(--border-color); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        
        label { font-weight: bold; display: block; margin-bottom: 4px; color: var(--accent-color); font-size: 14px; }
        input, select, textarea {
            width: 100%; padding: 6px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color);
            border: 1px solid var(--border-color); font-family: 'Courier New', Courier, monospace;
        }
        body.plain-theme input, body.plain-theme select, body.plain-theme textarea { font-family: Arial, Helvetica, sans-serif; text-shadow: none; }
        textarea { resize: vertical; min-height: 50px; }

        .styled-checkbox { display: flex; align-items: center; cursor: pointer; user-select: none; }
        .styled-checkbox input[type="checkbox"] { display: none; }
        .styled-checkbox .checkbox-visual { width: 14px; height: 14px; border: 1px solid var(--accent-color); display: inline-block; position: relative; flex-shrink: 0; }
        .styled-checkbox input[type="checkbox"]:checked + .checkbox-visual::after { content: 'X'; position: absolute; top: -2px; left: 2px; color: var(--accent-color); }

        .stat-item { padding: 8px; border: 1px solid var(--border-color); }
        .stat-header { display: flex; align-items: center; gap: 8px; }
        .stat-header button { width: 22px; height: 22px; font-size: 14px; line-height: 14px; padding: 0; }
        .stat-desc { font-size: 0.9em; color: #8fbc8f; margin-top: 3px; }
        body.plain-theme .stat-desc { color: #555; text-shadow: none; }

        .derived-attr-input { display: flex; align-items: center; gap: 4px; }
        .derived-attr-input input { width: 50px; text-align: center; }

        .bond-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .remove-btn { font-size: 14px; color: var(--danger-color); cursor: pointer; background: none; border: none; padding: 0 4px; }
        
        .san-loss-container { display: flex; flex-direction: column; gap: 5px; }
        .san-loss-group { display: flex; align-items: center; justify-content: space-between; }
        .san-loss-label { display: flex; align-items: center; gap: 10px; flex-basis: 150px; }
        .san-loss-group div { display: flex; gap: 10px; }
        .adapted-status { color: var(--danger-color); font-weight: bold;}
        body:not(.plain-theme) .adapted-status { text-shadow: 0 0 5px var(--danger-color); }

        #bp-warning { padding: 10px; margin-top: 10px; border: 1px solid var(--danger-color); background-color: var(--danger-bg); color: var(--danger-color); }
        body:not(.plain-theme) #bp-warning { text-shadow: 0 0 5px var(--danger-color); }
        #bp-warning button { border-color: var(--danger-color); color: var(--danger-color); }

        #weapons-table td { padding: 4px; vertical-align: middle;}
        .input-group { display: flex; align-items: center; }
        .input-group-addon { padding: 6px; background: var(--border-color); border: 1px solid var(--border-color); border-left: none; }
        
        #saved-sheets-list li { background: var(--input-bg); padding: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        .sub-skill-group { padding: 8px; border: 1px solid var(--border-color); }
        .sub-skill-item { display: flex; align-items: center; margin-bottom: 5px; gap: 8px; }
        .skill-item-simple { display: flex; align-items: center; gap: 8px; }
        
        .skill-label-input { display: flex; align-items: center; gap: 8px; width: 100%;}
        .skill-label-input label { flex-shrink: 0; flex-basis: 120px; }
        .skill-label-input input { flex-grow: 1; }
        .sub-skill-item .skill-label-input label { flex-basis: 100px; white-space: nowrap; }

        .sub-skill-header-flex { display: flex; justify-content: space-between; align-items: center; }
        .sub-skill-header-flex button { padding: 2px 8px; font-size: 12px; margin: 0; }
        
        .settings-container { position: absolute; top: 10px; right: 10px; }
        #settings-menu { display: none; position: absolute; top: 100%; right: 0; background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px; z-index: 101; }
        #settings-menu button { display: block; width: 100%; text-align: left; }

        #skill-tooltip {
            position: absolute;
            z-index: 110;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px;
            max-width: 350px;
            font-size: 0.9em;
            line-height: 1.4;
            pointer-events: none; /* So it doesn't interfere with mouse events */
        }
        
        option:disabled { color: #666; background: #222; }
        body.plain-theme option:disabled { color: #aaaaaa; background: #eeeeee; }
        body.admin-mode .container { border-color: var(--danger-color); box-shadow: 0 0 10px var(--danger-color); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-color); border: 1px solid var(--accent-color); padding: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-controls { display: flex; gap: 20px; align-items: center; margin-bottom: 15px;}
        .preset-list { list-style: none; padding: 0; margin: 0; }
        .preset-item { border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px;}
        .preset-info { flex-grow: 1; }
        .preset-item h4 { margin: 0 0 8px 0; color: var(--accent-color); }
        .preset-item h4 .expense-tag { font-size: 0.8em; font-weight: normal; margin-left: 8px; opacity: 0.8; }
        .preset-item p { font-size: 0.9em; margin: 0 0 10px 0; line-height: 1.4; }
        .preset-item small { color: #8fbc8f; display: block; margin-top: 5px; }
        body.plain-theme .preset-item small { color: #555; }
        .preset-item button { flex-shrink: 0; }

        /* Armor-specific styles */
        .armor-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        #armor-btn {
            width: 34px;
            height: 34px;
            font-size: 16px;
            line-height: 16px;
            padding: 0;
            flex-shrink: 0;
        }
        #armor-points {
            width: 50px;
            text-align: center;
        }
        #armor-btn.armor-active {
            color: #0AF;
            border-color: #0AF;
            text-shadow: 0 0 3px #0AF, 0 0 8px #0AF;
            box-shadow: 0 0 5px #0AF;
            background: rgba(0, 170, 255, 0.1);
        }
        #armor-points.armor-active {
            color: #0AF;
            border-color: #0AF;
            text-shadow: 0 0 3px #0AF;
            background: rgba(0, 170, 255, 0.1);
        }
        #armor-preset-list .preset-item {
             cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- All HTML content will be injected by JavaScript -->
    </div>
    
    <div id="skill-tooltip" class="hidden"></div>
    
    <!-- Weapon Preset Modal -->
    <div id="weapon-preset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SELECT WEAPON</h2>
                <button onclick="closeWeaponModal()">CLOSE</button>
            </div>
            <div class="modal-controls">
                <label for="weapon-category-select">CATEGORY</label>
                <select id="weapon-category-select" onchange="populateWeaponPresets()"></select>
                <button onclick="addWeapon(null, true)">+ ADD CUSTOM</button>
            </div>
            <hr style="border-color: var(--border-color); margin: 15px 0;">
            <ul id="weapon-preset-list" class="preset-list">
                <!-- Preset items will be injected here by JS -->
            </ul>
        </div>
    </div>
    
    <!-- Armor Modal -->
    <div id="armor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SELECT ARMOR</h2>
                <button onclick="closeArmorModal()">CLOSE</button>
            </div>
            <div class="modal-controls">
                <label class="styled-checkbox">
                    <input type="checkbox" id="helmet-checkbox">
                    <span class="checkbox-visual"></span> ADD HELMET (+1 AP)
                </label>
            </div>
            <hr style="border-color: var(--border-color); margin: 15px 0;">
            <ul id="armor-preset-list" class="preset-list">
                <!-- Armor presets will be injected here by JS -->
            </ul>
        </div>
    </div>

    <!-- Skill Improvement Modal -->
    <div id="skill-roll-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div id="skill-roll-prompt">
                <h2 style="margin-bottom: 20px;">IMPROVE SKILLS?</h2>
                <p style="margin-bottom: 25px;">This should only be done after completing a session. This action is final. Are you sure you want to roll 1d4 for all checked skills?</p>
                <button onclick="executeSkillRolls()">CONFIRM</button>
                <button onclick="closeSkillRollModal()">CANCEL</button>
            </div>
            <div id="skill-roll-process" class="hidden">
                <h3 id="rolling-skill-name" style="margin-bottom: 20px; font-size: 1.2em;"></h3>
                <div id="dice-animation" style="font-size: 4em; font-weight: bold; margin-bottom: 25px; min-height: 60px;">-</div>
                <p id="roll-result-text"></p>
            </div>
            <div id="skill-roll-conclusion" class="hidden">
                <h2 style="margin-bottom: 20px;">CONCLUDED</h2>
                <button onclick="closeSkillRollModal()">CLOSE</button>
            </div>
        </div>
    </div>

<script>
    // --- DISABLE ENTER KEY ---
    window.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });

    // --- INJECT ALL HTML ---
    document.querySelector('.container').innerHTML = `
        <header class="header"> <img src="https://images.squarespace-cdn.com/content/v1/629e0596d168b365d297c6c4/cea70b06-895e-401c-9669-04fa59cfc5e6/socom-logo.png" alt="SOCOM Logo" class="logo"> <h1>S.O.C.O.M. // AGENT ROSTER</h1> </header>
        <div class="settings-container"> <button id="settings-btn">⚙</button> <div id="settings-menu"> <button onclick="changeTheme('default')">Army (Green)</button> <button onclick="changeTheme('navy')">Navy (Blue)</button> <button onclick="changeTheme('marines')">Marines (Red)</button> <button onclick="changeTheme('airforce')">Air Force (Gray)</button> <button onclick="changeTheme('intelligence')">CIA/NSA (B&W)</button> <button onclick="changeTheme('officer')">Command (Gold)</button> <button onclick="changeTheme('plain')">Plain Mode</button><button id="admin-login-btn" onclick="toggleAdminMode()">Admin Login</button> </div> </div>
        
        <main id="main-view">
            <div class="main-menu">
                <h2>SYSTEM ACCESS</h2>
                
                <div id="daily-briefing" style="margin-bottom: 20px; border: 1px solid var(--border-color); padding: 10px; text-align: left; font-size: 0.9em;">
                    <h3 id="history-title" style="border: none; margin: 0 0 10px 0;">THIS DAY IN HISTORY // SYSTEM DATE</h3>
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <p id="history-content" style="margin: 0; line-height: 1.4; flex: 1;">...LOADING HISTORICAL DATA...</p>
                        <img id="history-image" src="" alt="Historical event" style="width: 220px; max-height: 160px; height: auto; border: 1px solid var(--border-color); object-fit: cover; display: none;">
                    </div>
                </div>

                <button onclick="resetForm(); showView('character-sheet'); ">> CREATE NEW AGENT FILE</button>
                <button onclick="showView('loader')">> LOAD AGENT FILE</button>
                <button onclick="showView('rules')">> RULES</button>
                <button onclick="showView('about')">> ABOUT SOCOM</button>
            </div>
        </main>
        
        <main id="loader-view" class="hidden"> <div class="loader-menu"> <h2>LOAD AGENT</h2> <input type="file" id="json-file-input" accept=".json" onchange="loadCharacterFromFile(event)" class="button"> <h3>LOCAL SAVES</h3> <ul id="saved-sheets-list"></ul> <button onclick="showView('main')">> RETURN</button> </div> </main>
        <main id="character-sheet-view" class="hidden"> <div id="character-sheet-container"> <button onclick="saveCharacter()">SAVE</button><button onclick="screenshotPage(event)">SCREENSHOT</button><button onclick="exportToJson()">EXPORT TO .JSON</button><label id="lock-branch-rank-container" class="styled-checkbox hidden" style="margin-left: 15px;"><input type="checkbox" id="lock-branch-rank-checkbox"><span class="checkbox-visual"></span> LOCK BRANCH/RANK</label> <button onclick="showView('main')">RETURN TO MENU</button> <form id="sheet-form" onsubmit="return false;"></form> </div> </main>
        <main id="rules-view" class="hidden"> 
            <div class="content-menu"> 
                <h2 style="text-align: center;">RULES OF ENGAGEMENT</h2>
                <h2>Be Civil, Be Respectful.</h2> <p>SOCOM is intended to be a dark and intense game, but we're all here to have fun. Horror is in-character and respect is out-of-character. Don't make it personal and don't take things to the heart.</p>
                <h2>About PvP.</h2> <p>Tension between characters happens - distrust, paranoia, and conflicting agendas are part of the setting. But player consent is key before betrayal, sabotage, or character-on-character violence. NEMESIS will not tolerate out-of-character grudges; keep the drama in the game.</p>
                <h2>Communication and Versimilitude.</h2> <p>If you're unsure about something, ask - NEMESIS will always answer. Work with the other players to build suspense and tension and keep the setting immersive. Paranoia is more fun with friends.</p>
                <h2>Death (and Worse) is Part of the Game.</h2> <p>Your character is not a hero, and they are not safe. SOCOM is about failure, creeping dread, and moral collapse with the occasional success. Expect your character to die, disappear, go insane, or worse. When that happens, we'll work together to bring in a new agent.</p>
                <h2>No Metagaming, No Powergaming</h2> <p>Metagaming (using OOC knowledge IC) ruins the experience - act on what your character knows, not what you do. Powergaming (forcing actions on others or breaking realism) doesn't fit this setting. Be prepared for failures and bad choices.</p>
                <h2>Trust NEMESIS, but Question Everything</h2> <p>NEMESIS is not your enemy, but will make your character suffer. If something seems off in the story, that's probably intentional. Keep your eyes open. Assume you're being lied to. And remember that no one is coming to save you.</p>
                <h2 style="text-align: center; font-size: 1.1em;">CONTENT WARNINGS</h2>
                <p>SOCOM Operations will often contain multiple of the contents detailed below:</p>
                <ul> <li>Violence, Gore and Death</li> <li>Torture and Enhanced Interrogation</li> <li>Psychological Horror and Trauma</li> <li>Body Horror</li> <li>Substance Abuse</li> </ul>
                <p>No explicit sexual content is included in SOCOM, although it can be implied/mentioned.</p>
                <div style="text-align: center; margin-top: 30px;"> <button onclick="showView('main')">> RETURN TO MENU</button> </div>
            </div> 
        </main>
        <main id="about-view" class="hidden"> 
            <div class="content-menu">
                <h2 style="text-align: center; margin-bottom: 20px;">ABOUT SOCOM</h2>
                <p>SOCOM is a serialized, operation-based TTRPG using a slightly modified <a href="https://www.deltagreen.com" target="_blank" rel="noopener noreferrer" class="themed-link">Delta Green</a> system set from the 1990s through the 2010s, with most missions unfolding in a post-9/11 world. As America wages covert wars across the globe and at home, a clandestine task force known as N.E.M.E.S.I.S., comprised of elite operatives from the CIA, NSA, and the U.S. military, carries out black ops in the name of national security.</p>
                <p>Players assume the roles of N.E.M.E.S.I.S. agents: psyops, field tacticians, analysts, and infiltrators tasked with counterterrorism, espionage, information warfare, and the moral rot that comes with them.</p>
                <p style="margin-top: 25px;"><em>Inspired by Metal Gear Solid, Call of Duty, Splinter Cell and The Hunt for Red October.</em></p>
                <p style="font-size: 1.2em; text-align: center; font-style: italic; margin-top: 40px; margin-bottom: 20px;"> <a href="https://discord.gg/g8DgxusP9u" target="_blank" rel="noopener noreferrer" class="themed-link">/De Opresso Liber/</a> </p>
                <div style="text-align: center; margin-bottom: 40px;"> <a href="https://www.socom.mil/" target="_blank" rel="noopener noreferrer"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/SpecialForces_Badge.svg/1200px-SpecialForces_Badge.svg.png" alt="Green Berets Logo" class="logo" style="height: 70px; margin-right: 0;"> </a> </div>
                <div style="text-align: center;"> <button onclick="showView('main')">> RETURN TO MENU</button> </div>
            </div>
        </main>
    `;

    document.getElementById('sheet-form').innerHTML = `
        <input type="hidden" id="character-id">
        <section class="form-section"> <h2>IDENTIFICATION</h2> <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr"> <div><label for="full-name">FULL NAME</label><input type="text" id="full-name"></div> <div><label for="branch">BRANCH</label><select id="branch" onchange="updateRanks()"></select></div> <div><label for="rank">RANK/GRADE</label><select id="rank" onchange="applyAutoTheme()"></select></div> <div><label for="team">TEAM</label><select id="team"><option>SOCOM 1</option><option>SOCOM 2</option><option>SOCOM 3</option><option>SOCOM 4</option><option>SOCOM 5</option><option>SOCOM 6</option></select></div> <div><label for="sex">SEX</label><select id="sex"><option>M</option><option>F</option><option>NA</option></select></div> <div><label for="dob">D.O.B.</label><input type="date" id="dob"></div> <div><label for="nationality">NATIONALITY</label><input type="text" id="nationality"></div> <div><label for="employer">EMPLOYER</label><input type="text" id="employer"></div> <div><label for="education">EDUCATION</label><input type="text" id="education"></div> </div> </section>
        <div class="form-grid"> <div class="col-1"> <section class="form-section"> <div style="display: flex; justify-content: space-between; align-items: center;"><h2>CORE ATTRIBUTES (<span id="stat-points-remaining">25</span> PTS)</h2><button type="button" id="toggle-stats-lock-btn" onclick="toggleStatsLock()" class="hidden">FORCE STATS</button></div> <div id="stats-container" style="display: flex; flex-direction: column; gap: 8px;"></div> </section> <section class="form-section"> <h2>DERIVED ATTRIBUTES</h2> <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr;"> <div><label>HIT POINTS (HP)</label><div class="derived-attr-input"><input type="number" id="hp-current" min="0"> / <input type="number" id="hp-max" value="0" readonly></div></div> <div><label>ARMOR (AP)</label><div class="derived-attr-input armor-controls"><button type="button" id="armor-btn" onclick="toggleArmor()">△</button><input type="number" id="armor-points" class="hidden" min="0" oninput="validateArmorPoints(event)"></div></div> <div><label>WILLPOWER (WP)</label><div class="derived-attr-input"><input type="number" id="wp-current" min="0"> / <input type="number" id="wp-max" value="0" readonly></div></div> <div><label>SANITY (SAN)</label><div class="derived-attr-input"><input type="number" id="san-current" min="0" oninput="checkBreakingPoint()"> / <input type="number" id="san-max" value="0" readonly></div></div> <div><label>BREAKING PT</label><input type="number" id="bp" readonly></div> </div> <div id="bp-warning" class="hidden"> SAN is at or below Breaking Point! Agent must acquire a new disorder. <button type="button" onclick="acknowledgeBreakingPoint()">ACK & RESET BP</button> </div> </section> <section class="form-section"> <div class="bonds-header" style="display: flex; justify-content: space-between; align-items: center;"> <h2>BONDS (<span id="bond-cha-note"></span>)</h2> <button type="button" onclick="addBond()">+ ADD</button> </div> <div id="bonds-container"></div> </section> <section class="form-section"> <h2 style="text-align: center; border:none; margin-bottom: 5px;">PSYCH PROFILE</h2> <div class="san-loss-container"> <div class="san-loss-group"> <div class="san-loss-label"> <label>VIOLENCE</label><span id="violence-adapted" class="adapted-status hidden">ADAPTED</span> </div> <div> <label class="styled-checkbox"><input type="checkbox" id="violence1" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="violence2" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="violence3" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> </div> </div> <div class="san-loss-group"> <div class="san-loss-label"> <label>HELPLESSNESS</label><span id="helplessness-adapted" class="adapted-status hidden">ADAPTED</span> </div> <div> <label class="styled-checkbox"><input type="checkbox" id="helplessness1" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="helplessness2" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="helplessness3" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> </div> </div> </div> </section> </div> <div class="col-2"> <section class="form-section" style="flex-grow: 1; display: flex; flex-direction: column;"> <div style="display: flex; justify-content: space-between; align-items: center;"><h2 style="border-bottom: none;">SKILLS</h2><button type="button" id="roll-skills-btn" class="hidden" onclick="startSkillImprovement()">Roll 1d4s</button></div> <div id="skills-container" style="display: flex; flex-direction: column; gap: 10px; flex-grow: 1;"></div> </section> </div> </div>
        <section class="form-section"> <h2>WEAPONS & EQUIPMENT</h2> <label for="gear">ARMOR AND GEAR</label> <textarea id="gear"></textarea> <label for="notes-field" style="margin-top:10px;">NOTES</label> <textarea id="notes-field"></textarea> <h3 style="margin-top: 15px;">WEAPONS</h3> <table id="weapons-table" style="width:100%; border-collapse: collapse;"> <thead> <tr><th>NAME</th><th>SKILL%</th><th>RANGE</th><th>DMG</th><th>AP</th><th>LETHALITY</th><th>AMMO</th><th></th></tr> </thead> <tbody id="weapons-body"></tbody> </table> <button type="button" onclick="openWeaponModal()">+ ADD WEAPON</button> </section>
    `;

    // --- CONFIG ---
    const ADMIN_PASSWORD_HASH = 'dmFsa3lyaWU=';
    let isAdmin = false;
    let statsUnlocked = false;
    let isArmorActive = false;
    let currentArmorPoints = 0;
    const MAX_STAT_POINTS = 25, MIN_STAT_VALUE = 8, MAX_STAT_VALUE = 18;
    const branches = { "NSA": "intelligence", "CIA": "intelligence", "Army": "army", "Navy": "navy", "Marines": "marines", "Air Force": "airforce" };
    const ranks = { intelligence: [ {name: "Case Officer", grade: "GS-11"}, {name: "Supervisory CO", grade: "GS-14", adminOnly: true}, {name: "Chief of Station", grade: "SIS-2", adminOnly: true} ], army: [ {name: "Sergeant", grade: "E-5"}, {name: "Staff Sergeant", grade: "E-6"}, {name: "Sergeant First Class", grade: "E-7"}, {name: "Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ], marines: [ {name: "Sergeant", grade: "E-5"}, {name: "Staff Sergeant", grade: "E-6"}, {name: "Gunnery Sergeant", grade: "E-7"}, {name: "Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ], navy: [ {name: "Petty Officer 2nd Class", grade: "E-5"}, {name: "Petty Officer 1st Class", grade: "E-6"}, {name: "Chief Petty Officer", grade: "E-7"}, {name: "Senior Chief Petty Officer", grade: "E-8", adminOnly: true}, {name: "Ensign", grade: "O-1", adminOnly: true}, {name: "Lieutenant (JG)", grade: "O-2", adminOnly: true}, {name: "Lieutenant", grade: "O-3", adminOnly: true} ], airforce: [ {name: "Staff Sergeant", grade: "E-5"}, {name: "Technical Sergeant", grade: "E-6"}, {name: "Master Sergeant", grade: "E-7"}, {name: "Senior Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ] };
    const stats = ["STR", "DEX", "CON", "INT", "POW", "CHA"];
    const simpleSkills = [ "Accounting", "Alertness", "Artillery", "Athletics", "Criminology", "Disguise", "Dodge", "Drive", "Firearms", "First Aid", "Forensics", "Heavy Machinery", "Heavy Weapons", "Human Studies", "HUMINT", "Leadership", "Medicine", "Melee Weapons", "Navigate", "Paranormal", "Persuade", "Pharmacy", "Psychotherapy", "Ride", "Search", "SIGINT", "Stealth", "Support Int.", "Surgery", "Survival", "Swim", "Tech Procedures", "Unarmed Combat" ].sort();
    const baseSkillValues = { 'Accounting': 10, 'Alertness': 20, 'Athletics': 30, 'Disguise': 10, 'Dodge': 30, 'Drive': 20, 'Firearms': 20, 'First Aid': 10, 'Heavy Machinery': 10, 'Heavy Weapons': 10, 'Human Studies': 10, 'Melee Weapons': 30, 'Navigate': 10, 'Paranormal': 10, 'Persuade': 20, 'Psychotherapy': 10, 'Ride': 10, 'Search': 20, 'Stealth': 20, 'Survival': 10, 'Swim': 20, 'Tech Procedures': 20, 'Unarmed Combat': 40 };
    const statDescriptions = { STR: { 3: "Frail", 6: "Below Average", 9: "Average", 12: "Strong", 15: "Powerful", 18: "Peak Human" }, DEX: { 3: "Clumsy", 6: "Slow", 9: "Average", 12: "Agile", 15: "Nimble", 18: "Lightning Reflexes" }, CON: { 3: "Sickly", 6: "Frail", 9: "Average", 12: "Hardy", 15: "Tough", 18: "Superhuman Endurance" }, INT: { 3: "Dim", 6: "Slow Learner", 9: "Average", 12: "Sharp", 15: "Brilliant", 18: "Genius" }, POW: { 3: "Weak-willed", 6: "Hesitant", 9: "Average", 12: "Determined", 15: "Indomitable", 18: "Unyielding Will" }, CHA: { 3: "Unlikable", 6: "Awkward", 9: "Average", 12: "Likable", 15: "Charismatic", 18: "Compelling Presence" } };
    
    const skillDescriptions = {
        'Accounting': 'The study of finance and business. Use it to sift through financial records for anomalies, such as a hidden bank account or money laundering.', 'Alertness': 'Alertness detects danger. Use it to hear a safety being switched off, to understand the mumbling on the other side of a wall, to spot the bulge of a pistol hidden under a jacket, or to catch someone who is trying to escape notice using Stealth.', 'Artillery': 'Safe and accurate use of mortars, missiles, howitzers, tank cannons, and other heavy gunnery. Use it to destroy troops or a hard target in battle.', 'Athletics': 'Represents long practice doing things like running, jumping, climbing, and throwing. Use Athletics to outrun someone, jump a gap, climb in a crisis, land safely in a fall, hit a target with a thrown knife, or catch something without warning.', 'Craft': 'Making and repairing sophisticated tools and structures. A job that most people could figure out does not require the Craft skill, only an INT or DEX test.', 'Criminology': 'Knowledge of criminal and conspiratorial behavior. Use it to identify and predict criminal behavior, deduce relationships between members of a conspiracy, analyze criminal activity, examine witness statements, or know whom to talk to in the criminal underground.', 'Disguise': 'Alter your Agent’s appearance, voice, posture, body language, and mannerisms to avoid recognition without drawing attention.', 'Dodge': 'Evading danger through instinct and reflexes. Use Dodge to avoid an attack. Against firearms and explosives, Dodge is only useful to get to cover.', 'Drive': 'Handling an automobile or a motorcycle safely in a crisis. Every Agent can drive a car in normal conditions. Use this skill to keep a vehicle safe in a high-speed pursuit or on dangerous terrain.', 'Firearms': 'Safe and accurate shooting with weaponry in combat. Use it to hit a target despite the adrenaline, panic, and shock of violence interfering with hand-eye coordination.', 'First Aid': 'The initial treatment and stabilization of of injuries. Use it to help a character recover lost Hit Points. By comparison, Surgery corrects a severe wound and Medicine ensures long-term recovery.', 'Forensics': 'Gathering detailed information and evidence using forensic equipment. Use it to record biometric data, determine details about a weapon used, discern crucial clues, clean a scene of incriminating evidence, or collect, analyze, and compare fingerprints and DNA samples.', 'HUMINT': 'Human intelligence. Obtains information about a subject through observation, conversation, or examining patterns of behavior and relationships. Use HUMINT to recognize signs of dishonesty, gauge attitude, cultivate sources, or determine what it would take to get a subject to cooperate.', 'Heavy Machinery': 'Safe operation of a tractor, crane, bulldozer, tank, heavy truck, or other big machine in a crisis.', 'Heavy Weapons': 'Safe and accurate use of man-portable heavy ordnance such as machine guns and rocket launchers. Use Heavy Weapons to suppress enemies, or destroy a vehicle in combat.', 'Human Studies': 'Interdisciplinary skill combining art, archaeology, anthropology, history, and geography. Use this skill to investigate ancient artifacts, study lost civilizations, analyze societal structures, decipher historical texts, or map out the geography of a region.', 'Medicine': 'The study and treatment of injury and illness. Use it to diagnose the cause of an injury, disease, or poisoning, identify abnormalities, determine cause of death, or prescribe proper long-term care.', 'Leadership': 'The ability to inspire, guide, and coordinate people, especially in high-pressure situations. Use this skill to organize complex operations, provide clear commands under stress, motivate allies, and keep the team focused on objectives.', 'Melee Weapons': 'Lethal use of melee weapons in combat. Use it to hurt or kill an opponent with a knife, axe, club, or other weapon.', 'Military Science': 'Knowledge of military culture, techniques, and regulations. Use it to identify threats, find ranges, recognize weaknesses in a fortification, deduce training level of a unit, reconstruct a battle, or deploy forces advantageously. Types are Land, Air, and Sea.', 'Navigate': 'Finding your way quickly with maps, charts and tables, orienteering, instruments, or dead reckoning.', 'Paranormal': 'The understanding and investigation of supernatural phenomena, including occult practices, unexplained events, and unnatural entities. Use this skill to decipher occult rituals, track and identify otherworldly threats, or understand the motives of paranormal entities.', 'Persuade': 'Changing another’s deeply-held decision or desire. Use Persuade to get your way when the subject is stubborn or the deception is flagrant. This skill also allows your Agent to resist persuasion and interrogation.', 'Pharmacy': 'Knowledge of drugs, from their ingredients and creation, to their effects, uses, and misuses. Use it to identify and produce medicines and antidotes—as well as poisons. Misusing Pharmacy is a quick way to kill a patient.', 'Pilot': 'Piloting, navigating, and captaining waterborne or airborne vehicles. Use it to keep a vessel safe in a crisis, such as through a storm or in a dangerous pursuit. Each vessel type is a separate skill.', 'Psychotherapy': 'The diagnosis and treatment of mental illness. Use it to identify a mental disorder, help a patient recover, and treat mental illness in the long term. You cannot use Psychotherapy on yourself.', 'Ride': 'Handling, training, and riding an animal—horses, donkeys, camels, whatever. Use it to keep safe on an animal in a crisis and to keep riding animals safe, calm, and healthy.', 'SIGINT': 'Signals intelligence. It encompasses encryption, communications intelligence, electronic intelligence, computer science, surveillance of radio and digital communications, and the making and breaking of codes.', 'Search': 'Finding things that are concealed or obscured from plain sight. Use Search to find an object that was hidden with the Stealth skill, or is otherwise so well hidden or disguised that it needs an expert.', 'Science': 'The deep study of the processes of the world. Science is used to find a key insight about the way the universe works—or at least, the way it’s supposed to work.', 'Stealth': 'Concealing your presence or activities. Use it to hide a pistol, camouflage a position, conceal a microphone, pick a pocket, move silently, or follow without being seen. An Agent attempting Stealth can be detected only by an opposing Alertness or Search skill.', 'Surgery': 'The treatment of an injury or abnormality by invasive means. By comparison, First Aid keeps a patient alive until surgery is possible and Medicine ensures longterm recovery.', 'Support Int.': 'The ability to coordinate and direct external resources, such as air support, medical evacuations, or artillery fire, while under duress. Use this skill to effectively integrate support assets into operations while managing the pressure of a hostile environment.', 'Survival': 'Knowledge of the natural world. Use it to find tracks and trails, plan an expedition, predict weather, recognize when fauna or flora are unusual, or find food, water, and shelter.', 'Swim': 'Most Agents can swim for leisure. Use the Swim skill in a dangerous crisis: going a long distance in choppy water, keeping a friend from drowning, or similar situations.', 'Tech Procedures': 'The knowledge of laws, bureaucratic processes, and regulations that govern actions in operational contexts, particularly those involving command structures, military protocols, and local legal systems. Use this skill to navigate complex rules of engagement (ROE), make equipment requistions, and navigate the command chain.', 'Unarmed Combat': 'Use Unarmed Combat to hurt or kill an opponent with your Agent’s bare hands (or feet, elbows, teeth, or head).'
    };

    const weaponPresets = {
        "Melee Weapons": [
            { name: "Unarmed", expense: "N/A", skillIdentifier: "Unarmed Combat", range: 1, dmg: "1D4-1", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "Basic hand-to-hand strikes with fists, kicks, and elbows. Damage can be improved with training.", examples: "e.g., Boxing, Karate, Krav Maga." },
            { name: "Brass Knuckles/Steel-toe boots", expense: "Incidental", skillIdentifier: "Unarmed Combat", range: 1, dmg: "1D4", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A simple, concealable force-multiplier for unarmed strikes, or using a heavy, blunt object.", examples: "e.g., Weighted gloves, heavy flashlight." },
            { name: "Garotte", expense: "Incidental", skillIdentifier: "Unarmed Combat", range: 1, dmg: "Special", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A wire or cord for silent strangulation. Works only from surprise. On success, target is pinned and silenced, taking 1D6 damage per round until escape. Kevlar cord can cut flex-cuffs.", examples: "e.g., Piano wire, kevlar cord." },
            { name: "Knife", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D4", ap: "3", lethality: "", ammoC: "", ammoM: "", desc: "A small, single-edged blade. Common and easily concealable.", examples: "e.g., Pocket knife, boot knife." },
            { name: "Hatchet", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D4", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A small, short-handled axe for chopping, utility, or combat.", examples: "e.g., Camping hatchet, survival tomahawk." },
            { name: "Large knife/Combat dagger", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D6", ap: "3", lethality: "", ammoC: "", ammoM: "", desc: "A dedicated combat knife with a larger, often double-edged blade for increased lethality.", examples: "e.g., Ka-Bar, Fairbairn-Sykes dagger." },
            { name: "Club/Baton", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D6", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A blunt instrument designed for subduing targets through impact.", examples: "e.g., Police nightstick, collapsible ASP baton." },
            { name: "Machete/Tomahawk/Sword", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D8", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A large, heavy blade or axe designed for clearing brush or as a formidable weapon.", examples: "e.g., Kukri, Latin machete, Gladius." },
            { name: "Baseball bat/Rifle butt", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D8", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A heavy club for sport or improvised combat. A rifle can be used as a club in melee.", examples: "e.g., Louisville Slugger, rifle stock strike." },
            { name: "Spear/Fixed bayonet", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D8", ap: "3", lethality: "", ammoC: "", ammoM: "", desc: "A pole weapon with a pointed tip, effective at keeping enemies at a distance or for thrusting attacks.", examples: "e.g., Improvised spear, M9 bayonet." },
            { name: "Wood axe", expense: "Incidental", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D10", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A heavy, typically two-handed axe for felling trees, breaching doors, or causing massive trauma.", examples: "e.g., Felling axe, fire axe." },
            { name: "Large sword", expense: "Standard", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D10", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A one-handed sword, requiring training but highly effective for cutting and thrusting in combat.", examples: "e.g., Arming sword, Katana." },
            { name: "Two-handed sword", expense: "Standard", skillIdentifier: "Melee Weapons", range: 1, dmg: "1D12", ap: "", lethality: "", ammoC: "", ammoM: "", desc: "A massive blade requiring two hands, delivering devastating blows with superior reach.", examples: "e.g., Zweihänder, Claymore." }
        ],
        "Firearms": [
            { name: "Light Pistol", expense: "Standard", skillIdentifier: "Firearms", range: 10, dmg: "1D8", ap: "", lethality: "", ammoC: 7, ammoM: 7, desc: "Small-caliber sidearms, easily concealable but lacking stopping power.", examples: "e.g., Ruger SR22, Walther PPK, Colt Detective Special" },
            { name: "Medium Pistol", expense: "Standard", skillIdentifier: "Firearms", range: 15, dmg: "1D10", ap: "", lethality: "", ammoC: 15, ammoM: 15, desc: "Standard-issue service pistols, balancing magazine capacity and effectiveness.", examples: "e.g., Glock 19, SIG Sauer P226, Beretta M9" },
            { name: "Heavy Pistol", expense: "Standard", skillIdentifier: "Firearms", range: 20, dmg: "1D12", ap: "", lethality: "", ammoC: 8, ammoM: 8, desc: "Large-caliber handguns and revolvers known for their immense stopping power.", examples: "e.g., Desert Eagle .50 AE, S&W Model 29, Colt Python" },
            { name: "Shotgun (Nonlethal)", expense: "Standard", skillIdentifier: "Firearms", range: 10, dmg: "Stunned", ap: "", lethality: "", ammoC: 5, ammoM: 5, desc: "Fires beanbag rounds or rubber slugs designed to incapacitate targets without lethal force.", examples: "e.g., Rounds for Mossberg 500, Remington 870" },
            { name: "Shotgun (Shot)", expense: "Standard", skillIdentifier: "Firearms", range: 50, dmg: "2D10", ap: "", lethality: "", ammoC: 5, ammoM: 5, desc: "Fires a spread of pellets, devastating at close range.", examples: "e.g., Mossberg 500, Remington 870, Benelli M4" },
            { name: "Shotgun (Slug)", expense: "Standard", skillIdentifier: "Firearms", range: 75, dmg: "2D8", ap: "", lethality: "", ammoC: 5, ammoM: 5, desc: "Fires a single, solid projectile for greater range and accuracy.", examples: "e.g., Rounds for Mossberg 500, Remington 870" },
            { name: "Submachine Gun", expense: "Unusual", skillIdentifier: "Firearms", range: 50, dmg: "1D10", ap: "", lethality: "10", ammoC: 30, ammoM: 30, desc: "Compact, automatic weapons ideal for close-quarters combat. RESTRICTED.", examples: "e.g., H&K MP5, FN P90, IMI Uzi" },
            { name: "Light Rifle/Carbine", expense: "Unusual", skillIdentifier: "Firearms", range: 100, dmg: "1D12", ap: "3", lethality: "10", ammoC: 30, ammoM: 30, desc: "Standard military assault rifles, versatile for most combat scenarios. RESTRICTED.", examples: "e.g., M4A1, AK-74, Steyr AUG, SIG MCX" },
            { name: "Heavy Rifle", expense: "Unusual", skillIdentifier: "Firearms", range: 150, dmg: "1D12+2", ap: "5", lethality: "10", ammoC: 20, ammoM: 20, desc: "Battle rifles firing full-power cartridges for superior range and penetration. RESTRICTED.", examples: "e.g., FN FAL, H&K G3, M14, Dragunov SVD" },
            { name: "Very Heavy Rifle", expense: "Major", skillIdentifier: "Firearms", range: 250, dmg: "", ap: "", lethality: "20", ammoC: 10, ammoM: 10, desc: "High-caliber sniper and anti-materiel rifles for extreme long-range engagements. RESTRICTED.", examples: "e.g., Barrett M82A1, McMillan TAC-50, CheyTac M200" }
        ],
         "Heavy Weapons": [
            { name: "Hand grenade", expense: "Incidental", skillIdentifier: "Athletics+20", range: 20, dmg: "", ap: "", lethality: "15", ammoC: 1, ammoM: 1, desc: "Thrown explosive with a timed fuse. Kill Radius: 10m. RESTRICTED.", examples: "e.g., M67 Fragmentation, RGO Impact." },
            { name: "Handheld flamethrower", expense: "Unusual", skillIdentifier: "Heavy Weapons", range: 5, dmg: "10% Lethality", ap: "", lethality: "10", ammoC: 20, ammoM: 20, desc: "A portable incendiary device that projects a stream of fire. Kill Radius: 1m.", examples: "e.g., Ion XM42." },
            { name: "Military flamethrower", expense: "Unusual", skillIdentifier: "Heavy Weapons", range: 10, dmg: "10% Lethality", ap: "", lethality: "10", ammoC: 5, ammoM: 5, desc: "A backpack-fed incendiary weapon with greater range and fuel capacity. Kill Radius: 2m. RESTRICTED.", examples: "e.g., AEC M9A1-7." },
            { name: "Light machine gun (LMG)", expense: "Major", skillIdentifier: "Heavy Weapons", range: 200, dmg: "1D12", ap: "3", lethality: "10", ammoC: 100, ammoM: 200, desc: "An automatic rifle designed for sustained suppressive fire at the squad level. Kill Radius: Burst Length. RESTRICTED.", examples: "e.g., FN MINIMI (M249 SAW), Molot RPK." },
            { name: "General-purpose machine gun (GPMG)", expense: "Major", skillIdentifier: "Heavy Weapons", range: 300, dmg: "1D12+2", ap: "3", lethality: "15", ammoC: 100, ammoM: 100, desc: "A medium machine gun, effective in both offensive and defensive roles. Kill Radius: Burst Length. RESTRICTED.", examples: "e.g., FN MAG (M240), Kovrov PKM, Saco M60." },
            { name: "Minigun", expense: "Extreme", skillIdentifier: "Heavy Weapons", range: 300, dmg: "1D12+2", ap: "5", lethality: "20", ammoC: 4000, ammoM: 4000, desc: "An electrically-driven, multi-barrel rotary machine gun with an extremely high rate of fire. Kill Radius: Long spray. RESTRICTED.", examples: "e.g., Dillon GAU-17/A, GE M134, KBP GShG-7.62." },
            { name: "Heavy machine gun (HMG)", expense: "Major", skillIdentifier: "Heavy Weapons", range: 400, dmg: "", ap: "5", lethality: "20", ammoC: 100, ammoM: 100, desc: "A large-caliber machine gun, typically mounted, effective against infantry and light vehicles. Kill Radius: Burst Length. RESTRICTED.", examples: "e.g., Browning M2HB, Degtyaryov DShKM, Kovrov NSV." },
            { name: "Autocannon", expense: "Extreme", skillIdentifier: "Heavy Weapons", range: 400, dmg: "", ap: "5", lethality: "30", ammoC: 100, ammoM: 100, desc: "A large-caliber automatic gun firing explosive shells, too large for a single person to operate. Kill Radius: 3m. RESTRICTED.", examples: "e.g., M242 Bushmaster." },
            { name: "Grenade launcher (GL)", expense: "Major", skillIdentifier: "Heavy Weapons", range: 150, dmg: "", ap: "", lethality: "15", ammoC: 1, ammoM: 6, desc: "A single-shot weapon that fires explosive grenades further than they can be thrown. Revolver capacity: 6. Kill Radius: 10m. RESTRICTED.", examples: "e.g., Colt M203, H&K M320, Milkor M32, Springfield M79." },
            { name: "Grenade machine gun (GMG)", expense: "Major", skillIdentifier: "Heavy Weapons", range: 300, dmg: "", ap: "", lethality: "15", ammoC: 30, ammoM: 30, desc: "An automatic, belt-fed grenade launcher for sustained fire support. *If firing a burst (5 grenades), Lethality is 20%. Kill Radius: 10m. RESTRICTED.", examples: "e.g., H&K GMG, Saco MK 19 MOD 3, KBP AGS-17." },
            { name: "Rocket-propelled grenade launcher (RPG)", expense: "Standard", skillIdentifier: "Heavy Weapons", range: 200, dmg: "", ap: "20", lethality: "30", ammoC: 1, ammoM: 1, desc: "A shoulder-fired anti-tank weapon that launches a rocket with an explosive warhead. Kill Radius: 10m. RESTRICTED.", examples: "e.g., ATK M72 LAW, Bazalt RPG-7V, Bofors AT4 (M136)." }
        ],
        "Electro-Shock": [
            { name: "Stun Gun", expense: "Incidental", skillIdentifier: "DEX*5", range: 1, dmg: "Penalty -20%", ap: "", lethality: "", ammoC: 1, ammoM: 1, desc: "A close-range electroshock weapon designed to incapacitate through pain compliance.", examples: "e.g., TASER Pulse, VIPERTEK VTS-989." },
            { name: "Shock Baton", expense: "Incidental", skillIdentifier: "DEX*5", range: 1, dmg: "Penalty -20%", ap: "", lethality: "", ammoC: 4, ammoM: 4, desc: "A melee-range electroshock weapon for crowd control or subduing resistant targets.", examples: "e.g., Maglite Stun Gun Baton, Police-grade stun baton." },
            { name: "CED Pistol", expense: "Standard", skillIdentifier: "Firearms", range: 4, dmg: "Penalty -20%", ap: "", lethality: "", ammoC: 1, ammoM: 1, desc: "A ranged electroshock weapon that fires wired projectiles to immobilize a target from a distance.", examples: "e.g., TASER X26, Axon TASER 7." }
        ],
        "Grenades & Chemical": [
            { name: "Flash Grenade (Thrown)", expense: "Incidental", skillIdentifier: "Athletics+20", range: 10, dmg: "Penalty -40%", ap: "", lethality: "", ammoC: 1, ammoM: 1, desc: "Non-lethal explosive device that produces a blinding flash and deafening bang to disorient targets.", examples: "e.g., M84 Stun Grenade." },
            { name: "Flash Grenade (Launched)", expense: "Incidental", skillIdentifier: "Heavy Weapons", range: 50, dmg: "Penalty -40%", ap: "", lethality: "", ammoC: 1, ammoM: 1, desc: "Grenade launcher variant of the flash grenade for greater range.", examples: "e.g., 40mm Stun/Flash Cartridge." },
            { name: "Pepper Spray Keychain", expense: "Incidental", skillIdentifier: "DEX*5", range: 1, dmg: "Penalty -20%", ap: "", lethality: "", ammoC: 12, ammoM: 12, desc: "A small, concealable canister of oleoresin capsicum for self-defense.", examples: "e.g., SABRE Red, POM." },
            { name: "Pepper Spray Can", expense: "Incidental", skillIdentifier: "DEX*5", range: 3, dmg: "Penalty -20%", ap: "", lethality: "", ammoC: 12, ammoM: 12, desc: "A larger canister of oleoresin capsicum for crowd control or more sustained use.", examples: "e.g., Police-issue OC spray." },
            { name: "Tear Gas (Thrown)", expense: "Standard", skillIdentifier: "Athletics+20", range: 10, dmg: "Penalty -40%", ap: "", lethality: "", ammoC: 1, ammoM: 1, desc: "Canister that releases a chemical agent (CS or CN gas) causing severe irritation and temporary blindness.", examples: "e.g., M7A3 CS Grenade." },
            { name: "Tear Gas (Launched)", expense: "Standard", skillIdentifier: "Heavy Weapons", range: 50, dmg: "Penalty -40%", ap: "", lethality: "", ammoC: 1, ammoM: 1, desc: "Grenade launcher variant of the tear gas canister for area denial at range.", examples: "e.g., 40mm CS Gas Cartridge." }
        ],
        "Demolitions": [
            { name: "Det Cord/Extrudable Explosive", expense: "Incidental", skillIdentifier: "Science", range: 0, dmg: "", ap: "", lethality: "10", ammoC: 1, ammoM: 1, desc: "500g of flexible explosive cord or plastic explosive for precise cutting or breaching. Kill Radius: 5m. RESTRICTED.", examples: "e.g., Primacord, Semtex, C-4." },
            { name: "Improvised Explosive (IED)", expense: "Incidental", skillIdentifier: "Science", range: 0, dmg: "", ap: "", lethality: "15", ammoC: 1, ammoM: 1, desc: "A homemade bomb, often powerful but potentially unreliable. Ingredients are not restricted. Kill Radius: 10m. RESTRICTED.", examples: "e.g., Pipe bomb, fertilizer bomb." },
            { name: "Bundled IED", expense: "Incidental", skillIdentifier: "Science", range: 0, dmg: "", ap: "", lethality: "30", ammoC: 1, ammoM: 1, desc: "Multiple IEDs wired together for a much larger blast. Kill Radius: 20m. RESTRICTED.", examples: "e.g., A series of pipe bombs." },
            { name: "Explosively-Formed Penetrator", expense: "Standard", skillIdentifier: "Science", range: 0, dmg: "", ap: "20", lethality: "25", ammoC: 1, ammoM: 1, desc: "A special type of charge designed to fire a molten metal slug capable of defeating heavy armor. Kill Radius: 10m. RESTRICTED.", examples: "e.g., M21 Landmine." },
            { name: "ANFO Explosive", expense: "Incidental", skillIdentifier: "Science", range: 0, dmg: "", ap: "", lethality: "30", ammoC: 1, ammoM: 1, desc: "A powerful, bulk industrial explosive made from ammonium nitrate and fuel oil. Kill Radius: 20m. RESTRICTED.", examples: "e.g., Fertilizer and fuel oil mixture." }
        ]
    };
    
    const armorPresets = [
        { name: "Kevlar vest", ap: 3, desc: "If worn below outer garments, noticing it requires an Alertness test.", isBombSuit: false },
        { name: "Reinforced Kevlar vest", ap: 4, desc: "If worn below outer garments, noticing it requires an Alertness test at +20%.", isBombSuit: false },
        { name: "Tactical body armor", ap: 5, desc: "Cannot be concealed.", isBombSuit: false },
        { name: "Bomb suit", ap: 10, desc: "Already includes a helmet. Cannot be concealed.", isBombSuit: true }
    ];

    // --- DAILY HISTORY FEED ---
    function loadDailyHistory() {
        const contentEl = document.getElementById('history-content');
        const titleEl = document.getElementById('history-title');
        const imageEl = document.getElementById('history-image');

        const today = new Date();
        const month = today.getMonth() + 1; // JS months are 0-11
        const day = today.getDate();
        const dateString = `${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}-${today.getFullYear()}`;
        titleEl.textContent = `THIS DAY IN HISTORY // ${dateString}`;

        fetch('history.json')
            .then(response => { if (!response.ok) { throw new Error(`Network response was not ok. Status: ${response.status}`); } return response.json(); })
            .then(data => {
                const todayEvent = data.find(item => item.month === month && item.day === day);
                if (todayEvent) {
                    contentEl.textContent = todayEvent.event;
                    if (todayEvent.image_url) {
                        imageEl.src = todayEvent.image_url;
                        imageEl.alt = todayEvent.image_alt || "Historical event";
                        imageEl.style.display = 'block';
                    } else { imageEl.style.display = 'none'; }
                } else { contentEl.textContent = 'No significant military events recorded for this date.'; imageEl.style.display = 'none'; }
            })
            .catch(error => { console.error('Error fetching historical data:', error); contentEl.textContent = 'Failed to load historical data. Ensure history.json is in the same directory.'; imageEl.style.display = 'none'; });
    }

    // --- INITIALIZATION ---
    window.onload = () => {
        populateBranches(); populateStats(); populateSkills(); loadSavedSheets(); applySavedTheme(); setupTooltips(); loadDailyHistory(); populateWeaponCategories();
        document.getElementById('settings-btn').addEventListener('click', () => { document.getElementById('settings-menu').style.display = document.getElementById('settings-menu').style.display === 'block' ? 'none' : 'block'; });
        document.getElementById('lock-branch-rank-checkbox').addEventListener('change', updateBranchRankLockState);
        document.getElementById('skills-container').addEventListener('input', updateLinkedWeaponStats);
        document.getElementById('skills-container').addEventListener('change', (event) => { if (event.target.type === 'checkbox') { updateRollSkillsButtonVisibility(); } });
    };
    
    function resetForm() {
        document.getElementById('sheet-form').reset();
        document.getElementById('bonds-container').innerHTML = '';
        document.getElementById('weapons-body').innerHTML = '';
        deactivateArmor();
        populateSkills(); populateStats(); addBond(); addBond(); addBond(); addDefaultUnarmed(); updateAllCalculations(); checkAdaptedStatus(); setupTooltips();
        document.getElementById('lock-branch-rank-checkbox').checked = false;
        updateBranchRankLockState();
        updateRollSkillsButtonVisibility();
    }
    
    function populateBranches() { document.getElementById('branch').innerHTML = Object.keys(branches).map(b => `<option value="${b}">${b.toUpperCase()}</option>`).join(''); }
    function populateStats() { document.getElementById('stats-container').innerHTML = stats.map(stat => `<div class="stat-item"><div class="stat-header"><label>${stat}</label><button type="button" onclick="changeStat('${stat}', -1)">-</button><input type="number" id="${stat}" value="${MIN_STAT_VALUE}" readonly oninput="updateAllCalculations()"><button type="button" onclick="changeStat('${stat}', 1)">+</button><span id="${stat}x5">x5: 0</span></div><div id="${stat}-desc" class="stat-desc"></div></div>`).join(''); }
    function populateSkills() { const container = document.getElementById('skills-container'); let html = '<div class="grid-container" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); grid-auto-rows: min-content; align-items: start;">'; html += simpleSkills.map(skill => { const baseValue = baseSkillValues[skill] || 0; const skillId = `skill-${skill.replace(/\s+/g, '-')}`; return `<div class="skill-item-simple"><label class="styled-checkbox"><input type="checkbox" id="check-${skillId}"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label for="${skillId}" data-skill="${skill}">${skill.toUpperCase()}</label><input type="number" id="${skillId}" min="0" max="100" value="${baseValue}"></div></div>`; }).join(''); html += '</div>'; html += '<div class="grid-container" style="grid-template-columns: 1fr 1fr; align-items: stretch; margin-top: 10px;">'; html += `<div><div class="sub-skill-group"> <h3 class="sub-skill-header" data-skill="Military Science">Military Science</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-land"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Military Science">Land</label><input type="number" id="skill-milsci-land" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-sea"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Military Science">Sea</label><input type="number" id="skill-milsci-sea" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-air"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Military Science">Air</label><input type="number" id="skill-milsci-air" value="0" min="0" max="100"></div></div> </div><div class="sub-skill-group" style="margin-top: 10px;"> <h3 class="sub-skill-header" data-skill="Pilot">Pilot</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-airplane"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">Airplane</label><input type="number" id="skill-pilot-airplane" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-helicopter"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">Helicopter</label><input type="number" id="skill-pilot-helicopter" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-boat"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">Boat</label><input type="number" id="skill-pilot-boat" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-rc"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">RC/Drone</label><input type="number" id="skill-pilot-rc" value="0" min="0" max="100"></div></div> </div></div>`; html += `<div class="sub-skill-group"> <h3 class="sub-skill-header" data-skill="Science">Science</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-biology"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Biology</label><input type="number" id="skill-science-biology" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-chemistry"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Chemistry</label><input type="number" id="skill-science-chemistry" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-mathematics"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Mathematics</label><input type="number" id="skill-science-mathematics" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-physics"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Physics</label><input type="number" id="skill-science-physics" value="0" min="0" max="100"></div></div> </div>`; html += '</div>'; html += '<div class="grid-container" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">'; html += `<div class="sub-skill-group"> <div class="sub-skill-header-flex"><h3 class="sub-skill-header" data-skill="Craft">Craft</h3><button type="button" onclick="addCraftSkill()">+ ADD</button></div> <div id="craft-skills-container"></div> </div>`; html += `<div class="sub-skill-group"> <div class="sub-skill-header-flex"><h3 class="sub-skill-header">Foreign Language</h3><button type="button" onclick="addLanguageSkill()">+ ADD</button></div> <div id="language-skills-container"></div> </div>`; html += '</div>'; container.innerHTML = html; }

    // --- TOOLTIP MANAGEMENT ---
    function setupTooltips() {
        const tooltip = document.getElementById('skill-tooltip');
        const skillLabels = document.querySelectorAll('[data-skill]');

        skillLabels.forEach(label => {
            label.addEventListener('mouseover', (e) => { const skillName = e.target.dataset.skill; const description = skillDescriptions[skillName]; if (description) { tooltip.innerHTML = description; tooltip.classList.remove('hidden'); } });
            label.addEventListener('mousemove', (e) => { tooltip.style.left = `${e.pageX + 15}px`; tooltip.style.top = `${e.pageY + 15}px`; });
            label.addEventListener('mouseout', () => { tooltip.classList.add('hidden'); });
        });
    }

    // --- THEME MANAGEMENT ---
    function changeTheme(theme) { localStorage.setItem('socom_theme', theme); applyCurrentTheme(theme); }
    function applyCurrentTheme(theme) { document.body.className = ''; if (isAdmin) document.body.classList.add('admin-mode'); if (theme !== 'default') document.body.classList.add(theme + '-theme'); }
    function applySavedTheme() { const savedTheme = localStorage.getItem('socom_theme'); if (savedTheme) applyCurrentTheme(savedTheme); else applyAutoTheme(); }
    function applyAutoTheme() {
        const savedTheme = localStorage.getItem('socom_theme');
        if (savedTheme && savedTheme !== 'default' && savedTheme !== 'army') { applyCurrentTheme(savedTheme); return; } 
        document.body.className = ''; if (isAdmin) document.body.classList.add('admin-mode');
        const rankSelect = document.getElementById('rank');
        const grade = rankSelect.options[rankSelect.selectedIndex]?.dataset.grade;
        const officerGrades = ['O-1','O-2','O-3','GS-14','SIS-2'];
        if (grade && officerGrades.includes(grade)) { document.body.classList.add('officer-theme'); return; }
        const branchType = branches[document.getElementById('branch').value];
        if (branchType && branchType !== 'army') { document.body.classList.add(branchType + '-theme'); }
    }

    // --- VIEW MANAGEMENT & UI/CALCS ---
    function showView(viewId) { document.querySelectorAll('main').forEach(el => el.classList.add('hidden')); const viewEl = document.getElementById(`${viewId}-view`); if(viewEl){ viewEl.classList.remove('hidden'); if(viewId === 'loader') loadSavedSheets();} }
    function updateRanks() { const rankType = branches[document.getElementById('branch').value] || 'intelligence'; const rankOptions = ranks[rankType].map(r => { const isDisabled = r.adminOnly && !isAdmin; const label = `${r.name} (${r.grade})${r.adminOnly ? ' 🔒' : ''}`; return `<option value="${r.name}" data-grade="${r.grade}" ${isDisabled ? 'disabled' : ''}>${label}</option>`; }).join(''); document.getElementById('rank').innerHTML = rankOptions; applyAutoTheme(); }
    function changeStat(stat, delta) { if (statsUnlocked) return; const input = document.getElementById(stat); let pointsSpent = stats.reduce((acc, s) => acc + (parseInt(document.getElementById(s).value) - MIN_STAT_VALUE), 0); let currentValue = parseInt(input.value); if (delta > 0 && pointsSpent < MAX_STAT_POINTS && currentValue < MAX_STAT_VALUE) { input.value = currentValue + 1; } else if (delta < 0 && currentValue > MIN_STAT_VALUE) { input.value = currentValue - 1; } updateAllCalculations(); }
    function updateAllCalculations() { let pointsSpent = 0; stats.forEach(stat => { const value = parseInt(document.getElementById(stat).value); pointsSpent += (value - MIN_STAT_VALUE); document.getElementById(`${stat}x5`).textContent = `x5: ${value * 5}`; document.getElementById(`${stat}-desc`).textContent = getStatDescription(stat, value); }); document.getElementById('stat-points-remaining').textContent = MAX_STAT_POINTS - pointsSpent; updateDerivedAttributes(); updateBondScores(); updateLinkedWeaponStats(); }
    function updateDerivedAttributes() {
        const str = parseInt(document.getElementById('STR').value), con = parseInt(document.getElementById('CON').value), pow = parseInt(document.getElementById('POW').value);
        const hpMaxInput = document.getElementById('hp-max'), wpMaxInput = document.getElementById('wp-max'), sanMaxInput = document.getElementById('san-max'), bpInput = document.getElementById('bp');
        if (!isAdmin) { hpMaxInput.value = Math.ceil((str + con) / 2); wpMaxInput.value = pow; sanMaxInput.value = pow * 5; bpInput.value = Math.max(0, parseInt(sanMaxInput.value) - pow); }
        const hpCurrent = document.getElementById('hp-current'); hpCurrent.max = parseInt(hpMaxInput.value); if(!hpCurrent.value || parseInt(hpCurrent.value) > hpCurrent.max) hpCurrent.value = hpCurrent.max;
        const wpCurrent = document.getElementById('wp-current'); wpCurrent.max = parseInt(wpMaxInput.value); if(!wpCurrent.value || parseInt(wpCurrent.value) > wpCurrent.max) wpCurrent.value = wpCurrent.max;
        const sanCurrent = document.getElementById('san-current'); sanCurrent.max = parseInt(sanMaxInput.value); if(!sanCurrent.value || parseInt(sanCurrent.value) > sanCurrent.max) sanCurrent.value = sanCurrent.max;
        checkBreakingPoint();
    }
    function checkBreakingPoint() { const sanCurrent = parseInt(document.getElementById('san-current').value), bp = parseInt(document.getElementById('bp').value); document.getElementById('bp-warning').classList.toggle('hidden', sanCurrent > bp); }
    function acknowledgeBreakingPoint() { document.getElementById('bp').value = Math.max(0, parseInt(document.getElementById('san-current').value) - parseInt(document.getElementById('POW').value)); document.getElementById('bp-warning').classList.add('hidden'); }
    function getStatDescription(stat, val) { const tiers = statDescriptions[stat]; let desc = tiers[val] || ''; for (const key in tiers) { if (val >= key) desc = tiers[key]; } return `// ${desc}`; }
    
    // --- SKILL IMPROVEMENT ---
    function updateRollSkillsButtonVisibility() {
        const checkedSkills = document.querySelectorAll('#skills-container input[type="checkbox"]:checked');
        document.getElementById('roll-skills-btn').classList.toggle('hidden', checkedSkills.length === 0);
    }

    function startSkillImprovement() {
        document.getElementById('skill-roll-modal').classList.remove('hidden');
        document.getElementById('skill-roll-prompt').classList.remove('hidden');
        document.getElementById('skill-roll-process').classList.add('hidden');
        document.getElementById('skill-roll-conclusion').classList.add('hidden');
    }

    function closeSkillRollModal() {
        document.getElementById('skill-roll-modal').classList.add('hidden');
    }

    async function executeSkillRolls() {
        const checkedBoxes = Array.from(document.querySelectorAll('#skills-container input[type="checkbox"]:checked'));
        const skillsToRoll = [];

        for (const box of checkedBoxes) {
            const skillItem = box.closest('.skill-item-simple, .sub-skill-item');
            if (!skillItem) continue;

            const scoreInput = skillItem.querySelector('input[type="number"]');
            let skillName = "Unknown Skill";

            // Determine the skill's name for display
            if (skillItem.classList.contains('skill-item-simple')) {
                skillName = skillItem.querySelector('.skill-label-input label').textContent.trim();
            } else {
                const craftSelect = skillItem.querySelector('select[data-skill="Craft"]');
                const langInput = skillItem.querySelector('input[placeholder="Language"]');
                if (craftSelect) {
                    skillName = `Craft: ${craftSelect.value}`;
                } else if (langInput) {
                    skillName = `Language: ${langInput.value || '(Unnamed)'}`;
                } else {
                    const group = skillItem.closest('.sub-skill-group');
                    const header = group.querySelector('.sub-skill-header');
                    const subTypeName = skillItem.querySelector('.skill-label-input label').textContent.trim();
                    const headerName = header.textContent.trim();
                    skillName = `${headerName}: ${subTypeName}`;
                }
            }
            
            const currentScore = parseInt(scoreInput.value, 10);
            if (currentScore >= 99) {
                alert(`ERROR: Skill "${skillName}" is already at its maximum value (99). Cannot improve further.`);
                closeSkillRollModal();
                return;
            }
            
            skillsToRoll.push({ name: skillName, checkbox: box, input: scoreInput, currentScore: currentScore });
        }

        if (skillsToRoll.length === 0) {
            closeSkillRollModal();
            return;
        }
        
        document.getElementById('skill-roll-prompt').classList.add('hidden');
        document.getElementById('skill-roll-process').classList.remove('hidden');

        const skillNameEl = document.getElementById('rolling-skill-name');
        const diceEl = document.getElementById('dice-animation');
        const resultEl = document.getElementById('roll-result-text');

        for (const skill of skillsToRoll) {
            skillNameEl.textContent = `ROLLING: ${skill.name.toUpperCase()}`;
            resultEl.textContent = '';
            
            const animationInterval = setInterval(() => { diceEl.textContent = Math.floor(Math.random() * 4) + 1; }, 100);
            await new Promise(resolve => setTimeout(resolve, 4000));
            clearInterval(animationInterval);

            const roll = Math.floor(Math.random() * 4) + 1;
            diceEl.textContent = roll;
            
            const newScore = Math.min(99, skill.currentScore + roll);
            skill.input.value = newScore;
            
            resultEl.textContent = `Result: +${roll}. New Score: ${newScore}.`;
            skill.checkbox.checked = false;
            await new Promise(resolve => setTimeout(resolve, 2500));
        }

        document.getElementById('skill-roll-process').classList.add('hidden');
        document.getElementById('skill-roll-conclusion').classList.remove('hidden');
        updateRollSkillsButtonVisibility();
    }


    // --- INTERACTIVE SECTIONS ---
    function checkAdaptedStatus() { const violenceCount = document.querySelectorAll('#violence1:checked, #violence2:checked, #violence3:checked').length; document.getElementById('violence-adapted').classList.toggle('hidden', violenceCount < 3); const helplessnessCount = document.querySelectorAll('#helplessness1:checked, #helplessness2:checked, #helplessness3:checked').length; document.getElementById('helplessness-adapted').classList.toggle('hidden', helplessnessCount < 3); }
    function addCraftSkill(data = {}){ const container = document.getElementById('craft-skills-container'); const item = document.createElement('div'); item.className = 'sub-skill-item'; const craftTypes = ['Gunsmith', 'Locksmith', 'Mechanic', 'Microelectronics', 'Explosives']; let options = craftTypes.map(c => `<option value="${c}" ${c === data.type ? 'selected' : ''}>${c}</option>`).join(''); item.innerHTML = `<label class="styled-checkbox"><input type="checkbox" ${data.checked ? 'checked' : ''}><span class="checkbox-visual"></span></label><div class="skill-label-input"><select data-skill="Craft">${options}</select><input type="number" min="0" max="100" value="${data.score || 0}"></div><button class="remove-btn" onclick="this.parentElement.remove()">X</button>`; container.appendChild(item); setupTooltips(); }
    function addLanguageSkill(data = {}){ const container = document.getElementById('language-skills-container'); const item = document.createElement('div'); item.className = 'sub-skill-item'; item.innerHTML = `<label class="styled-checkbox"><input type="checkbox" ${data.checked ? 'checked' : ''}><span class="checkbox-visual"></span></label><div class="skill-label-input"><input type="text" placeholder="Language" value="${data.lang || ''}"><input type="number" min="0" max="100" value="${data.score || 0}"></div><button class="remove-btn" onclick="this.parentElement.remove()">X</button>`; container.appendChild(item); }
    function addBond(data = {}) { const container = document.getElementById('bonds-container'); const item = document.createElement('div'); item.className = 'bond-item'; item.innerHTML = `<label class="styled-checkbox"><input type="checkbox" ${data.checked ? 'checked' : ''}><span class="checkbox-visual"></span></label><input type="text" placeholder="Bond Name" value="${data.name || ''}"><select class="bond-score"></select><button class="remove-btn" onclick="this.parentElement.remove()">X</button>`; container.appendChild(item); updateBondScores(); if(data.score) item.querySelector('.bond-score').value = data.score; }
    function updateBondScores() { const cha = parseInt(document.getElementById('CHA').value) || 0; document.getElementById('bond-cha-note').textContent = `MAX SCORE: ${cha}`; document.querySelectorAll('.bond-score').forEach(select => { const currentScore = select.value; let options = ''; for (let i = 0; i <= cha; i++) { options += `<option value="${i}">${i}</option>`; } select.innerHTML = options; select.value = Math.min(currentScore, cha); }); }
    
    // --- WEAPON MANAGEMENT ---
    function addDefaultUnarmed() { const unarmedPreset = weaponPresets["Melee Weapons"][0]; addWeapon(unarmedPreset); }
    function getCalculatedSkill(skillIdentifier) {
        if (!skillIdentifier) return 20;
        const get = (id, fallback) => parseInt(document.getElementById(id)?.value) || fallback;
        
        switch(skillIdentifier) {
            case 'Unarmed Combat': return get('skill-Unarmed-Combat', 40);
            case 'Melee Weapons': return get('skill-Melee-Weapons', 30);
            case 'DEX*5': return (get('DEX', 10) * 5);
            case 'Firearms': return get('skill-Firearms', 20);
            case 'Athletics': return get('skill-Athletics', 30);
            case 'Athletics+20': return Math.min(99, get('skill-Athletics', 30) + 20);
            case 'Heavy Weapons': return get('skill-Heavy-Weapons', 10);
            case 'Science':
                const scienceSkills = ['skill-science-biology', 'skill-science-chemistry', 'skill-science-mathematics', 'skill-science-physics'];
                return Math.max(...scienceSkills.map(id => get(id, 0)), 10); // Use 10 as a base for science
            default: return parseInt(skillIdentifier) || 20;
        }
    }
    
    function updateLinkedWeaponStats() {
        const weaponRows = document.querySelectorAll('#weapons-body tr');
        weaponRows.forEach(row => {
            const skillIdentifier = row.dataset.skillIdentifier;
            if (!skillIdentifier) return; // Skip if this weapon isn't linked to a skill

            // --- Part 1: Update the Skill Value ---
            const newSkillValue = getCalculatedSkill(skillIdentifier);
            const skillInput = row.cells[1].querySelector('input');
            if (skillInput) {
                skillInput.value = newSkillValue;
            }

            // --- Part 2: Update the Damage Value based on Skill ---
            const baseDamage = row.dataset.baseDamage;
            const damageInput = row.cells[3].querySelector('input');

            // Only apply bonus to Unarmed and Melee weapons that have a base damage value
            if ((skillIdentifier === 'Unarmed Combat' || skillIdentifier === 'Melee Weapons') && baseDamage && damageInput) {
                let bonus = 0;
                if (newSkillValue > 90) {
                    bonus = 3;
                } else if (newSkillValue > 75) {
                    bonus = 2;
                } else if (newSkillValue > 50) {
                    bonus = 1;
                }

                if (bonus > 0) {
    // Isolate the dice part (e.g., "1D4") from the base damage string (e.g., "1D4-1")
    const dicePart = baseDamage.split(/[-+]/)[0].trim();
    // Append the new bonus
    damageInput.value = `${dicePart}+${bonus}`;
} else {
    damageInput.value = baseDamage; // Revert to base damage if skill is 50 or below
}
            }
        });
    }

    function addWeapon(preset, closeModal = false) {
        const newRow = document.getElementById('weapons-body').insertRow();
        const defaultData = { name: '', skill: '', range: '', dmg: '', ap: '', lethality: '', ammoC: '', ammoM: '' };
        const effectivePreset = preset || {};

        let finalData;
        if (effectivePreset.skillIdentifier) {
            const calculatedSkill = getCalculatedSkill(effectivePreset.skillIdentifier);
            finalData = { ...defaultData, ...effectivePreset, skill: calculatedSkill };
        } else {
            finalData = { ...defaultData, ...effectivePreset };
        }

        newRow.dataset.skillIdentifier = finalData.skillIdentifier || '';
        newRow.dataset.baseDamage = finalData.dmg || '';
        newRow.innerHTML = `<td><input type="text" value="${finalData.name}"></td><td><input type="number" min="0" max="99" value="${finalData.skill}"></td><td><div class="input-group"><input type="number" min="0" value="${finalData.range}"><span class="input-group-addon">m</span></div></td><td><input type="text" value="${finalData.dmg}"></td><td><input type="text" value="${finalData.ap}"></td><td><div class="input-group"><input type="number" min="0" max="100" value="${finalData.lethality}"><span class="input-group-addon">%</span></div></td><td><div class="derived-attr-input"><input type="number" min="0" value="${finalData.ammoC}"> / <input type="number" min="0" value="${finalData.ammoM}"></div></td><td><button type="button" class="remove-btn" onclick="this.closest('tr').remove()">X</button></td>`;
        if (closeModal) { closeWeaponModal(); }
        updateLinkedWeaponStats(); // Immediately apply damage bonus if applicable
    }

    // --- WEAPON MODAL ---
    function openWeaponModal() { document.getElementById('weapon-preset-modal').classList.remove('hidden'); populateWeaponPresets(); }
    function closeWeaponModal() { document.getElementById('weapon-preset-modal').classList.add('hidden'); }
    function populateWeaponCategories() { const select = document.getElementById('weapon-category-select'); select.innerHTML = Object.keys(weaponPresets).map(cat => `<option value="${cat}">${cat.toUpperCase()}</option>`).join(''); }
    function populateWeaponPresets() {
        const category = document.getElementById('weapon-category-select').value;
        const list = document.getElementById('weapon-preset-list');
        if (!weaponPresets[category]) { list.innerHTML = ''; return; }

        list.innerHTML = weaponPresets[category].map(preset => `
            <li class="preset-item">
                <div class="preset-info">
                    <h4>${preset.name} <span class="expense-tag">(${preset.expense})</span></h4>
                    ${preset.desc ? `<p>${preset.desc}</p>` : ''}
                    ${preset.examples ? `<small>${preset.examples}</small>` : ''}
                </div>
                <button onclick='addWeapon(${JSON.stringify(preset)}, true)'>SELECT</button>
            </li>
        `).join('');
    }
    
    // --- ARMOR MANAGEMENT ---
    function toggleArmor() {
        if (isArmorActive) {
            deactivateArmor();
        } else {
            openArmorModal();
        }
    }
    function openArmorModal() {
        populateArmorPresets();
        document.getElementById('armor-modal').classList.remove('hidden');
    }
    function closeArmorModal() {
        document.getElementById('armor-modal').classList.add('hidden');
    }
    function populateArmorPresets() {
        const list = document.getElementById('armor-preset-list');
        const helmetCheckbox = document.getElementById('helmet-checkbox');
        list.innerHTML = armorPresets.map(preset => `
            <li class="preset-item" data-is-bomb-suit="${preset.isBombSuit}">
                <div class="preset-info">
                    <h4>${preset.name} <span class="expense-tag">(AP: ${preset.ap})</span></h4>
                    <p>${preset.desc}</p>
                </div>
                <button onclick='selectArmor(${preset.ap}, ${preset.isBombSuit})'>SELECT</button>
            </li>
        `).join('');
        document.querySelectorAll('#armor-preset-list .preset-item').forEach(item => {
            item.addEventListener('mouseover', () => {
                const isBombSuit = item.getAttribute('data-is-bomb-suit') === 'true';
                if (isBombSuit) {
                    helmetCheckbox.checked = false;
                    helmetCheckbox.disabled = true;
                } else {
                    helmetCheckbox.disabled = false;
                }
            });
        });
    }
    function selectArmor(baseAP, isBombSuit) {
        const helmetCheckbox = document.getElementById('helmet-checkbox');
        let totalAP = baseAP;
        if (helmetCheckbox.checked && !isBombSuit) {
            totalAP += 1;
        }
        isArmorActive = true;
        currentArmorPoints = totalAP;
        const apInput = document.getElementById('armor-points');
        const armorBtn = document.getElementById('armor-btn');
        apInput.value = totalAP;
        apInput.classList.remove('hidden');
        apInput.classList.add('armor-active');
        armorBtn.classList.add('armor-active');
        closeArmorModal();
    }
    function deactivateArmor() {
        isArmorActive = false;
        currentArmorPoints = 0;
        const apInput = document.getElementById('armor-points');
        const armorBtn = document.getElementById('armor-btn');
        const helmetCheckbox = document.getElementById('helmet-checkbox');
        apInput.value = 0;
        apInput.classList.add('hidden');
        apInput.classList.remove('armor-active');
        armorBtn.classList.remove('armor-active');
        helmetCheckbox.checked = false;
        helmetCheckbox.disabled = false;
    }
    function validateArmorPoints(event) {
        const input = event.target;
        let value = parseInt(input.value, 10);
        if (isNaN(value)) {
            value = currentArmorPoints; // Keep current value if input is invalid
        }
        if (value > currentArmorPoints) {
            input.value = currentArmorPoints;
        } else {
            currentArmorPoints = value;
        }
        if (currentArmorPoints <= 0) {
            deactivateArmor();
        }
    }

    // --- ADMIN & LOCKING FUNCTIONS ---
    function toggleAdminMode() {
        const rankSelect = document.getElementById('rank'); const currentRankValue = rankSelect.value;
        const derivedInputs = ['bp', 'hp-max', 'wp-max', 'san-max'];
        if (isAdmin) {
            isAdmin = false; if (statsUnlocked) toggleStatsLock();
            document.body.classList.remove('admin-mode');
            document.getElementById('admin-login-btn').textContent = 'Admin Login';
            document.getElementById('toggle-stats-lock-btn').classList.add('hidden');
            document.getElementById('lock-branch-rank-container').classList.add('hidden');
            derivedInputs.forEach(id => document.getElementById(id).readOnly = true);
            updateAllCalculations(); alert('Admin mode deactivated.');
        } else {
            const pass = prompt('Enter NEMESIS clearance code:');
            if (btoa(pass) === ADMIN_PASSWORD_HASH) {
                isAdmin = true;
                document.body.classList.add('admin-mode');
                document.getElementById('admin-login-btn').textContent = 'Admin Logout';
                document.getElementById('toggle-stats-lock-btn').classList.remove('hidden');
                document.getElementById('lock-branch-rank-container').classList.remove('hidden');
                derivedInputs.forEach(id => document.getElementById(id).readOnly = false);
                alert('Admin mode activated. Privileges granted.');
            } else if (pass) { alert('Access Denied.'); }
        }
        updateRanks(); rankSelect.value = currentRankValue; updateBranchRankLockState();
    }
    
    function toggleStatsLock() { statsUnlocked = !statsUnlocked; const btn = document.getElementById('toggle-stats-lock-btn'); const pointsCounter = document.getElementById('stat-points-remaining').parentElement.parentElement; stats.forEach(stat => { const input = document.getElementById(stat); input.readOnly = !statsUnlocked; input.previousElementSibling.disabled = statsUnlocked; input.nextElementSibling.disabled = statsUnlocked; }); if (statsUnlocked) { btn.textContent = 'LOCK STATS'; pointsCounter.classList.add('hidden'); } else { btn.textContent = 'FORCE STATS'; pointsCounter.classList.remove('hidden'); updateAllCalculations(); } }
    function updateBranchRankLockState() { const isLocked = document.getElementById('lock-branch-rank-checkbox').checked; document.getElementById('branch').disabled = isLocked && !isAdmin; document.getElementById('rank').disabled = isLocked && !isAdmin; }

    // --- DATA MANAGEMENT ---
    function getCompleteFormData() { const data = { id: document.getElementById('character-id').value || `sheet_${Date.now()}` }; data.branchRankLocked = document.getElementById('lock-branch-rank-checkbox').checked; document.querySelectorAll('#sheet-form [id]').forEach(el => { if (el.id) data[el.id] = el.type === 'checkbox' ? el.checked : el.value; }); data.crafts = Array.from(document.querySelectorAll('#craft-skills-container .sub-skill-item')).map(item => ({checked: item.querySelector('input[type=checkbox]').checked, type: item.querySelector('select').value, score: item.querySelector('input[type=number]').value})); data.languages = Array.from(document.querySelectorAll('#language-skills-container .sub-skill-item')).map(item => ({checked: item.querySelector('input[type=checkbox]').checked, lang: item.querySelector('input[type=text]').value, score: item.querySelector('input[type=number]').value})); data.weapons = Array.from(document.querySelectorAll('#weapons-body tr')).map(row => { const i = row.querySelectorAll('input'); return { name: i[0].value, skill: i[1].value, range: i[2].value, dmg: i[3].value, ap: i[4].value, lethality: i[5].value, ammoC: i[6].value, ammoM: i[7].value }; }); data.bonds = Array.from(document.querySelectorAll('.bond-item')).map(item => ({ checked: item.querySelector('input[type="checkbox"]').checked, name: item.querySelector('input[type="text"]').value, score: item.querySelector('select').value })); data.isArmorActive = isArmorActive; data.currentArmorPoints = currentArmorPoints; return data; }
    function populateCompleteForm(data) {
        resetForm(); 
        document.getElementById('weapons-body').innerHTML = ''; // Clear default unarmed before loading
        Object.keys(data).forEach(key => { if (!['weapons', 'bonds', 'crafts', 'languages', 'branchRankLocked', 'isArmorActive', 'currentArmorPoints'].includes(key)) { const el = document.getElementById(key); if (el) { el[el.type === 'checkbox' ? 'checked' : 'value'] = data[key]; } } });
        document.getElementById('bonds-container').innerHTML = ''; 
        if (data.crafts) data.crafts.forEach(c => addCraftSkill(c)); if (data.languages) data.languages.forEach(l => addLanguageSkill(l));
        if (data.weapons && data.weapons.length > 0) { data.weapons.forEach(w => addWeapon(w)); } else { addDefaultUnarmed(); }
        if (data.bonds && data.bonds.length > 0) { data.bonds.forEach(b => addBond(b)); } else { addBond(); addBond(); addBond(); }
        
        document.getElementById('lock-branch-rank-checkbox').checked = data.branchRankLocked || false;
        updateRanks(); 
        if (data.rank) document.getElementById('rank').value = data.rank; 
        updateAllCalculations(); checkAdaptedStatus(); applyAutoTheme(); updateBranchRankLockState();
        if (data.isArmorActive) {
            isArmorActive = true; currentArmorPoints = data.currentArmorPoints || 0;
            const apInput = document.getElementById('armor-points'); const armorBtn = document.getElementById('armor-btn');
            if (currentArmorPoints > 0) { apInput.value = currentArmorPoints; apInput.classList.remove('hidden'); apInput.classList.add('armor-active'); armorBtn.classList.add('armor-active'); } else { deactivateArmor(); }
        } else { deactivateArmor(); }
        updateRollSkillsButtonVisibility();
    }
    function saveCharacter() { const data = getCompleteFormData(); const name = data['full-name'] || 'UNNAMED_AGENT'; const sheetName = prompt("Save file as:", name); if (sheetName) { localStorage.setItem(data.id, JSON.stringify({ name: sheetName, ...data })); alert(`Agent file '${sheetName}' saved locally.`); loadSavedSheets(); } }
    function loadSavedSheets() { const list = document.getElementById('saved-sheets-list'); list.innerHTML = ''; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith('sheet_')) { const data = JSON.parse(localStorage.getItem(key)); const li = document.createElement('li'); li.innerHTML = `<span>${data.name}</span><div><button onclick="renameSheet('${key}')">RENAME</button><button onclick="loadSheet('${key}')">LOAD</button><button class="remove-btn" onclick="deleteSheet('${key}')">DELETE</button></div>`; list.appendChild(li); } } }
    function loadSheet(key) { populateCompleteForm(JSON.parse(localStorage.getItem(key))); showView('character-sheet'); }
    function deleteSheet(key) { if(confirm("DELETE FILE?")){ localStorage.removeItem(key); loadSavedSheets(); }}
    function renameSheet(key) { const data = JSON.parse(localStorage.getItem(key)); const newName = prompt("New filename:", data.name); if (newName) { data.name = newName; localStorage.setItem(key, JSON.stringify(data)); loadSavedSheets(); } }
    function loadCharacterFromFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { populateCompleteForm(JSON.parse(e.target.result)); showView('character-sheet'); }; reader.readAsText(file); }
    function exportToJson(){ const data = getCompleteFormData(); const jsonString = JSON.stringify(data, null, 2); const blob = new Blob([jsonString], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${(data['full-name'] || 'agent').replace(/\s+/g, '_')}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    
    function screenshotPage(event) {
        const btn = event.currentTarget; const originalText = btn.textContent;
        btn.textContent = '...CAPTURING...'; btn.disabled = true;
        html2canvas(document.querySelector('.container'), { useCORS: true, allowTaint: true, scrollX: 0, scrollY: -window.scrollY })
            .then(canvas => {
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png', 1.0);
                const agentName = document.getElementById('full-name').value || 'UNNAMED_AGENT';
                a.download = `${agentName.replace(/\s+/g, '_')}_Sheet.png`;
                a.click(); a.remove();
            }).catch(err => { console.error('Screenshot failed:', err); alert('Could not capture screenshot. See console for details.');
            }).finally(() => { btn.textContent = originalText; btn.disabled = false; });
    }
</script>

</body>
</html>
