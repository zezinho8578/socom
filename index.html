<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.O.C.O.M.</title>
    <link rel="icon" type="image/png" href="https://www.socom.mil/SOF-ATL/PublishingImages/eSOF-Logo.png">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @keyframes flicker { 0%, 100% { opacity: 0.95; } 50% { opacity: 1; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        :root {
            --bg-color: #050805; --scanline-color: rgba(0, 255, 85, 0.1); --text-color: #00ff55;
            --accent-color: #00ff55; --border-color: #00521d; --input-bg: rgba(0, 31, 9, 0.95);
            --danger-color: #ff4141; --danger-bg: rgba(255, 65, 65, 0.15); --container-bg: rgba(0,0,0,0.4);
        }
        body.officer-theme {
            --bg-color: #1a160d; --scanline-color: rgba(255, 196, 0, 0.1); --text-color: #ffc400;
            --accent-color: #ffc400; --border-color: #6d530e; --input-bg: rgba(43, 34, 13, 0.95);
            --container-bg: rgba(10, 8, 3, 0.4);
        }
        body.navy-theme {
            --bg-color: #0a1128; --text-color: #7bceff; --accent-color: #7bceff; 
            --border-color: #00306b; --input-bg: rgba(20, 39, 87, 0.95); --container-bg: rgba(4, 7, 15, 0.4);
        }
        body.marines-theme {
            --bg-color: #1a0b0b; --text-color: #ff5252; --accent-color: #ff5252; 
            --border-color: #6a0d0d; --input-bg: rgba(64, 13, 13, 0.95); --container-bg: rgba(10, 3, 3, 0.4);
        }
        body.airforce-theme {
            --bg-color: #1d1d1f; --text-color: #d1d1d6; --accent-color: #d1d1d6; 
            --border-color: #424245; --input-bg: rgba(50, 50, 56, 0.95); --container-bg: rgba(11, 11, 12, 0.4);
        }
        body.intelligence-theme {
            --bg-color: #000000; --text-color: #ffffff; --accent-color: #ffffff;
            --border-color: #555555; --input-bg: rgba(40, 40, 40, 0.95); --container-bg: rgba(10, 10, 10, 0.4);
        }
        body.plain-theme {
            font-family: Arial, Helvetica, sans-serif;
            --bg-color: #ffffff; --text-color: #000000; --accent-color: #005fcc;
            --border-color: #cccccc; --input-bg: #f9f9f9; --danger-color: #dc3545;
            --container-bg: rgba(248,248,248,0.8);
            text-shadow: none; animation: none;
        }
        body.plain-theme .logo { filter: none; }
        body.plain-theme h1::after { animation: none; content: ''; }
        body.plain-theme button:hover { text-shadow: none; }
        body.plain-theme::before { background: none; }
        body.plain-theme .themed-link { color: var(--accent-color); filter: none; }
        body.plain-theme #app-tooltip { text-shadow: none; }


        body {
            font-family: 'Courier New', Courier, monospace; margin: 0; background-color: var(--bg-color); color: var(--text-color);
            text-shadow: 0 0 4px var(--accent-color); animation: flicker 0.15s infinite; overflow-y: scroll;
        }
        body::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(0deg, var(--scanline-color) 1px, transparent 1px);
            background-size: 100% 2px; z-index: 100; pointer-events: none;
        }

        .container { position: relative; max-width: 1400px; margin: 10px auto; padding: 10px; border: 1px solid var(--border-color); background: var(--container-bg); }
        .header { display: flex; align-items: center; border-bottom: 1px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 15px; }
        .logo { max-width: 80px; margin-right: 15px; filter: grayscale(100%) brightness(200%) contrast(150%); }

        h1 { font-size: 22px; text-transform: uppercase; }
        h1::after { content: '_'; animation: blink 1s step-end infinite; }
        h2 { font-size: 16px; margin-top: 10px; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; }
        h3, h3.sub-skill-header { font-size: 14px; text-transform: uppercase; border: none; margin: 0 0 5px 0; padding: 0;}

        .main-menu, .loader-menu, .content-menu { text-align: center; padding: 30px; border: 1px solid var(--border-color); margin: 20px; background: var(--input-bg); }
        .content-menu { text-align: left; }
        .content-menu p, .content-menu li { line-height: 1.6; }
        .content-menu ul { padding-left: 20px; list-style-type: none; }
        .content-menu li::before { content: "- "; }
        .themed-link {
            color: inherit;
            text-decoration: underline;
            filter: brightness(130%);
            transition: filter 0.2s;
        }
        .themed-link:hover {
            filter: brightness(160%);
        }

        button, .button {
            background: transparent; color: var(--accent-color); border: 1px solid var(--accent-color);
            padding: 8px 15px; font-size: 14px; cursor: pointer; margin: 5px;
            font-family: 'Courier New', Courier, monospace; text-transform: uppercase;
        }
        body.plain-theme button { font-family: Arial, Helvetica, sans-serif; }
        button:hover, .button:hover { background: var(--accent-color); color: var(--bg-color); text-shadow: none; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }

        .hidden { display: none !important; }

        #character-sheet-container { padding: 10px; border: 1px solid var(--border-color); }
        .form-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; align-items: start;}
        .col-1, .col-2 { display: flex; flex-direction: column; gap: 10px; }
        .col-1 .form-section:last-child { flex-grow: 1; }
        .form-section { background: var(--input-bg); padding: 10px; border: 1px solid var(--border-color); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        
        label { font-weight: bold; display: block; margin-bottom: 4px; color: var(--accent-color); font-size: 14px; }
        input, select, textarea {
            width: 100%; padding: 6px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color);
            border: 1px solid var(--border-color); font-family: 'Courier New', Courier, monospace;
        }
        body.plain-theme input, body.plain-theme select, body.plain-theme textarea { font-family: Arial, Helvetica, sans-serif; text-shadow: none; }
        textarea { resize: vertical; min-height: 50px; }

        .styled-checkbox { display: flex; align-items: center; cursor: pointer; user-select: none; }
        .styled-checkbox input[type="checkbox"] { display: none; }
        .styled-checkbox .checkbox-visual { width: 14px; height: 14px; border: 1px solid var(--accent-color); display: inline-block; position: relative; flex-shrink: 0; }
        .styled-checkbox input[type="checkbox"]:checked + .checkbox-visual::after { content: 'X'; position: absolute; top: -2px; left: 2px; color: var(--accent-color); }

        .stat-item { padding: 8px; border: 1px solid var(--border-color); }
        .stat-header { display: flex; align-items: center; gap: 8px; }
        .stat-header button { width: 22px; height: 22px; font-size: 14px; line-height: 14px; padding: 0; }
        .stat-desc { font-size: 0.9em; color: #8fbc8f; margin-top: 3px; }
        body.plain-theme .stat-desc { color: #555; text-shadow: none; }

        .derived-attr-input { display: flex; align-items: center; gap: 4px; }
        .derived-attr-input input { width: 50px; text-align: center; }

        .bond-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .remove-btn { font-size: 14px; color: var(--danger-color); cursor: pointer; background: none; border: none; padding: 0 4px; }
        
        .san-loss-container { display: flex; flex-direction: column; gap: 5px; }
        .san-loss-group { display: flex; align-items: center; justify-content: space-between; }
        .san-loss-label { display: flex; align-items: center; gap: 10px; flex-basis: 150px; }
        .san-loss-group div { display: flex; gap: 10px; }
        .adapted-status { color: var(--danger-color); font-weight: bold;}
        body:not(.plain-theme) .adapted-status { text-shadow: 0 0 5px var(--danger-color); }

        #bp-warning { padding: 10px; margin-top: 10px; border: 1px solid var(--danger-color); background-color: var(--danger-bg); color: var(--danger-color); }
        body:not(.plain-theme) #bp-warning { text-shadow: 0 0 5px var(--danger-color); }
        #bp-warning button { border-color: var(--danger-color); color: var(--danger-color); }

        #weapons-table td, #weapons-table th { padding: 4px; vertical-align: middle;}
        #weapons-table .ammo-cell { text-align: center; }
        .ammo-cell .derived-attr-input { display: inline-flex; } /* Make flex container not take full width */
        .input-group { display: flex; align-items: center; }
        .input-group-addon { padding: 6px; background: var(--border-color); border: 1px solid var(--border-color); border-left: none; }
        
        #saved-sheets-list li { background: var(--input-bg); padding: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        .sub-skill-group { padding: 8px; border: 1px solid var(--border-color); }
        .sub-skill-item { display: flex; align-items: center; margin-bottom: 5px; gap: 8px; }
        .skill-item-simple { display: flex; align-items: center; gap: 8px; }
        
        .skill-label-input { display: flex; align-items: center; gap: 8px; width: 100%;}
        .skill-label-input label { flex-shrink: 0; flex-basis: 120px; }
        .skill-label-input input { flex-grow: 1; }
        .sub-skill-item .skill-label-input label { flex-basis: 100px; white-space: nowrap; }

        .sub-skill-header-flex { display: flex; justify-content: space-between; align-items: center; }
        .sub-skill-header-flex button { padding: 2px 8px; font-size: 12px; margin: 0; }
        
        .settings-container { position: absolute; top: 10px; right: 10px; }
        #settings-menu { display: none; position: absolute; top: 100%; right: 0; background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px; z-index: 101; }
        #settings-menu button { display: block; width: 100%; text-align: left; }

        #app-tooltip {
            position: absolute;
            z-index: 110;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px;
            max-width: 350px;
            font-size: 0.9em;
            line-height: 1.4;
            pointer-events: none;
        }
        
        option:disabled { color: #666; background: #222; }
        body.plain-theme option:disabled { color: #aaaaaa; background: #eeeeee; }
        body.admin-mode .container { border-color: var(--danger-color); box-shadow: 0 0 10px var(--danger-color); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-color); border: 1px solid var(--accent-color); padding: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-controls { display: flex; gap: 20px; align-items: center; margin-bottom: 15px;}
        .preset-list { list-style: none; padding: 0; margin: 0; }
        .preset-item { border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px;}
        .preset-info { flex-grow: 1; }
        .preset-item h4 { margin: 0 0 8px 0; color: var(--accent-color); }
        .preset-item h4 .expense-tag { font-size: 0.8em; font-weight: normal; margin-left: 8px; opacity: 0.8; }
        .preset-item p { font-size: 0.9em; margin: 0 0 10px 0; line-height: 1.4; }
        .preset-item small { color: #8fbc8f; display: block; margin-top: 5px; }
        body.plain-theme .preset-item small { color: #555; }
        .preset-item button { flex-shrink: 0; }

        /* Armor-specific styles */
        .armor-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        #armor-btn {
            width: 34px;
            height: 34px;
            font-size: 16px;
            line-height: 16px;
            padding: 0;
            flex-shrink: 0;
        }
        #armor-points {
            width: 50px;
            text-align: center;
        }
        #armor-btn.armor-active {
            color: #0AF;
            border-color: #0AF;
            text-shadow: 0 0 3px #0AF, 0 0 8px #0AF;
            box-shadow: 0 0 5px #0AF;
            background: rgba(0, 170, 255, 0.1);
        }
        #armor-points.armor-active {
            color: #0AF;
            border-color: #0AF;
            text-shadow: 0 0 3px #0AF;
            background: rgba(0, 170, 255, 0.1);
        }
        #armor-preset-list .preset-item {
             cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- All HTML content will be injected by JavaScript -->
    </div>
    
    <div id="app-tooltip" class="hidden"></div>
    
    <!-- Weapon Preset Modal -->
    <div id="weapon-preset-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SELECT WEAPON</h2>
                <button onclick="closeWeaponModal()">CLOSE</button>
            </div>
            <div class="modal-controls">
                <label for="weapon-category-select">CATEGORY</label>
                <select id="weapon-category-select" onchange="populateWeaponPresets()"></select>
                <button onclick="addWeapon(null, true)">+ ADD CUSTOM</button>
            </div>
            <hr style="border-color: var(--border-color); margin: 15px 0;">
            <ul id="weapon-preset-list" class="preset-list">
                <!-- Preset items will be injected here by JS -->
            </ul>
        </div>
    </div>
    
    <!-- Armor Modal -->
    <div id="armor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SELECT ARMOR</h2>
                <button onclick="closeArmorModal()">CLOSE</button>
            </div>
            <div class="modal-controls">
                <label class="styled-checkbox">
                    <input type="checkbox" id="helmet-checkbox">
                    <span class="checkbox-visual"></span> ADD HELMET (+1 AP)
                </label>
            </div>
            <hr style="border-color: var(--border-color); margin: 15px 0;">
            <ul id="armor-preset-list" class="preset-list">
                <!-- Armor presets will be injected here by JS -->
            </ul>
        </div>
    </div>

    <!-- Skill Improvement Modal -->
    <div id="skill-roll-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div id="skill-roll-prompt">
                <h2 style="margin-bottom: 20px;">IMPROVE SKILLS?</h2>
                <p style="margin-bottom: 25px;">This should only be done after completing a session. This action is final. Are you sure you want to roll 1d4 for all checked skills?</p>
                <button onclick="executeSkillRolls()">CONFIRM</button>
                <button onclick="closeSkillRollModal()">CANCEL</button>
            </div>
            <div id="skill-roll-process" class="hidden">
                <h3 id="rolling-skill-name" style="margin-bottom: 20px; font-size: 1.2em;"></h3>
                <div id="dice-animation" style="font-size: 4em; font-weight: bold; margin-bottom: 25px; min-height: 60px;">-</div>
                <p id="roll-result-text"></p>
            </div>
            <div id="skill-roll-conclusion" class="hidden">
                <h2 style="margin-bottom: 20px;">CONCLUDED</h2>
                <button onclick="closeSkillRollModal()">CLOSE</button>
            </div>
        </div>
    </div>
    
<script src="socom_data.js"></script>
<script src="socom_admin_data.js"></script>
<script>
    // --- DISABLE ENTER KEY ---
    window.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });

    // --- INJECT ALL HTML ---
    document.querySelector('.container').innerHTML = `
        <header class="header"> <img src="https://images.squarespace-cdn.com/content/v1/629e0596d168b365d297c6c4/cea70b06-895e-401c-9669-04fa59cfc5e6/socom-logo.png" alt="SOCOM Logo" class="logo"> <h1>S.O.C.O.M. // AGENT ROSTER</h1> </header>
        <div class="settings-container"> <button id="settings-btn">⚙</button> <div id="settings-menu"> <button onclick="changeTheme('default')">Army (Green)</button> <button onclick="changeTheme('navy')">Navy (Blue)</button> <button onclick="changeTheme('marines')">Marines (Red)</button> <button onclick="changeTheme('airforce')">Air Force (Gray)</button> <button onclick="changeTheme('intelligence')">CIA/NSA (B&W)</button> <button onclick="changeTheme('officer')">Command (Gold)</button> <button onclick="changeTheme('plain')">Plain Mode</button><button id="admin-login-btn" onclick="toggleAdminMode()">Admin Login</button> </div> </div>
        
        <main id="main-view">
            <div class="main-menu">
                <h2>SYSTEM ACCESS</h2>
                
                <div id="daily-briefing" style="margin-bottom: 20px; border: 1px solid var(--border-color); padding: 10px; text-align: left; font-size: 0.9em;">
                    <h3 id="history-title" style="border: none; margin: 0 0 10px 0;">THIS DAY IN HISTORY // SYSTEM DATE</h3>
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <p id="history-content" style="margin: 0; line-height: 1.4; flex: 1;">...LOADING HISTORICAL DATA...</p>
                        <img id="history-image" src="" alt="Historical event" style="width: 220px; max-height: 160px; height: auto; border: 1px solid var(--border-color); object-fit: cover; display: none;">
                    </div>
                </div>

                <button onclick="resetForm(); showView('character-sheet'); ">> CREATE NEW AGENT FILE</button>
                <button onclick="showView('loader')">> LOAD AGENT FILE</button>
                <button onclick="showView('rules')">> RULES</button>
                <button onclick="showView('about')">> ABOUT SOCOM</button>
            </div>
        </main>
        
        <main id="loader-view" class="hidden"> <div class="loader-menu"> <h2>LOAD AGENT</h2> <input type="file" id="json-file-input" accept=".json" onchange="loadCharacterFromFile(event)" class="button"> <h3>LOCAL SAVES</h3> <ul id="saved-sheets-list"></ul> <button onclick="showView('main')">> RETURN</button> </div> </main>
        <main id="character-sheet-view" class="hidden"> <div id="character-sheet-container"> <button onclick="saveCharacter()">SAVE</button><button onclick="screenshotPage(event)">SCREENSHOT</button><button onclick="exportToJson()">EXPORT TO .JSON</button><label id="lock-branch-rank-container" class="styled-checkbox hidden" style="margin-left: 15px;"><input type="checkbox" id="lock-branch-rank-checkbox"><span class="checkbox-visual"></span> LOCK BRANCH/RANK</label> <button onclick="confirmReturnToMenu()">RETURN TO MENU</button> <form id="sheet-form" onsubmit="return false;"></form> </div> </main>
        <main id="rules-view" class="hidden"> 
            <div class="content-menu"><!-- Content for rules will be loaded here --></div> 
        </main>
        <main id="about-view" class="hidden"> 
            <div class="content-menu"><!-- Content for about page will be loaded here --></div>
        </main>
    `;

    document.getElementById('sheet-form').innerHTML = `
        <input type="hidden" id="character-id">
        <section class="form-section"> <h2>IDENTIFICATION</h2> <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr"> <div><label for="full-name">FULL NAME</label><input type="text" id="full-name"></div> <div><label for="branch">BRANCH</label><select id="branch" onchange="updateRanks()"></select></div> <div><label for="rank">RANK/GRADE</label><select id="rank" onchange="applyAutoTheme()"></select></div> <div><label for="team">TEAM</label><select id="team"><option>SOCOM 1</option><option>SOCOM 2</option><option>SOCOM 3</option><option>SOCOM 4</option><option>SOCOM 5</option><option>SOCOM 6</option></select></div> <div><label for="sex">SEX</label><select id="sex"><option>M</option><option>F</option><option>NA</option></select></div> <div><label for="dob">D.O.B.</label><input type="date" id="dob"></div> <div><label for="nationality">NATIONALITY</label><input type="text" id="nationality"></div> <div><label for="employer" data-tooltip="The Agent's previous unit or organization of origin before being recruited by SOCOM (e.g., U.S. Army Rangers, CIA SAD, DEVGRU).">EMPLOYER</label><input type="text" id="employer"></div> <div><label for="education">EDUCATION</label><input type="text" id="education"></div> </div> </section>
        <div class="form-grid"> <div class="col-1"> <section class="form-section"> <div style="display: flex; justify-content: space-between; align-items: center;"><h2>CORE ATTRIBUTES (<span id="stat-points-remaining">25</span> PTS)</h2><button type="button" id="toggle-stats-lock-btn" onclick="toggleStatsLock()" class="hidden">FORCE STATS</button></div> <div id="stats-container" style="display: flex; flex-direction: column; gap: 8px;"></div> </section> <section class="form-section"> <h2>DERIVED ATTRIBUTES</h2> <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr;"> <div><label data-tooltip="Hit Points: Represents physical health. When HP reaches 0, the agent is critically injured and may die.">HIT POINTS (HP)</label><div class="derived-attr-input"><input type="number" id="hp-current" min="0"> / <input type="number" id="hp-max" value="0" readonly></div></div> <div><label data-tooltip="Armor Points: A temporary pool of Hit Points provided by body armor. Damage is subtracted from AP first. When AP is depleted, the armor is destroyed.">ARMOR (AP)</label><div class="derived-attr-input armor-controls"><button type="button" id="armor-btn" onclick="toggleArmor()">△</button><input type="number" id="armor-points" class="hidden" min="0" oninput="validateArmorPoints(event)"></div></div> <div><label data-tooltip="Willpower Points: A resource spent to perform difficult actions, push through fear, or use certain advanced skills.">WILLPOWER (WP)</label><div class="derived-attr-input"><input type="number" id="wp-current" min="0"> / <input type="number" id="wp-max" value="0" readonly></div></div> <div><label data-tooltip="Sanity: Represents mental stability. Severe trauma and exposure to unnatural events cause SAN loss. Significant loss can lead to psychological disorders.">SANITY (SAN)</label><div class="derived-attr-input"><input type="number" id="san-current" min="0" oninput="checkBreakingPoint()"> / <input type="number" id="san-max" value="0" readonly></div></div> <div><label data-tooltip="Breaking Point: A threshold equal to SAN minus POW. If an agent's current SAN drops to or below their BP, they suffer a mental breakdown and must acquire a new disorder.">BREAKING PT</label><input type="number" id="bp" readonly></div> </div> <div id="bp-warning" class="hidden"> SAN is at or below Breaking Point! Agent must acquire a new disorder. <button type="button" onclick="acknowledgeBreakingPoint()">ACK & RESET BP</button> </div> </section> <section class="form-section"> <h2 data-tooltip="Represents an agent's crucial connections to their life outside the Program. The number of Bonds is determined by Charisma. An agent can choose to sacrifice points from a Bond's score to negate an equal amount of SAN loss, representing the strain placed on that relationship.">BONDS</h2> <div id="bonds-container"></div> </section> <section class="form-section"> <h2 style="text-align: center; border:none; margin-bottom: 5px;" data-tooltip="Each checkmark represents a significant traumatic experience. Checking all three boxes in a category means the agent has become Adapted. They now take reduced SAN loss from that type of trauma, but suffer a permanent psychological scar.">PSYCH PROFILE</h2> <div class="san-loss-container"> <div class="san-loss-group"> <div class="san-loss-label"> <label>VIOLENCE</label><span id="violence-adapted" class="adapted-status hidden">ADAPTED</span> </div> <div> <label class="styled-checkbox"><input type="checkbox" id="violence1" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="violence2" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="violence3" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> </div> </div> <div class="san-loss-group"> <div class="san-loss-label"> <label>HELPLESSNESS</label><span id="helplessness-adapted" class="adapted-status hidden">ADAPTED</span> </div> <div> <label class="styled-checkbox"><input type="checkbox" id="helplessness1" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="helplessness2" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="helplessness3" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> </div> </div> </div> </section> </div> <div class="col-2"> <section class="form-section" style="flex-grow: 1; display: flex; flex-direction: column;"> <div style="display: flex; justify-content: space-between; align-items: center;"><h2 style="border-bottom: none;">SKILLS <span id="skill-points-counter" class="hidden" style="font-weight: normal; font-size: 0.8em; vertical-align: middle;"></span></h2><div><button type="button" id="lock-skills-btn" class="hidden" onclick="lockSkills()">LOCK SKILLS</button><button type="button" id="roll-skills-btn" class="hidden" onclick="startSkillImprovement()">Roll 1d4s</button></div></div> <div id="skills-container" style="display: flex; flex-direction: column; gap: 10px; flex-grow: 1;"></div> </section> </div> </div>
        <section class="form-section"> <h2>WEAPONS & EQUIPMENT</h2> <label for="gear">ARMOR AND GEAR</label> <textarea id="gear"></textarea> <label for="notes-field" style="margin-top:10px;">NOTES</label> <textarea id="notes-field"></textarea> <h3 style="margin-top: 15px;">WEAPONS</h3> <table id="weapons-table" style="width:100%; border-collapse: collapse;"> <thead> <tr><th>NAME</th><th>SKILL%</th><th>RANGE</th><th>DMG</th><th data-tooltip="Armor Piercing. The weapon ignores this many points of the target's Armor Points (AP). For example, an attack with 5 AP against a target with 8 AP armor would only be reduced by 3 points of damage.">AP</th><th data-tooltip="On a successful hit, roll 1d100. If the roll is less than or equal to the Lethality %, the target is killed instantly (unless immune). If the roll is higher, add the two digits of the d100 roll together for damage.">LETHALITY</th><th>AMMO</th><th></th></tr> </thead> <tbody id="weapons-body"></tbody> </table> <button type="button" onclick="openWeaponModal()">+ ADD WEAPON</button> </section>
    `;

    // --- CONFIG & STATE ---
    const ADMIN_PASSWORD_HASH = 'dmFsa3lyaWU=';
    let isAdmin = false;
    let statsUnlocked = false;
    let isArmorActive = false;
    let currentArmorPoints = 0;
    let isFormDirty = false;
    let isSkillSetupMode = false;
    let totalBaseSkillPoints = 0;
    const SKILL_POINTS_BUDGET = 300;
    const MAX_STAT_POINTS = 25, MIN_STAT_VALUE = 8, MAX_STAT_VALUE = 18;
    // START: MODIFIED DATA
    const branches = { "NSA": "intelligence", "CIA": "intelligence", "Army": "army", "Navy": "navy", "Marines": "marines", "Air Force": "airforce", "Undesignated": "undesignated" };
    const ranks = { 
        intelligence: [ {name: "Forced Asset", grade: "FA"}, {name: "Case Officer", grade: "GS-11"}, {name: "Supervisory CO", grade: "GS-14", adminOnly: true}, {name: "Chief of Station", grade: "SIS-2", adminOnly: true} ], 
        army: [ {name: "Sergeant", grade: "E-5"}, {name: "Staff Sergeant", grade: "E-6", adminOnly: true}, {name: "Sergeant First Class", grade: "E-7", adminOnly: true}, {name: "Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ], 
        marines: [ {name: "Sergeant", grade: "E-5"}, {name: "Staff Sergeant", grade: "E-6", adminOnly: true}, {name: "Gunnery Sergeant", grade: "E-7", adminOnly: true}, {name: "Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ], 
        navy: [ {name: "Petty Officer 2nd Class", grade: "E-5"}, {name: "Petty Officer 1st Class", grade: "E-6", adminOnly: true}, {name: "Chief Petty Officer", grade: "E-7", adminOnly: true}, {name: "Senior Chief Petty Officer", grade: "E-8", adminOnly: true}, {name: "Ensign", grade: "O-1", adminOnly: true}, {name: "Lieutenant (JG)", grade: "O-2", adminOnly: true}, {name: "Lieutenant", grade: "O-3", adminOnly: true} ], 
        airforce: [ {name: "Staff Sergeant", grade: "E-5"}, {name: "Technical Sergeant", grade: "E-6", adminOnly: true}, {name: "Master Sergeant", grade: "E-7", adminOnly: true}, {name: "Senior Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ],
        undesignated: [ {name: "Civilian Asset", grade: "N/A"} ]
    };
    // END: MODIFIED DATA
    const stats = ["STR", "DEX", "CON", "INT", "POW", "CHA"];
    const simpleSkills = [ "Accounting", "Alertness", "Artillery", "Athletics", "Criminology", "Disguise", "Dodge", "Drive", "Firearms", "First Aid", "Forensics", "Heavy Machinery", "Heavy Weapons", "Human Studies", "HUMINT", "Leadership", "Medicine", "Melee Weapons", "Navigate", "Paranormal", "Persuade", "Pharmacy", "Psychotherapy", "Ride", "Search", "SIGINT", "Stealth", "Support Int.", "Surgery", "Survival", "Swim", "Tech Procedures", "Unarmed Combat" ].sort();
    const baseSkillValues = { 'Accounting': 10, 'Alertness': 20, 'Artillery': 0, 'Athletics': 30, 'Criminology': 0, 'Disguise': 10, 'Dodge': 30, 'Drive': 20, 'Firearms': 20, 'First Aid': 10, 'Forensics': 0, 'Heavy Machinery': 10, 'Heavy Weapons': 10, 'Human Studies': 10, 'HUMINT': 0, 'Leadership': 0, 'Medicine': 0, 'Melee Weapons': 30, 'Navigate': 10, 'Paranormal': 10, 'Persuade': 20, 'Pharmacy': 0, 'Psychotherapy': 10, 'Ride': 10, 'Search': 20, 'SIGINT': 0, 'Stealth': 20, 'Support Int.': 0, 'Surgery': 0, 'Survival': 10, 'Swim': 20, 'Tech Procedures': 20, 'Unarmed Combat': 40 };
    const statDescriptions = { STR: { 3: "Frail", 6: "Below Average", 9: "Average", 12: "Strong", 15: "Powerful", 18: "Peak Human" }, DEX: { 3: "Clumsy", 6: "Slow", 9: "Average", 12: "Agile", 15: "Nimble", 18: "Lightning Reflexes" }, CON: { 3: "Sickly", 6: "Frail", 9: "Average", 12: "Hardy", 15: "Tough", 18: "Superhuman Endurance" }, INT: { 3: "Dim", 6: "Slow Learner", 9: "Average", 12: "Sharp", 15: "Brilliant", 18: "Genius" }, POW: { 3: "Weak-willed", 6: "Hesitant", 9: "Average", 12: "Determined", 15: "Indomitable", 18: "Unyielding Will" }, CHA: { 3: "Unlikable", 6: "Awkward", 9: "Average", 12: "Likable", 15: "Charismatic", 18: "Compelling Presence" } };
    const tooltipData = {
        'STR': 'Strength: Governs physical power, melee damage, lifting capacity, and athletic tasks involving raw force.',
        'DEX': 'Dexterity: Governs agility, reflexes, coordination, and tasks requiring precision and speed, like aiming and dodging.',
        'CON': 'Constitution: Governs health, endurance, and resilience against physical hardship, poison, and disease. Determines Hit Points.',
        'INT': 'Intelligence: Governs reasoning, memory, and analytical skills. The base value for many academic and technical skills.',
        'POW': 'Power: Governs willpower, mental resilience, and the ability to resist fear and psychological manipulation. Determines Sanity and Willpower Points.',
        'CHA': 'Charisma: Governs personality, persuasion, and leadership. Determines the number of Bonds an agent can maintain.'
    };
    
    // --- CONTENT LOADING ---
    function loadContentPanels() {
        fetch('rules.html')
            .then(response => response.ok ? response.text() : Promise.reject('rules.html not found'))
            .then(html => { document.querySelector('#rules-view .content-menu').innerHTML = html; })
            .catch(error => console.error('Error loading rules:', error));

        fetch('about.html')
            .then(response => response.ok ? response.text() : Promise.reject('about.html not found'))
            .then(html => { document.querySelector('#about-view .content-menu').innerHTML = html; })
            .catch(error => console.error('Error loading about page:', error));
    }

    function loadDailyHistory() {
        const contentEl = document.getElementById('history-content');
        const titleEl = document.getElementById('history-title');
        const imageEl = document.getElementById('history-image');
        const today = new Date();
        const month = today.getMonth() + 1;
        const day = today.getDate();
        const dateString = `${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}-${today.getFullYear()}`;
        titleEl.textContent = `THIS DAY IN HISTORY // ${dateString}`;
        fetch('history.json')
            .then(response => { if (!response.ok) { throw new Error(`Network response was not ok.`); } return response.json(); })
            .then(data => {
                const todayEvent = data.find(item => item.month === month && item.day === day);
                if (todayEvent) {
                    contentEl.textContent = todayEvent.event;
                    if (todayEvent.image_url) { imageEl.src = todayEvent.image_url; imageEl.alt = todayEvent.image_alt || "Historical event"; imageEl.style.display = 'block'; } else { imageEl.style.display = 'none'; }
                } else { contentEl.textContent = 'No significant military events recorded for this date.'; imageEl.style.display = 'none'; }
            })
            .catch(error => { console.error('Error fetching historical data:', error); contentEl.textContent = 'Failed to load historical data.'; imageEl.style.display = 'none'; });
    }

    // --- INITIALIZATION ---
    window.onload = () => {
        totalBaseSkillPoints = Object.values(baseSkillValues).reduce((a, b) => a + b, 0);
        loadContentPanels();
        populateBranches(); populateStats(); populateSkills(); loadSavedSheets(); applySavedTheme(); setupTooltips(); loadDailyHistory(); populateWeaponCategories();
        document.getElementById('settings-btn').addEventListener('click', () => { document.getElementById('settings-menu').style.display = document.getElementById('settings-menu').style.display === 'block' ? 'none' : 'block'; });
        document.getElementById('lock-branch-rank-checkbox').addEventListener('change', updateBranchRankLockState);
        document.getElementById('sheet-form').addEventListener('input', () => { isFormDirty = true; if(isSkillSetupMode) updateSkillPointsCounter(); });
        document.getElementById('skills-container').addEventListener('input', updateLinkedWeaponStats);
        document.getElementById('skills-container').addEventListener('change', (event) => { if (event.target.type === 'checkbox') { updateRollSkillsButtonVisibility(); } });
        window.addEventListener('beforeunload', (e) => { if (isFormDirty) { e.preventDefault(); e.returnValue = ''; } });
    };
    
    function resetForm() {
        document.getElementById('sheet-form').reset();
        document.getElementById('character-id').value = `char_${Date.now()}`;
        document.getElementById('bonds-container').innerHTML = '';
        document.getElementById('weapons-body').innerHTML = '';
        deactivateArmor();
        populateSkills(); populateStats(); addDefaultUnarmed(); updateAllCalculations(); checkAdaptedStatus();
        document.getElementById('lock-branch-rank-checkbox').checked = false;
        updateBranchRankLockState();
        updateRollSkillsButtonVisibility();
        isFormDirty = false;
        setSkillInputMax(80);
        isSkillSetupMode = true;
        updateSkillPointsCounter();
        setupTooltips();
    }
    
    // START: MODIFIED FUNCTION
    function populateBranches() {
        const branchSelect = document.getElementById('branch');
        const currentBranchValue = branchSelect.value; // Store the current selection

        const branchList = Object.keys(branches);
        let optionsHTML = '';

        branchList.forEach(b => {
            // Only add the Undesignated option if in admin mode
            if (b === "Undesignated" && !isAdmin) {
                return; // skip this iteration
            }
            optionsHTML += `<option value="${b}">${b.toUpperCase()}</option>`;
        });

        branchSelect.innerHTML = optionsHTML;

        // If the previously selected branch is still available in the new list, re-select it.
        // Otherwise, the browser will default to the first option, which is what we want
        // if the current selection (e.g., Undesignated) was removed.
        if (branchSelect.querySelector(`option[value="${currentBranchValue}"]`)) {
            branchSelect.value = currentBranchValue;
        }
    }
    // END: MODIFIED FUNCTION

    function populateStats() { document.getElementById('stats-container').innerHTML = stats.map(stat => `<div class="stat-item"><div class="stat-header"><label data-tooltip="${tooltipData[stat]}">${stat}</label><button type="button" onclick="changeStat('${stat}', -1)">-</button><input type="number" id="${stat}" value="${MIN_STAT_VALUE}" readonly oninput="updateAllCalculations()"><button type="button" onclick="changeStat('${stat}', 1)">+</button><span id="${stat}x5">x5: 0</span></div><div id="${stat}-desc" class="stat-desc"></div></div>`).join(''); }
    function populateSkills() { const container = document.getElementById('skills-container'); let html = '<div class="grid-container" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); grid-auto-rows: min-content; align-items: start;">'; html += simpleSkills.map(skill => { const baseValue = baseSkillValues[skill] || 0; const skillId = `skill-${skill.replace(/\s+/g, '-')}`; return `<div class="skill-item-simple"><label class="styled-checkbox"><input type="checkbox" id="check-${skillId}"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label for="${skillId}" data-tooltip="${skillDescriptions[skill] || ''}">${skill.toUpperCase()}</label><input type="number" id="${skillId}" min="0" max="100" value="${baseValue}"></div></div>`; }).join(''); html += '</div>'; html += '<div class="grid-container" style="grid-template-columns: 1fr 1fr; align-items: stretch; margin-top: 10px;">'; html += `<div><div class="sub-skill-group"> <h3 class="sub-skill-header" data-tooltip="${skillDescriptions['Military Science']}">Military Science</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-land"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Military Science']}">Land</label><input type="number" id="skill-milsci-land" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-sea"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Military Science']}">Sea</label><input type="number" id="skill-milsci-sea" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-air"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Military Science']}">Air</label><input type="number" id="skill-milsci-air" value="0" min="0" max="100"></div></div> </div><div class="sub-skill-group" style="margin-top: 10px;"> <h3 class="sub-skill-header" data-tooltip="${skillDescriptions['Pilot']}">Pilot</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-airplane"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Pilot']}">Airplane</label><input type="number" id="skill-pilot-airplane" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-helicopter"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Pilot']}">Helicopter</label><input type="number" id="skill-pilot-helicopter" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-boat"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Pilot']}">Boat</label><input type="number" id="skill-pilot-boat" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-rc"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Pilot']}">RC/Drone</label><input type="number" id="skill-pilot-rc" value="0" min="0" max="100"></div></div> </div></div>`; html += `<div class="sub-skill-group"> <h3 class="sub-skill-header" data-tooltip="${skillDescriptions['Science']}">Science</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-biology"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Science']}">Biology</label><input type="number" id="skill-science-biology" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-chemistry"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Science']}">Chemistry</label><input type="number" id="skill-science-chemistry" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-mathematics"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Science']}">Mathematics</label><input type="number" id="skill-science-mathematics" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-physics"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-tooltip="${skillDescriptions['Science']}">Physics</label><input type="number" id="skill-science-physics" value="0" min="0" max="100"></div></div> </div>`; html += '</div>'; html += '<div class="grid-container" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">'; html += `<div class="sub-skill-group"> <div class="sub-skill-header-flex"><h3 class="sub-skill-header" data-tooltip="${skillDescriptions['Craft']}">Craft</h3><button type="button" onclick="addCraftSkill()">+ ADD</button></div> <div id="craft-skills-container"></div> </div>`; html += `<div class="sub-skill-group"> <div class="sub-skill-header-flex"><h3 class="sub-skill-header" data-tooltip="Skill in a non-native language. 10% is basic phrases. 30% is conversational. 50% is fluent. 80% is indistinguishable from a native speaker. 99% represents an academic, PhD-level understanding of the language's linguistics and history.">Foreign Language</h3><button type="button" onclick="addLanguageSkill()">+ ADD</button></div> <div id="language-skills-container"></div> </div>`; html += '</div>'; container.innerHTML = html; }

    // --- TOOLTIP MANAGEMENT ---
    function setupTooltips() {
        const tooltip = document.getElementById('app-tooltip');
        document.querySelectorAll('[data-tooltip]').forEach(element => {
            element.addEventListener('mouseover', (e) => {
                const tooltipText = e.currentTarget.dataset.tooltip;
                if (tooltipText) {
                    tooltip.innerHTML = tooltipText;
                    tooltip.classList.remove('hidden');
                }
            });
            element.addEventListener('mousemove', (e) => {
                const tooltipWidth = tooltip.offsetWidth;
                const tooltipHeight = tooltip.offsetHeight;
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const padding = 20;

                let newX = e.pageX + padding;
                let newY = e.pageY + padding;

                if (newX + tooltipWidth > windowWidth) {
                    newX = e.pageX - tooltipWidth - padding;
                }
                if (newY + tooltipHeight > windowHeight) {
                    newY = e.pageY - tooltipHeight - padding;
                }
                if (newX < 0) newX = padding;
                if (newY < 0) newY = padding;

                tooltip.style.left = `${newX}px`;
                tooltip.style.top = `${newY}px`;
            });
            element.addEventListener('mouseout', () => {
                tooltip.classList.add('hidden');
            });
        });
    }

    // --- THEME MANAGEMENT ---
    function changeTheme(theme) { localStorage.setItem('socom_theme', theme); applyCurrentTheme(theme); }
    function applyCurrentTheme(theme) { document.body.className = ''; if (isAdmin) document.body.classList.add('admin-mode'); if (theme !== 'default') document.body.classList.add(theme + '-theme'); }
    function applySavedTheme() { const savedTheme = localStorage.getItem('socom_theme'); if (savedTheme) applyCurrentTheme(savedTheme); else applyAutoTheme(); }
    function applyAutoTheme() {
        const savedTheme = localStorage.getItem('socom_theme');
        if (savedTheme && savedTheme !== 'default' && savedTheme !== 'army') { applyCurrentTheme(savedTheme); return; } 
        document.body.className = ''; if (isAdmin) document.body.classList.add('admin-mode');
        const rankSelect = document.getElementById('rank');
        const grade = rankSelect.options[rankSelect.selectedIndex]?.dataset.grade;
        const officerGrades = ['O-1','O-2','O-3','GS-14','SIS-2'];
        if (grade && officerGrades.includes(grade)) { document.body.classList.add('officer-theme'); return; }
        const branchType = branches[document.getElementById('branch').value];
        if (branchType && branchType !== 'army') { document.body.classList.add(branchType + '-theme'); }
    }

    // --- VIEW MANAGEMENT & UI/CALCS ---
    function showView(viewId) { document.querySelectorAll('main').forEach(el => el.classList.add('hidden')); const viewEl = document.getElementById(`${viewId}-view`); if(viewEl){ viewEl.classList.remove('hidden'); if(viewId === 'loader') loadSavedSheets();} }
    function confirmReturnToMenu() {
        if (isFormDirty) {
            if (confirm("UNSAVED DATA DETECTED. Returning to the main menu will discard all changes. Proceed?")) {
                isFormDirty = false;
                showView('main');
            }
        } else {
            showView('main');
        }
    }
    
    // START: MODIFIED/ADDED FUNCTIONS
    function toggleAdminMode() {
        if (!isAdmin) {
            const pass = prompt("Enter Admin Password:");
            if (btoa(pass) === ADMIN_PASSWORD_HASH) {
                isAdmin = true;
                alert("ADMIN MODE ACTIVATED.");
            } else {
                if (pass !== null && pass !== "") alert("ACCESS DENIED.");
                return;
            }
        } else {
            isAdmin = false;
            alert("ADMIN MODE DEACTIVATED.");
        }
        document.body.classList.toggle('admin-mode', isAdmin);
        document.getElementById('lock-branch-rank-container').classList.toggle('hidden', !isAdmin);
        document.getElementById('toggle-stats-lock-btn').classList.toggle('hidden', !isAdmin);
        
        populateBranches(); // Re-populate branches based on admin status
        updateRanks(); // THEN update ranks based on the (potentially new) branch selection
    }

    function updateBranchRankLockState() {
        const isLocked = document.getElementById('lock-branch-rank-checkbox').checked;
        document.getElementById('branch').disabled = isLocked;
        document.getElementById('rank').disabled = isLocked;
    }

    function screenshotPage(event) {
        event.preventDefault();
        const sheet = document.getElementById('character-sheet-container');
        const name = document.getElementById('full-name').value || "Unnamed_Agent";
        alert("Generating screenshot...");
        html2canvas(sheet, {
            scale: 2,
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color'),
            onclone: (clonedDoc) => {
                clonedDoc.getElementById('character-sheet-container').style.backgroundColor = getComputedStyle(document.body).getPropertyValue('--bg-color');
            }
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `${name.replace(/[^\w\s]/gi, '').replace(/ /g, '_')}_SOCOM_Sheet.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            link.remove();
        }).catch(err => {
            console.error("Screenshot failed:", err);
            alert("Screenshot failed. See console for details.");
        });
    }

    function toggleStatsLock() {
        if (!isAdmin) return;
        statsUnlocked = !statsUnlocked;
        document.getElementById('toggle-stats-lock-btn').textContent = statsUnlocked ? "LOCK STATS" : "FORCE STATS";
        stats.forEach(stat => {
            document.getElementById(stat).readOnly = !statsUnlocked;
        });
        if (statsUnlocked) {
            alert("WARNING: Core attributes are now unlocked. You can manually set any value. This may unbalance the character.");
        } else {
            updateAllCalculations();
        }
    }

    function updateRanks() {
        const branchSelect = document.getElementById('branch');
        const rankSelect = document.getElementById('rank');
        const isLocked = document.getElementById('lock-branch-rank-checkbox').checked;
        
        const currentRankValue = rankSelect.value;
        
        const branchKey = branchSelect.value;
        const rankType = branches[branchKey] || 'intelligence';
        const allRanksForBranch = ranks[rankType] || [];

        // Issue 1 Fix: Show all ranks, but disable admin-only ones for non-admins.
        const rankOptions = allRanksForBranch.map(r => {
            const isDisabled = r.adminOnly && !isAdmin;
            const label = `${r.name} (${r.grade})${r.adminOnly ? ' 🔒' : ''}`;
            return `<option value="${r.name}" data-grade="${r.grade}" ${isDisabled ? 'disabled' : ''}>${label}</option>`;
        }).join('');
        
        rankSelect.innerHTML = rankOptions;
        
        // Issue 2 Fix: Preserve locked admin rank when exiting admin mode, and handle resets correctly.
        const optionForCurrentValue = rankSelect.querySelector(`option[value="${currentRankValue}"]`);

        if (isLocked) {
             // If locked, just force the value back. This handles the case of exiting admin mode with a locked admin rank.
             if (optionForCurrentValue) {
                rankSelect.value = currentRankValue;
             }
        } else if (!optionForCurrentValue || optionForCurrentValue.disabled) {
            // If the old selection is now disabled (and not locked), or it doesn't exist anymore (branch change), reset.
            const firstEnabledRank = allRanksForBranch.find(r => !r.adminOnly);
            if (firstEnabledRank) {
                rankSelect.value = firstEnabledRank.name;
            }
        } else {
            // Otherwise, the selection is still valid and enabled, so keep it.
            rankSelect.value = currentRankValue;
        }

        applyAutoTheme();
    }
    // END: MODIFIED/ADDED FUNCTIONS

    function changeStat(stat, delta) { if (statsUnlocked) return; const input = document.getElementById(stat); let pointsSpent = stats.reduce((acc, s) => acc + (parseInt(document.getElementById(s).value) - MIN_STAT_VALUE), 0); let currentValue = parseInt(input.value); if (delta > 0 && pointsSpent < MAX_STAT_POINTS && currentValue < MAX_STAT_VALUE) { input.value = currentValue + 1; } else if (delta < 0 && currentValue > MIN_STAT_VALUE) { input.value = currentValue - 1; } updateAllCalculations(); }
    function updateAllCalculations() { let pointsSpent = 0; stats.forEach(stat => { const value = parseInt(document.getElementById(stat).value); pointsSpent += (value - MIN_STAT_VALUE); document.getElementById(`${stat}x5`).textContent = `x5: ${value * 5}`; document.getElementById(`${stat}-desc`).textContent = getStatDescription(stat, value); }); document.getElementById('stat-points-remaining').textContent = MAX_STAT_POINTS - pointsSpent; updateDerivedAttributes(); updateBondSlots(); updateBondScores(); updateLinkedWeaponStats(); }
    function updateDerivedAttributes() {
        const str = parseInt(document.getElementById('STR').value), con = parseInt(document.getElementById('CON').value), pow = parseInt(document.getElementById('POW').value);
        const hpMaxInput = document.getElementById('hp-max'), wpMaxInput = document.getElementById('wp-max'), sanMaxInput = document.getElementById('san-max'), bpInput = document.getElementById('bp');
        if (!isAdmin) { hpMaxInput.value = Math.ceil((str + con) / 2); wpMaxInput.value = pow; sanMaxInput.value = pow * 5; bpInput.value = Math.max(0, parseInt(sanMaxInput.value) - pow); }
        const hpCurrent = document.getElementById('hp-current'); hpCurrent.max = parseInt(hpMaxInput.value); if(!hpCurrent.value || parseInt(hpCurrent.value) > hpCurrent.max) hpCurrent.value = hpCurrent.max;
        const wpCurrent = document.getElementById('wp-current'); wpCurrent.max = parseInt(wpMaxInput.value); if(!wpCurrent.value || parseInt(wpCurrent.value) > wpCurrent.max) wpCurrent.value = wpCurrent.max;
        const sanCurrent = document.getElementById('san-current'); sanCurrent.max = parseInt(sanMaxInput.value); if(!sanCurrent.value || parseInt(sanCurrent.value) > sanCurrent.max) sanCurrent.value = sanCurrent.max;
        checkBreakingPoint();
    }
    function checkBreakingPoint() { const sanCurrent = parseInt(document.getElementById('san-current').value), bp = parseInt(document.getElementById('bp').value); document.getElementById('bp-warning').classList.toggle('hidden', sanCurrent > bp); }
    function acknowledgeBreakingPoint() { document.getElementById('bp').value = Math.max(0, parseInt(document.getElementById('san-current').value) - parseInt(document.getElementById('POW').value)); document.getElementById('bp-warning').classList.add('hidden'); }
    function getStatDescription(stat, val) { const tiers = statDescriptions[stat]; let desc = tiers[val] || ''; for (const key in tiers) { if (val >= key) desc = tiers[key]; } return `// ${desc}`; }
    
    // --- SKILL IMPROVEMENT & POINT SYSTEM ---
    function setSkillInputMax(maxValue) { const skillInputs = document.querySelectorAll('#skills-container input[type="number"]'); skillInputs.forEach(input => { input.max = maxValue; if (parseInt(input.value) > maxValue) { input.value = maxValue; } }); }
    function updateSkillPointsCounter() {
        const counterEl = document.getElementById('skill-points-counter'), lockBtn = document.getElementById('lock-skills-btn');
        if (!isSkillSetupMode) { counterEl.classList.add('hidden'); lockBtn.classList.add('hidden'); return; }
        counterEl.classList.remove('hidden'); lockBtn.classList.remove('hidden');
        const skillInputs = document.querySelectorAll('#skills-container input[type="number"]'); let currentPointsSum = 0;
        skillInputs.forEach(input => { currentPointsSum += parseInt(input.value, 10) || 0; });
        const pointsSpent = currentPointsSum - totalBaseSkillPoints;
        counterEl.textContent = `(${pointsSpent} / ${SKILL_POINTS_BUDGET} PTS)`;
        lockBtn.disabled = pointsSpent !== SKILL_POINTS_BUDGET;
        if (pointsSpent > SKILL_POINTS_BUDGET) { counterEl.style.color = 'var(--danger-color)'; } else if (pointsSpent === SKILL_POINTS_BUDGET) { counterEl.style.color = 'var(--accent-color)'; } else { counterEl.style.color = 'inherit'; }
    }
    function lockSkills() { if (confirm("You have allocated exactly 300 skill points. This will finalize the skill setup for this character. Are you sure?")) { isSkillSetupMode = false; setSkillInputMax(100); updateSkillPointsCounter(); isFormDirty = true; } }
    function updateRollSkillsButtonVisibility() { const checkedSkills = document.querySelectorAll('#skills-container input[type="checkbox"]:checked'); document.getElementById('roll-skills-btn').classList.toggle('hidden', checkedSkills.length === 0); }
    function startSkillImprovement() { document.getElementById('skill-roll-modal').classList.remove('hidden'); document.getElementById('skill-roll-prompt').classList.remove('hidden'); document.getElementById('skill-roll-process').classList.add('hidden'); document.getElementById('skill-roll-conclusion').classList.add('hidden'); }
    function closeSkillRollModal() { document.getElementById('skill-roll-modal').classList.add('hidden'); }
    async function executeSkillRolls() {
        const checkedBoxes = Array.from(document.querySelectorAll('#skills-container input[type="checkbox"]:checked')), skillsToRoll = [];
        for (const box of checkedBoxes) {
            const skillItem = box.closest('.skill-item-simple, .sub-skill-item'); if (!skillItem) continue;
            const scoreInput = skillItem.querySelector('input[type="number"]'); let skillName = "Unknown";
            if (skillItem.classList.contains('skill-item-simple')) { skillName = skillItem.querySelector('.skill-label-input label').textContent.trim(); } else { const craftSelect = skillItem.querySelector('select'); const langInput = skillItem.querySelector('input[placeholder="Language"]'); if (craftSelect) { skillName = `Craft: ${craftSelect.value}`; } else if (langInput) { skillName = `Language: ${langInput.value || '(Unnamed)'}`; } else { const group = skillItem.closest('.sub-skill-group'), header = group.querySelector('.sub-skill-header'), subTypeName = skillItem.querySelector('.skill-label-input label').textContent.trim(), headerName = header.textContent.trim(); skillName = `${headerName}: ${subTypeName}`; } }
            const currentScore = parseInt(scoreInput.value, 10);
            if (currentScore >= 99) { alert(`ERROR: Skill "${skillName}" is already at its maximum value (99).`); closeSkillRollModal(); return; }
            skillsToRoll.push({ name: skillName, checkbox: box, input: scoreInput, currentScore: currentScore });
        }
        if (skillsToRoll.length === 0) { closeSkillRollModal(); return; }
        document.getElementById('skill-roll-prompt').classList.add('hidden'); document.getElementById('skill-roll-process').classList.remove('hidden');
        const skillNameEl = document.getElementById('rolling-skill-name'), diceEl = document.getElementById('dice-animation'), resultEl = document.getElementById('roll-result-text');
        for (const skill of skillsToRoll) {
            skillNameEl.textContent = `ROLLING: ${skill.name.toUpperCase()}`; resultEl.textContent = '';
            const animationInterval = setInterval(() => { diceEl.textContent = Math.floor(Math.random() * 4) + 1; }, 100);
            await new Promise(resolve => setTimeout(resolve, 1000)); clearInterval(animationInterval);
            const roll = Math.floor(Math.random() * 4) + 1; diceEl.textContent = roll;
            const newScore = Math.min(99, skill.currentScore + roll); skill.input.value = newScore;
            resultEl.textContent = `Result: +${roll}. New Score: ${newScore}.`; skill.checkbox.checked = false;
            await new Promise(resolve => setTimeout(resolve, 1500));
        }
        document.getElementById('skill-roll-process').classList.add('hidden'); document.getElementById('skill-roll-conclusion').classList.remove('hidden'); updateRollSkillsButtonVisibility();
    }

    // --- INTERACTIVE SECTIONS ---
    function checkAdaptedStatus() { const violenceCount = document.querySelectorAll('#violence1:checked, #violence2:checked, #violence3:checked').length; document.getElementById('violence-adapted').classList.toggle('hidden', violenceCount < 3); const helplessnessCount = document.querySelectorAll('#helplessness1:checked, #helplessness2:checked, #helplessness3:checked').length; document.getElementById('helplessness-adapted').classList.toggle('hidden', helplessnessCount < 3); }
    function addCraftSkill(data = {}){ const container = document.getElementById('craft-skills-container'); const item = document.createElement('div'); item.className = 'sub-skill-item'; const craftTypes = ['Gunsmith', 'Locksmith', 'Mechanic', 'Microelectronics', 'Explosives']; let options = craftTypes.map(c => `<option value="${c}" ${c === data.type ? 'selected' : ''}>${c}</option>`).join(''); const scoreMax = isSkillSetupMode ? 80 : 100; item.innerHTML = `<label class="styled-checkbox"><input type="checkbox" ${data.checked ? 'checked' : ''}><span class="checkbox-visual"></span></label><div class="skill-label-input"><select data-tooltip="${skillDescriptions['Craft']}">${options}</select><input type="number" min="0" max="${scoreMax}" value="${data.score || 0}"></div><button class="remove-btn" onclick="this.parentElement.remove(); if(isSkillSetupMode) updateSkillPointsCounter();">X</button>`; container.appendChild(item); setupTooltips(); if(isSkillSetupMode) updateSkillPointsCounter(); }
    function addLanguageSkill(data = {}){ const container = document.getElementById('language-skills-container'); const item = document.createElement('div'); item.className = 'sub-skill-item'; const scoreMax = isSkillSetupMode ? 80 : 100; item.innerHTML = `<label class="styled-checkbox"><input type="checkbox" ${data.checked ? 'checked' : ''}><span class="checkbox-visual"></span></label><div class="skill-label-input"><input type="text" placeholder="Language" value="${data.lang || ''}"><input type="number" min="0" max="${scoreMax}" value="${data.score || 0}"></div><button class="remove-btn" onclick="this.parentElement.remove(); if(isSkillSetupMode) updateSkillPointsCounter();">X</button>`; container.appendChild(item); if(isSkillSetupMode) updateSkillPointsCounter(); }
    function addBond(data = {}) { const container = document.getElementById('bonds-container'); const item = document.createElement('div'); item.className = 'bond-item'; item.innerHTML = `<input type="text" placeholder="Bond Name" value="${data.name || ''}"><select class="bond-score"></select>`; container.appendChild(item); updateBondScores(); if(data.score) item.querySelector('.bond-score').value = data.score; }
    function updateBondSlots() {
        const cha = parseInt(document.getElementById('CHA').value) || 0;
        const maxBonds = Math.max(1, Math.min(5, Math.floor(cha / 4)));
        const container = document.getElementById('bonds-container');
        const currentBonds = container.querySelectorAll('.bond-item');
        if (currentBonds.length < maxBonds) {
            for(let i=0; i < maxBonds - currentBonds.length; i++) addBond();
        } else if (currentBonds.length > maxBonds) {
            for(let i=0; i < currentBonds.length - maxBonds; i++) container.querySelector('.bond-item:last-child').remove();
        }
    }
    function updateBondScores() { const cha = parseInt(document.getElementById('CHA').value) || 0; document.querySelectorAll('.bond-score').forEach(select => { const currentScore = select.value; let options = ''; for (let i = 0; i <= cha; i++) { options += `<option value="${i}">${i}</option>`; } select.innerHTML = options; select.value = Math.min(currentScore, cha); }); }
    
    // --- WEAPON MANAGEMENT ---
    function addDefaultUnarmed() { const unarmedPreset = weaponPresets["Melee Weapons"][0]; addWeapon(unarmedPreset); }
    function getCalculatedSkill(skillIdentifier) {
        if (!skillIdentifier) return 20;
        const get = (id, fallback) => parseInt(document.getElementById(id)?.value) || fallback;
        switch(skillIdentifier) {
            case 'Unarmed Combat': return get('skill-Unarmed-Combat', 40); case 'Melee Weapons': return get('skill-Melee-Weapons', 30); case 'DEX*5': return (get('DEX', 10) * 5); case 'Firearms': return get('skill-Firearms', 20); case 'Athletics': return get('skill-Athletics', 30); case 'Athletics+20': return Math.min(99, get('skill-Athletics', 30) + 20); case 'Heavy Weapons': return get('skill-Heavy-Weapons', 10);
            case 'Science': const scienceSkills = ['skill-science-biology', 'skill-science-chemistry', 'skill-science-mathematics', 'skill-science-physics']; return Math.max(...scienceSkills.map(id => get(id, 0)), 10);
            default: return parseInt(skillIdentifier) || 20;
        }
    }
    function updateLinkedWeaponStats() {
        document.querySelectorAll('#weapons-body tr').forEach(row => {
            const skillIdentifier = row.dataset.skillIdentifier; if (!skillIdentifier) return;
            const newSkillValue = getCalculatedSkill(skillIdentifier); const skillInput = row.cells[1].querySelector('input'); if (skillInput) skillInput.value = newSkillValue;
            const baseDamage = row.dataset.baseDamage, damageInput = row.cells[3].querySelector('input');
            if ((skillIdentifier === 'Unarmed Combat' || skillIdentifier === 'Melee Weapons') && baseDamage && damageInput) {
                let bonus = 0; if (newSkillValue > 90) bonus = 3; else if (newSkillValue > 75) bonus = 2; else if (newSkillValue > 50) bonus = 1;
                if (bonus > 0) damageInput.value = `${baseDamage.split(/[-+]/)[0].trim()}+${bonus}`; else damageInput.value = baseDamage;
            }
        });
    }
    function addWeapon(preset, closeModal = false) {
        const newRow = document.getElementById('weapons-body').insertRow();
        const data = { name: '', skill: '', range: '', dmg: '', ap: '', lethality: '', ammoC: '', ammoM: '', ...preset };
        if (data.skillIdentifier) data.skill = getCalculatedSkill(data.skillIdentifier);
        newRow.dataset.skillIdentifier = data.skillIdentifier || ''; newRow.dataset.baseDamage = data.dmg || '';
        newRow.innerHTML = `<td><input type="text" value="${data.name}"></td><td><input type="number" min="0" max="99" value="${data.skill}"></td><td><div class="input-group"><input type="number" min="0" value="${data.range}"><span class="input-group-addon">m</span></div></td><td><input type="text" value="${data.dmg}"></td><td><input type="text" value="${data.ap}"></td><td><div class="input-group"><input type="number" min="0" max="100" value="${data.lethality}"><span class="input-group-addon">%</span></div></td><td class="ammo-cell"><div class="derived-attr-input"><input type="number" min="0" value="${data.ammoC || ''}"> / <input type="number" min="0" value="${data.ammoM || ''}"></div></td><td><button type="button" class="remove-btn" onclick="this.closest('tr').remove()">X</button></td>`;
        if (closeModal) closeWeaponModal();
        updateLinkedWeaponStats();
    }

    // --- MODALS (WEAPON, ARMOR) ---
    function openWeaponModal() { document.getElementById('weapon-preset-modal').classList.remove('hidden'); populateWeaponPresets(); }
    function closeWeaponModal() { document.getElementById('weapon-preset-modal').classList.add('hidden'); }
    function populateWeaponCategories() { const select = document.getElementById('weapon-category-select'); select.innerHTML = Object.keys(weaponPresets).map(cat => `<option value="${cat}">${cat.toUpperCase()}</option>`).join(''); }
    function populateWeaponPresets() {
        const category = document.getElementById('weapon-category-select').value, list = document.getElementById('weapon-preset-list');
        if (!weaponPresets[category]) { list.innerHTML = ''; return; }
        list.innerHTML = weaponPresets[category].map(preset => `<li class="preset-item"><div class="preset-info"><h4>${preset.name} <span class="expense-tag">(${preset.expense})</span></h4>${preset.desc ? `<p>${preset.desc}</p>` : ''}${preset.examples ? `<small>${preset.examples}</small>` : ''}</div><button onclick='addWeapon(${JSON.stringify(preset)}, true)'>SELECT</button></li>`).join('');
    }
    function toggleArmor() { if (isArmorActive) deactivateArmor(); else openArmorModal(); }
    function openArmorModal() { populateArmorPresets(); document.getElementById('armor-modal').classList.remove('hidden'); }
    function closeArmorModal() { document.getElementById('armor-modal').classList.add('hidden'); }
    function populateArmorPresets() {
        const list = document.getElementById('armor-preset-list'), helmetCheckbox = document.getElementById('helmet-checkbox');
        list.innerHTML = armorPresets.map(preset => `<li class="preset-item" data-is-bomb-suit="${preset.isBombSuit}"><div class="preset-info"><h4>${preset.name} <span class="expense-tag">(AP: ${preset.ap})</span></h4><p>${preset.desc}</p></div><button onclick='selectArmor(${preset.ap}, ${preset.isBombSuit})'>SELECT</button></li>`).join('');
        document.querySelectorAll('#armor-preset-list .preset-item').forEach(item => { item.addEventListener('mouseover', () => { const isBombSuit = item.getAttribute('data-is-bomb-suit') === 'true'; if (isBombSuit) { helmetCheckbox.checked = false; helmetCheckbox.disabled = true; } else { helmetCheckbox.disabled = false; } }); });
    }
    function selectArmor(baseAP, isBombSuit) {
        const helmetCheckbox = document.getElementById('helmet-checkbox'); let totalAP = baseAP;
        if (helmetCheckbox.checked && !isBombSuit) totalAP += 1;
        isArmorActive = true; currentArmorPoints = totalAP; const apInput = document.getElementById('armor-points'), armorBtn = document.getElementById('armor-btn');
        apInput.value = totalAP; apInput.classList.remove('hidden'); apInput.classList.add('armor-active'); armorBtn.classList.add('armor-active'); closeArmorModal();
    }
    function deactivateArmor() {
        isArmorActive = false; currentArmorPoints = 0; const apInput = document.getElementById('armor-points'), armorBtn = document.getElementById('armor-btn'), helmetCheckbox = document.getElementById('helmet-checkbox');
        apInput.value = 0; apInput.classList.add('hidden'); apInput.classList.remove('armor-active'); armorBtn.classList.remove('armor-active'); helmetCheckbox.checked = false; helmetCheckbox.disabled = false;
    }
    function validateArmorPoints(event) {
        const input = event.target; let value = parseInt(input.value, 10);
        if (isNaN(value) || value < 0) value = currentArmorPoints;
        if (value > currentArmorPoints) input.value = currentArmorPoints; else currentArmorPoints = value;
        if (currentArmorPoints <= 0) deactivateArmor();
    }

    // --- SAVE/LOAD ---
    function gatherData() {
        const getVal = id => document.getElementById(id).value; const getNum = id => parseInt(getVal(id)) || 0; const getChecked = id => document.getElementById(id).checked;
        const skillsData = {}; document.querySelectorAll('#skills-container input[type="number"]').forEach(i => { const cb = document.getElementById(`check-${i.id}`); skillsData[i.id] = { score: i.value, checked: cb ? cb.checked : false }; });
        const craftSkills = Array.from(document.querySelectorAll('#craft-skills-container .sub-skill-item')).map(item => ({ type: item.querySelector('select').value, score: item.querySelector('input[type="number"]').value, checked: item.querySelector('input[type="checkbox"]').checked }));
        const languageSkills = Array.from(document.querySelectorAll('#language-skills-container .sub-skill-item')).map(item => ({ lang: item.querySelector('input[type="text"]').value, score: item.querySelector('input[type="number"]').value, checked: item.querySelector('input[type="checkbox"]').checked }));
        const bonds = Array.from(document.querySelectorAll('#bonds-container .bond-item')).map(item => ({ name: item.querySelector('input[type="text"]').value, score: item.querySelector('.bond-score').value }));
        const weapons = Array.from(document.querySelectorAll('#weapons-body tr')).map(row => {
            const i = row.querySelectorAll('input');
            return {
                name: i[0].value,
                skill: i[1].value,
                range: i[2].value,
                dmg: i[3].value,
                ap: i[4].value,
                lethality: i[5].value,
                ammoC: i[6].value,
                ammoM: i[7].value,
                skillIdentifier: row.dataset.skillIdentifier,
                baseDamage: row.dataset.baseDamage
            };
        });
        return { id: getVal('character-id'), fullName: getVal('full-name'), branch: getVal('branch'), rank: getVal('rank'), team: getVal('team'), sex: getVal('sex'), dob: getVal('dob'), nationality: getVal('nationality'), employer: getVal('employer'), education: getVal('education'), stats: { STR: getNum('STR'), DEX: getNum('DEX'), CON: getNum('CON'), INT: getNum('INT'), POW: getNum('POW'), CHA: getNum('CHA') }, hpCurrent: getNum('hp-current'), wpCurrent: getNum('wp-current'), sanCurrent: getNum('san-current'), isArmorActive: isArmorActive, currentArmorPoints: currentArmorPoints, psych: { violence1: getChecked('violence1'), violence2: getChecked('violence2'), violence3: getChecked('violence3'), helplessness1: getChecked('helplessness1'), helplessness2: getChecked('helplessness2'), helplessness3: getChecked('helplessness3'), }, skillsData, craftSkills, languageSkills, bonds, weapons, gear: getVal('gear'), notes: getVal('notes-field'), isSkillSetupMode: isSkillSetupMode, branchRankLocked: getChecked('lock-branch-rank-checkbox'), };
    }
    function loadCharacter(data) {
        resetForm();
        const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; }; const setChecked = (id, val) => { if(document.getElementById(id)) document.getElementById(id).checked = val; };
        setVal('character-id', data.id || `char_${Date.now()}`); setVal('full-name', data.fullName); setVal('branch', data.branch); updateRanks(); setVal('rank', data.rank);
        Object.keys(data).forEach(key => setVal(key.replace(/[A-Z]/g, m => '-' + m.toLowerCase()), data[key]));
        for (const stat in data.stats) setVal(stat, data.stats[stat]);
        updateAllCalculations(); // Important to run after stats are set to update bonds etc.
        setVal('hp-current', data.hpCurrent); setVal('wp-current', data.wpCurrent); setVal('san-current', data.sanCurrent);
        if (data.isArmorActive) { selectArmor(data.currentArmorPoints, false); closeArmorModal(); }
        for (const key in data.psych) setChecked(key, data.psych[key]); checkAdaptedStatus();
        document.querySelectorAll('#bonds-container .bond-item').forEach((item, index) => { if (data.bonds && data.bonds[index]) { item.querySelector('input[type="text"]').value = data.bonds[index].name; item.querySelector('.bond-score').value = data.bonds[index].score; } });
        document.getElementById('weapons-body').innerHTML = ''; data.weapons.forEach(weaponData => addWeapon(weaponData));
        for (const id in data.skillsData) { setVal(id, data.skillsData[id].score); setChecked(`check-${id}`, data.skillsData[id].checked); }
        data.craftSkills.forEach(craftData => addCraftSkill(craftData)); data.languageSkills.forEach(languageData => addLanguageSkill(languageData));
        isSkillSetupMode = data.isSkillSetupMode !== false; setSkillInputMax(isSkillSetupMode ? 80 : 100);
        setChecked('lock-branch-rank-checkbox', data.branchRankLocked); updateBranchRankLockState();
        updateSkillPointsCounter(); updateRollSkillsButtonVisibility();
        showView('character-sheet'); isFormDirty = false;
    }
    function saveCharacter() { const data = gatherData(); if (!data.fullName) { alert("Agent's Full Name is required to save."); return; } localStorage.setItem(data.id, JSON.stringify(data)); alert(`AGENT FILE: ${data.fullName.toUpperCase()} SAVED LOCALLY.`); loadSavedSheets(); isFormDirty = false; }
    function exportToJson() { const data = gatherData(); if (!data.fullName) { alert("Agent's Full Name is required to export."); return; } const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${data.fullName.replace(/[^\w\s]/gi, '').replace(/ /g, '_')}_SOCOM.json`; a.click(); URL.revokeObjectURL(a.href); a.remove(); isFormDirty = false; }
    function loadCharacterFromFile(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = e => { try { loadCharacter(JSON.parse(e.target.result)); } catch (err) { alert("Error parsing JSON file."); console.error(err); } }; reader.readAsText(file); event.target.value = null; }
    function loadSavedSheets() {
        const list = document.getElementById('saved-sheets-list'); list.innerHTML = '';
        const sheets = Object.keys(localStorage).filter(key => key.startsWith('char_')).map(key => JSON.parse(localStorage.getItem(key))).filter(data => data && data.id && data.fullName);
        if (sheets.length === 0) { list.innerHTML = '<li>NO LOCAL SAVES FOUND</li>'; } else { sheets.forEach(sheet => { const li = document.createElement('li'); li.innerHTML = `<span>${sheet.fullName.toUpperCase()}</span><div><button onclick="loadCharacterFromStorage('${sheet.id}')">LOAD</button><button class="remove-btn" onclick="deleteSheet('${sheet.id}', '${sheet.fullName.replace(/'/g, "\\'")}')">X</button></div>`; list.appendChild(li); }); }
    }
    function loadCharacterFromStorage(id) { if(isFormDirty && !confirm("You have unsaved changes that will be lost. Load anyway?")) return; const dataString = localStorage.getItem(id); if (dataString) loadCharacter(JSON.parse(dataString)); }
    function deleteSheet(id, name) { if (confirm(`Are you sure you want to delete the file for agent ${name}? This action cannot be undone.`)) { localStorage.removeItem(id); loadSavedSheets(); } }

</script>

</body>
</html>
