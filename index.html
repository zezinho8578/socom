<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.O.C.O.M.</title>
    <link rel="icon" type="image/png" href="https://www.socom.mil/SOF-ATL/PublishingImages/eSOF-Logo.png">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @keyframes flicker { 0%, 100% { opacity: 0.95; } 50% { opacity: 1; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        :root {
            --bg-color: #050805; --scanline-color: rgba(0, 255, 85, 0.1); --text-color: #00ff55;
            --accent-color: #00ff55; --border-color: #00521d; --input-bg: rgba(0, 31, 9, 0.95);
            --danger-color: #ff4141; --danger-bg: rgba(255, 65, 65, 0.15); --container-bg: rgba(0,0,0,0.4);
        }
        body.officer-theme {
            --bg-color: #1a160d; --scanline-color: rgba(255, 196, 0, 0.1); --text-color: #ffc400;
            --accent-color: #ffc400; --border-color: #6d530e; --input-bg: rgba(43, 34, 13, 0.95);
            --container-bg: rgba(10, 8, 3, 0.4);
        }
        body.navy-theme {
            --bg-color: #0a1128; --text-color: #7bceff; --accent-color: #7bceff; 
            --border-color: #00306b; --input-bg: rgba(20, 39, 87, 0.95); --container-bg: rgba(4, 7, 15, 0.4);
        }
        body.marines-theme {
            --bg-color: #1a0b0b; --text-color: #ff5252; --accent-color: #ff5252; 
            --border-color: #6a0d0d; --input-bg: rgba(64, 13, 13, 0.95); --container-bg: rgba(10, 3, 3, 0.4);
        }
        body.airforce-theme {
            --bg-color: #1d1d1f; --text-color: #d1d1d6; --accent-color: #d1d1d6; 
            --border-color: #424245; --input-bg: rgba(50, 50, 56, 0.95); --container-bg: rgba(11, 11, 12, 0.4);
        }
        body.intelligence-theme {
            --bg-color: #000000; --text-color: #ffffff; --accent-color: #ffffff;
            --border-color: #555555; --input-bg: rgba(40, 40, 40, 0.95); --container-bg: rgba(10, 10, 10, 0.4);
        }
        body.plain-theme {
            font-family: Arial, Helvetica, sans-serif;
            --bg-color: #ffffff; --text-color: #000000; --accent-color: #005fcc;
            --border-color: #cccccc; --input-bg: #f9f9f9; --danger-color: #dc3545;
            --container-bg: rgba(248,248,248,0.8);
            text-shadow: none; animation: none;
        }
        body.plain-theme .logo { filter: none; }
        body.plain-theme h1::after { animation: none; content: ''; }
        body.plain-theme button:hover { text-shadow: none; }
        body.plain-theme::before { background: none; }
        body.plain-theme .themed-link { color: var(--accent-color); filter: none; }
        body.plain-theme #skill-tooltip { text-shadow: none; }


        body {
            font-family: 'Courier New', Courier, monospace; margin: 0; background-color: var(--bg-color); color: var(--text-color);
            text-shadow: 0 0 4px var(--accent-color); animation: flicker 0.15s infinite; overflow-y: scroll;
        }
        body::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(0deg, var(--scanline-color) 1px, transparent 1px);
            background-size: 100% 2px; z-index: 100; pointer-events: none;
        }

        .container { position: relative; max-width: 1400px; margin: 10px auto; padding: 10px; border: 1px solid var(--border-color); background: var(--container-bg); }
        .header { display: flex; align-items: center; border-bottom: 1px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 15px; }
        .logo { max-width: 80px; margin-right: 15px; filter: grayscale(100%) brightness(200%) contrast(150%); }

        h1 { font-size: 22px; text-transform: uppercase; }
        h1::after { content: '_'; animation: blink 1s step-end infinite; }
        h2 { font-size: 16px; margin-top: 10px; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; }
        h3, h3.sub-skill-header { font-size: 14px; text-transform: uppercase; border: none; margin: 0 0 5px 0; padding: 0;}

        .main-menu, .loader-menu, .content-menu { text-align: center; padding: 30px; border: 1px solid var(--border-color); margin: 20px; background: var(--input-bg); }
        .content-menu { text-align: left; }
        .content-menu p, .content-menu li { line-height: 1.6; }
        .content-menu ul { padding-left: 20px; list-style-type: none; }
        .content-menu li::before { content: "- "; }
        .themed-link {
            color: inherit;
            text-decoration: underline;
            filter: brightness(130%);
            transition: filter 0.2s;
        }
        .themed-link:hover {
            filter: brightness(160%);
        }

        button, .button {
            background: transparent; color: var(--accent-color); border: 1px solid var(--accent-color);
            padding: 8px 15px; font-size: 14px; cursor: pointer; margin: 5px;
            font-family: 'Courier New', Courier, monospace; text-transform: uppercase;
        }
        body.plain-theme button { font-family: Arial, Helvetica, sans-serif; }
        button:hover, .button:hover { background: var(--accent-color); color: var(--bg-color); text-shadow: none; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }

        .hidden { display: none !important; }

        #character-sheet-container { padding: 10px; border: 1px solid var(--border-color); }
        .form-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; align-items: start;}
        .col-1, .col-2 { display: flex; flex-direction: column; gap: 10px; }
        .col-1 .form-section:last-child { flex-grow: 1; }
        .form-section { background: var(--input-bg); padding: 10px; border: 1px solid var(--border-color); }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        
        label { font-weight: bold; display: block; margin-bottom: 4px; color: var(--accent-color); font-size: 14px; }
        input, select, textarea {
            width: 100%; padding: 6px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color);
            border: 1px solid var(--border-color); font-family: 'Courier New', Courier, monospace;
        }
        body.plain-theme input, body.plain-theme select, body.plain-theme textarea { font-family: Arial, Helvetica, sans-serif; text-shadow: none; }
        textarea { resize: vertical; min-height: 50px; }

        .styled-checkbox { display: flex; align-items: center; cursor: pointer; user-select: none; }
        .styled-checkbox input[type="checkbox"] { display: none; }
        .styled-checkbox .checkbox-visual { width: 14px; height: 14px; border: 1px solid var(--accent-color); display: inline-block; position: relative; flex-shrink: 0; }
        .styled-checkbox input[type="checkbox"]:checked + .checkbox-visual::after { content: 'X'; position: absolute; top: -2px; left: 2px; color: var(--accent-color); }

        .stat-item { padding: 8px; border: 1px solid var(--border-color); }
        .stat-header { display: flex; align-items: center; gap: 8px; }
        .stat-header button { width: 22px; height: 22px; font-size: 14px; line-height: 14px; padding: 0; }
        .stat-desc { font-size: 0.9em; color: #8fbc8f; margin-top: 3px; }
        body.plain-theme .stat-desc { color: #555; text-shadow: none; }

        .derived-attr-input { display: flex; align-items: center; gap: 4px; }
        .derived-attr-input input { width: 50px; text-align: center; }

        .bond-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .remove-btn { font-size: 14px; color: var(--danger-color); cursor: pointer; background: none; border: none; padding: 0 4px; }
        
        .san-loss-container { display: flex; flex-direction: column; gap: 5px; }
        .san-loss-group { display: flex; align-items: center; justify-content: space-between; }
        .san-loss-label { display: flex; align-items: center; gap: 10px; flex-basis: 150px; }
        .san-loss-group div { display: flex; gap: 10px; }
        .adapted-status { color: var(--danger-color); font-weight: bold;}
        body:not(.plain-theme) .adapted-status { text-shadow: 0 0 5px var(--danger-color); }

        #bp-warning { padding: 10px; margin-top: 10px; border: 1px solid var(--danger-color); background-color: var(--danger-bg); color: var(--danger-color); }
        body:not(.plain-theme) #bp-warning { text-shadow: 0 0 5px var(--danger-color); }
        #bp-warning button { border-color: var(--danger-color); color: var(--danger-color); }

        #weapons-table td { padding: 4px; vertical-align: middle;}
        .input-group { display: flex; align-items: center; }
        .input-group-addon { padding: 6px; background: var(--border-color); border: 1px solid var(--border-color); border-left: none; }
        
        #saved-sheets-list li { background: var(--input-bg); padding: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        .sub-skill-group { padding: 8px; border: 1px solid var(--border-color); }
        .sub-skill-item { display: flex; align-items: center; margin-bottom: 5px; gap: 8px; }
        .skill-item-simple { display: flex; align-items: center; gap: 8px; }
        
        .skill-label-input { display: flex; align-items: center; gap: 8px; width: 100%;}
        .skill-label-input label { flex-shrink: 0; flex-basis: 120px; }
        .skill-label-input input { flex-grow: 1; }
        .sub-skill-item .skill-label-input label { flex-basis: 100px; white-space: nowrap; }

        .sub-skill-header-flex { display: flex; justify-content: space-between; align-items: center; }
        .sub-skill-header-flex button { padding: 2px 8px; font-size: 12px; margin: 0; }
        
        .settings-container { position: absolute; top: 10px; right: 10px; }
        #settings-menu { display: none; position: absolute; top: 100%; right: 0; background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px; z-index: 101; }
        #settings-menu button { display: block; width: 100%; text-align: left; }

        #skill-tooltip {
            position: absolute;
            z-index: 110;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px;
            max-width: 350px;
            font-size: 0.9em;
            line-height: 1.4;
            pointer-events: none; /* So it doesn't interfere with mouse events */
        }
        
        option:disabled { color: #666; background: #222; }
        body.plain-theme option:disabled { color: #aaaaaa; background: #eeeeee; }
        body.admin-mode .container { border-color: var(--danger-color); box-shadow: 0 0 10px var(--danger-color); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-color); border: 1px solid var(--accent-color); padding: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }
        .modal-controls { display: flex; gap: 20px; align-items: center; margin-bottom: 15px;}
        .preset-list { list-style: none; padding: 0; margin: 0; }
        .preset-item { border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px;}
        .preset-info { flex-grow: 1; }
        .preset-item h4 { margin: 0 0 8px 0; color: var(--accent-color); }
        .preset-item h4 .expense-tag { font-size: 0.8em; font-weight: normal; margin-left: 8px; opacity: 0.8; }
        .preset-item p { font-size: 0.9em; margin: 0 0 10px 0; line-height: 1.4; }
        .preset-item small { color: #8fbc8f; display: block; margin-top: 5px; }
        body.plain-theme .preset-item small { color: #555; }
        .preset-item button { flex-shrink: 0; }

        /* Armor-specific styles */
        .armor-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        #armor-btn {
            width: 34px;
            height: 34px;
            font-size: 16px;
            line-height: 16px;
            padding: 0;
            flex-shrink: 0;
        }
        #armor-points {
            width: 50px;
            text-align: center;
        }
        #armor-btn.armor-active {
            color: #0AF;
            border-color: #0AF;
            text-shadow: 0 0 3px #0AF, 0 0 8px #0AF;
            box-shadow: 0 0 5px #0AF;
            background: rgba(0, 170, 255, 0.1);
        }
        #armor-points.armor-active {
            color: #0AF;
            border-color: #0AF;
            text-shadow: 0 0 3px #0AF;
            background: rgba(0, 170, 255, 0.1);
        }
        #armor-preset-list .preset-item {
             cursor: pointer;
        }

        /* --- TUTORIAL STYLES --- */
        #tutorial-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            pointer-events: none; /* Allows clicks to pass through to elements behind */
        }
        .tutorial-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(2px);
        }
        .tutorial-highlight {
            position: relative;
            z-index: 1001;
            box-shadow: 0 0 15px 5px var(--accent-color), 0 0 3px 2px var(--accent-color) inset;
            border-radius: 3px;
            transition: all 0.3s ease-in-out;
            pointer-events: all; /* Highlighted element is clickable */
            padding: 0;
        }
        .tutorial-prompt {
            position: absolute;
            z-index: 1002;
            background: var(--input-bg);
            border: 1px solid var(--accent-color);
            padding: 20px;
            width: 400px;
            max-width: 90vw;
            box-shadow: 0 0 20px 5px rgba(0,0,0,0.5);
            pointer-events: all; /* Prompt is clickable */
        }
        .tutorial-prompt h3 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.1em;
            color: var(--accent-color);
        }
        .tutorial-prompt p {
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .tutorial-prompt-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tutorial-prompt-nav .step-counter {
            font-size: 0.9em;
            opacity: 0.7;
        }
        .tutorial-validation-msg {
            font-size: 0.8em;
            color: var(--danger-color);
            text-shadow: 0 0 4px var(--danger-color);
            text-align: right;
            margin-top: -10px;
            margin-bottom: 10px;
            min-height: 1em;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- All HTML content will be injected by JavaScript -->
    </div>
    
    <div id="skill-tooltip" class="hidden"></div>
    
    <!-- Modals -->
    <div id="weapon-preset-modal" class="modal-overlay hidden"> <div class="modal-content"> <div class="modal-header"> <h2>SELECT WEAPON</h2> <button onclick="closeWeaponModal()">CLOSE</button> </div> <div class="modal-controls"> <label for="weapon-category-select">CATEGORY</label> <select id="weapon-category-select" onchange="populateWeaponPresets()"></select> <button onclick="addWeapon(null, true)">+ ADD CUSTOM</button> </div> <hr style="border-color: var(--border-color); margin: 15px 0;"> <ul id="weapon-preset-list" class="preset-list"></ul> </div> </div>
    <div id="armor-modal" class="modal-overlay hidden"> <div class="modal-content"> <div class="modal-header"> <h2>SELECT ARMOR</h2> <button onclick="closeArmorModal()">CLOSE</button> </div> <div class="modal-controls"> <label class="styled-checkbox"> <input type="checkbox" id="helmet-checkbox"> <span class="checkbox-visual"></span> ADD HELMET (+1 AP) </label> </div> <hr style="border-color: var(--border-color); margin: 15px 0;"> <ul id="armor-preset-list" class="preset-list"></ul> </div> </div>
    <div id="skill-roll-modal" class="modal-overlay hidden"> <div class="modal-content" style="max-width: 400px; text-align: center;"> <div id="skill-roll-prompt"> <h2 style="margin-bottom: 20px;">IMPROVE SKILLS?</h2> <p style="margin-bottom: 25px;">This should only be done after completing a session. This action is final. Are you sure you want to roll 1d4 for all checked skills?</p> <button onclick="executeSkillRolls()">CONFIRM</button> <button onclick="closeSkillRollModal()">CANCEL</button> </div> <div id="skill-roll-process" class="hidden"> <h3 id="rolling-skill-name" style="margin-bottom: 20px; font-size: 1.2em;"></h3> <div id="dice-animation" style="font-size: 4em; font-weight: bold; margin-bottom: 25px; min-height: 60px;">-</div> <p id="roll-result-text"></p> </div> <div id="skill-roll-conclusion" class="hidden"> <h2 style="margin-bottom: 20px;">CONCLUDED</h2> <button onclick="closeSkillRollModal()">CLOSE</button> </div> </div> </div>

    <!-- TUTORIAL CONTAINER (moved outside of view-switched content) -->
    <div id="tutorial-container" class="hidden">
        <div class="tutorial-overlay"></div>
        <div id="tutorial-prompt" class="tutorial-prompt">
            <h3 id="tutorial-title"></h3>
            <p id="tutorial-text"></p>
            <div class="tutorial-validation-msg" id="tutorial-validation-msg"></div>
            <div id="tutorial-nav" class="tutorial-prompt-nav"></div>
        </div>
        <audio id="tutorial-audio" loop>
            <source src="https://github.com/diantha-bot/hosting/raw/main/splintercell_training.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>

<script>
    // --- DISABLE ENTER KEY ---
    window.addEventListener('keydown', function(e) { if (e.key === 'Enter') e.preventDefault(); });

    // --- INJECT ALL HTML ---
    document.querySelector('.container').innerHTML = `
        <header class="header"> <img src="https://images.squarespace-cdn.com/content/v1/629e0596d168b365d297c6c4/cea70b06-895e-401c-9669-04fa59cfc5e6/socom-logo.png" alt="SOCOM Logo" class="logo"> <h1>S.O.C.O.M. // AGENT ROSTER</h1> </header>
        <div class="settings-container"> <button id="settings-btn">⚙</button> <div id="settings-menu"> <button onclick="changeTheme('default')">Army (Green)</button> <button onclick="changeTheme('navy')">Navy (Blue)</button> <button onclick="changeTheme('marines')">Marines (Red)</button> <button onclick="changeTheme('airforce')">Air Force (Gray)</button> <button onclick="changeTheme('intelligence')">CIA/NSA (B&W)</button> <button onclick="changeTheme('officer')">Command (Gold)</button> <button onclick="changeTheme('plain')">Plain Mode</button><button id="admin-login-btn" onclick="toggleAdminMode()">Admin Login</button> </div> </div>
        <main id="main-view"> <div class="main-menu"> <h2>SYSTEM ACCESS</h2> <div id="daily-briefing" style="margin-bottom: 20px; border: 1px solid var(--border-color); padding: 10px; text-align: left; font-size: 0.9em;"> <h3 id="history-title" style="border: none; margin: 0 0 10px 0;">THIS DAY IN HISTORY // SYSTEM DATE</h3> <div style="display: flex; align-items: flex-start; gap: 15px;"> <p id="history-content" style="margin: 0; line-height: 1.4; flex: 1;">...LOADING HISTORICAL DATA...</p> <img id="history-image" src="" alt="Historical event" style="width: 220px; max-height: 160px; height: auto; border: 1px solid var(--border-color); object-fit: cover; display: none;"> </div> </div> <button onclick="resetForm(); showView('character-sheet'); ">> CREATE NEW AGENT FILE</button> <button onclick="showView('loader')">> LOAD AGENT FILE</button> <button onclick="showView('rules')">> RULES</button> <button onclick="beginTutorial()">> TUTORIAL</button> <button onclick="showView('about')">> ABOUT SOCOM</button> </div> </main>
        <main id="loader-view" class="hidden"> <div class="loader-menu"> <h2>LOAD AGENT</h2> <input type="file" id="json-file-input" accept=".json" onchange="loadCharacterFromFile(event)" class="button"> <h3>LOCAL SAVES</h3> <ul id="saved-sheets-list"></ul> <button onclick="showView('main')">> RETURN</button> </div> </main>
        <main id="character-sheet-view" class="hidden"> <div id="character-sheet-container"> <button onclick="saveCharacter()">SAVE</button><button onclick="screenshotPage(event)">SCREENSHOT</button><button onclick="exportToJson()">EXPORT TO .JSON</button><label id="lock-branch-rank-container" class="styled-checkbox hidden" style="margin-left: 15px;"><input type="checkbox" id="lock-branch-rank-checkbox"><span class="checkbox-visual"></span> LOCK BRANCH/RANK</label> <button onclick="showView('main')">RETURN TO MENU</button> <form id="sheet-form" onsubmit="return false;"></form> </div> </main>
        <main id="rules-view" class="hidden"> <div class="content-menu"> <h2 style="text-align: center;">RULES OF ENGAGEMENT</h2> <h2>Be Civil, Be Respectful.</h2> <p>SOCOM is intended to be a dark and intense game, but we're all here to have fun. Horror is in-character and respect is out-of-character. Don't make it personal and don't take things to the heart.</p> <h2>About PvP.</h2> <p>Tension between characters happens - distrust, paranoia, and conflicting agendas are part of the setting. But player consent is key before betrayal, sabotage, or character-on-character violence. NEMESIS will not tolerate out-of-character grudges; keep the drama in the game.</p> <h2>Communication and Versimilitude.</h2> <p>If you're unsure about something, ask - NEMESIS will always answer. Work with the other players to build suspense and tension and keep the setting immersive. Paranoia is more fun with friends.</p> <h2>Death (and Worse) is Part of the Game.</h2> <p>Your character is not a hero, and they are not safe. SOCOM is about failure, creeping dread, and moral collapse with the occasional success. Expect your character to die, disappear, go insane, or worse. When that happens, we'll work together to bring in a new agent.</p> <h2>No Metagaming, No Powergaming</h2> <p>Metagaming (using OOC knowledge IC) ruins the experience - act on what your character knows, not what you do. Powergaming (forcing actions on others or breaking realism) doesn't fit this setting. Be prepared for failures and bad choices.</p> <h2>Trust NEMESIS, but Question Everything</h2> <p>NEMESIS is not your enemy, but will make your character suffer. If something seems off in the story, that's probably intentional. Keep your eyes open. Assume you're being lied to. And remember that no one is coming to save you.</p> <h2 style="text-align: center; font-size: 1.1em;">CONTENT WARNINGS</h2> <p>SOCOM Operations will often contain multiple of the contents detailed below:</p> <ul> <li>Violence, Gore and Death</li> <li>Torture and Enhanced Interrogation</li> <li>Psychological Horror and Trauma</li> <li>Body Horror</li> <li>Substance Abuse</li> </ul> <p>No explicit sexual content is included in SOCOM, although it can be implied/mentioned.</p> <div style="text-align: center; margin-top: 30px;"> <button onclick="showView('main')">> RETURN TO MENU</button> </div> </div> </main>
        <main id="about-view" class="hidden"> <div class="content-menu"> <h2 style="text-align: center; margin-bottom: 20px;">ABOUT SOCOM</h2> <p>SOCOM is a serialized, operation-based TTRPG using a slightly modified <a href="https://www.deltagreen.com" target="_blank" rel="noopener noreferrer" class="themed-link">Delta Green</a> system set from the 1990s through the 2010s, with most missions unfolding in a post-9/11 world. As America wages covert wars across the globe and at home, a clandestine task force known as N.E.M.E.S.I.S., comprised of elite operatives from the CIA, NSA, and the U.S. military, carries out black ops in the name of national security.</p> <p>Players assume the roles of N.E.M.E.S.I.S. agents: psyops, field tacticians, analysts, and infiltrators tasked with counterterrorism, espionage, information warfare, and the moral rot that comes with them.</p> <p style="margin-top: 25px;"><em>Inspired by Metal Gear Solid, Call of Duty, Splinter Cell and The Hunt for Red October.</em></p> <p style="font-size: 1.2em; text-align: center; font-style: italic; margin-top: 40px; margin-bottom: 20px;"> <a href="https://discord.gg/g8DgxusP9u" target="_blank" rel="noopener noreferrer" class="themed-link">/De Opresso Liber/</a> </p> <div style="text-align: center; margin-bottom: 40px;"> <a href="https://www.socom.mil/" target="_blank" rel="noopener noreferrer"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/SpecialForces_Badge.svg/1200px-SpecialForces_Badge.svg.png" alt="Green Berets Logo" class="logo" style="height: 70px; margin-right: 0;"> </a> </div> <div style="text-align: center;"> <button onclick="showView('main')">> RETURN TO MENU</button> </div> </div> </main>
        <main id="tutorial-view" class="hidden"> <div id="tutorial-entry-point" class="content-menu" style="text-align: center;"> <h2>AGENT INDUCTION</h2> <p style="text-align:center;">Begin NEMESIS Protocol Training?</p> <button id="begin-tutorial-btn">BEGIN</button> </div> </main>`;
    document.getElementById('sheet-form').innerHTML = `<input type="hidden" id="character-id"> <section class="form-section"> <h2>IDENTIFICATION</h2> <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr"> <div id="tutorial-target-fullname"><label for="full-name">FULL NAME</label><input type="text" id="full-name"></div> <div id="tutorial-target-branch"><label for="branch">BRANCH</label><select id="branch" onchange="updateRanks()"></select></div> <div id="tutorial-target-rank"><label for="rank">RANK/GRADE</label><select id="rank" onchange="applyAutoTheme()"></select></div> <div id="tutorial-target-team"><label for="team">TEAM</label><select id="team"><option>SOCOM 1</option><option>SOCOM 2</option><option>SOCOM 3</option><option>SOCOM 4</option><option>SOCOM 5</option><option>SOCOM 6</option></select></div> <div id="tutorial-target-sex"><label for="sex">SEX</label><select id="sex"><option>M</option><option>F</option><option>NA</option></select></div> <div><label for="dob">D.O.B.</label><input type="text" id="dob" placeholder="YYYY-MM-DD"></div> <div><label for="nationality">NATIONALITY</label><input type="text" id="nationality"></div> <div><label for="employer">EMPLOYER</label><input type="text" id="employer"></div> <div><label for="education">EDUCATION</label><input type="text" id="education"></div> </div> </section> <div class="form-grid"> <div class="col-1"> <section class="form-section"> <div style="display: flex; justify-content: space-between; align-items: center;"><h2>CORE ATTRIBUTES (<span id="stat-points-remaining">25</span> PTS)</h2><button type="button" id="toggle-stats-lock-btn" onclick="toggleStatsLock()" class="hidden">FORCE STATS</button></div> <div id="stats-container" style="display: flex; flex-direction: column; gap: 8px;"></div> </section> <section class="form-section"> <h2>DERIVED ATTRIBUTES</h2> <div class="grid-container" style="grid-template-columns: 1fr 1fr 1fr;"> <div><label>HIT POINTS (HP)</label><div class="derived-attr-input"><input type="number" id="hp-current" min="0"> / <input type="number" id="hp-max" value="0" readonly></div></div> <div><label>ARMOR (AP)</label><div class="derived-attr-input armor-controls"><button type="button" id="armor-btn" onclick="toggleArmor()">△</button><input type="number" id="armor-points" class="hidden" min="0" oninput="validateArmorPoints(event)"></div></div> <div><label>WILLPOWER (WP)</label><div class="derived-attr-input"><input type="number" id="wp-current" min="0"> / <input type="number" id="wp-max" value="0" readonly></div></div> <div><label>SANITY (SAN)</label><div class="derived-attr-input"><input type="number" id="san-current" min="0" oninput="checkBreakingPoint()"> / <input type="number" id="san-max" value="0" readonly></div></div> <div><label>BREAKING PT</label><input type="number" id="bp" readonly></div> </div> <div id="bp-warning" class="hidden"> SAN is at or below Breaking Point! Agent must acquire a new disorder. <button type="button" onclick="acknowledgeBreakingPoint()">ACK & RESET BP</button> </div> </section> <section class="form-section"> <div class="bonds-header" style="display: flex; justify-content: space-between; align-items: center;"> <h2>BONDS (<span id="bond-cha-note"></span>)</h2> <button type="button" onclick="addBond()">+ ADD</button> </div> <div id="bonds-container"></div> </section> <section class="form-section"> <h2 style="text-align: center; border:none; margin-bottom: 5px;">PSYCH PROFILE</h2> <div class="san-loss-container"> <div class="san-loss-group"> <div class="san-loss-label"> <label>VIOLENCE</label><span id="violence-adapted" class="adapted-status hidden">ADAPTED</span> </div> <div> <label class="styled-checkbox"><input type="checkbox" id="violence1" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="violence2" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="violence3" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> </div> </div> <div class="san-loss-group"> <div class="san-loss-label"> <label>HELPLESSNESS</label><span id="helplessness-adapted" class="adapted-status hidden">ADAPTED</span> </div> <div> <label class="styled-checkbox"><input type="checkbox" id="helplessness1" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="helplessness2" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> <label class="styled-checkbox"><input type="checkbox" id="helplessness3" onclick="checkAdaptedStatus()"><span class="checkbox-visual"></span></label> </div> </div> </div> </section> </div> <div class="col-2"> <section class="form-section" style="flex-grow: 1; display: flex; flex-direction: column;"> <div style="display: flex; justify-content: space-between; align-items: center;"><h2 style="border-bottom: none;">SKILLS</h2><button type="button" id="roll-skills-btn" class="hidden" onclick="startSkillImprovement()">Roll 1d4s</button></div> <div id="skills-container" style="display: flex; flex-direction: column; gap: 10px; flex-grow: 1;"></div> </section> </div> </div> <section class="form-section" id="tutorial-target-gear"> <h2>WEAPONS & EQUIPMENT</h2> <label for="gear">ARMOR AND GEAR</label> <textarea id="gear"></textarea> <label for="notes-field" style="margin-top:10px;">NOTES</label> <textarea id="notes-field"></textarea> <h3 style="margin-top: 15px;">WEAPONS</h3> <table id="weapons-table" style="width:100%; border-collapse: collapse;"> <thead> <tr><th>NAME</th><th>SKILL%</th><th>RANGE</th><th>DMG</th><th>AP</th><th>LETHALITY</th><th>AMMO</th><th></th></tr> </thead> <tbody id="weapons-body"></tbody> </table> <button type="button" onclick="openWeaponModal()">+ ADD WEAPON</button> </section>`;

    // --- CONFIG ---
    const ADMIN_PASSWORD_HASH = 'dmFsa3lyaWU=';
    let isAdmin = false;
    let statsUnlocked = false;
    let isArmorActive = false;
    let currentArmorPoints = 0;
    const MAX_STAT_POINTS = 25, MIN_STAT_VALUE = 8, MAX_STAT_VALUE = 18;
    const branches = { "NSA": "intelligence", "CIA": "intelligence", "Army": "army", "Navy": "navy", "Marines": "marines", "Air Force": "airforce" };
    const ranks = { intelligence: [ {name: "Case Officer", grade: "GS-11"}, {name: "Supervisory CO", grade: "GS-14", adminOnly: true}, {name: "Chief of Station", grade: "SIS-2", adminOnly: true} ], army: [ {name: "Sergeant", grade: "E-5"}, {name: "Staff Sergeant", grade: "E-6"}, {name: "Sergeant First Class", grade: "E-7"}, {name: "Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ], marines: [ {name: "Sergeant", grade: "E-5"}, {name: "Staff Sergeant", grade: "E-6"}, {name: "Gunnery Sergeant", grade: "E-7"}, {name: "Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ], navy: [ {name: "Petty Officer 2nd Class", grade: "E-5"}, {name: "Petty Officer 1st Class", grade: "E-6"}, {name: "Chief Petty Officer", grade: "E-7"}, {name: "Senior Chief Petty Officer", grade: "E-8", adminOnly: true}, {name: "Ensign", grade: "O-1", adminOnly: true}, {name: "Lieutenant (JG)", grade: "O-2", adminOnly: true}, {name: "Lieutenant", grade: "O-3", adminOnly: true} ], airforce: [ {name: "Staff Sergeant", grade: "E-5"}, {name: "Technical Sergeant", grade: "E-6"}, {name: "Master Sergeant", grade: "E-7"}, {name: "Senior Master Sergeant", grade: "E-8", adminOnly: true}, {name: "Second Lieutenant", grade: "O-1", adminOnly: true}, {name: "First Lieutenant", grade: "O-2", adminOnly: true}, {name: "Captain", grade: "O-3", adminOnly: true} ] };
    const stats = ["STR", "DEX", "CON", "INT", "POW", "CHA"];
    const simpleSkills = [ "Accounting", "Alertness", "Artillery", "Athletics", "Criminology", "Disguise", "Dodge", "Drive", "Firearms", "First Aid", "Forensics", "Heavy Machinery", "Heavy Weapons", "Human Studies", "HUMINT", "Leadership", "Medicine", "Melee Weapons", "Navigate", "Paranormal", "Persuade", "Pharmacy", "Psychotherapy", "Ride", "Search", "SIGINT", "Stealth", "Support Int.", "Surgery", "Survival", "Swim", "Tech Procedures", "Unarmed Combat" ].sort();
    const baseSkillValues = { 'Accounting': 10, 'Alertness': 20, 'Athletics': 30, 'Disguise': 10, 'Dodge': 30, 'Drive': 20, 'Firearms': 20, 'First Aid': 10, 'Heavy Machinery': 10, 'Heavy Weapons': 10, 'Human Studies': 10, 'Melee Weapons': 30, 'Navigate': 10, 'Paranormal': 10, 'Persuade': 20, 'Psychotherapy': 10, 'Ride': 10, 'Search': 20, 'Stealth': 20, 'Survival': 10, 'Swim': 20, 'Tech Procedures': 20, 'Unarmed Combat': 40 };
    const statDescriptions = { STR: { 3: "Frail", 6: "Below Average", 9: "Average", 12: "Strong", 15: "Powerful", 18: "Peak Human" }, DEX: { 3: "Clumsy", 6: "Slow", 9: "Average", 12: "Agile", 15: "Nimble", 18: "Lightning Reflexes" }, CON: { 3: "Sickly", 6: "Frail", 9: "Average", 12: "Hardy", 15: "Tough", 18: "Superhuman Endurance" }, INT: { 3: "Dim", 6: "Slow Learner", 9: "Average", 12: "Sharp", 15: "Brilliant", 18: "Genius" }, POW: { 3: "Weak-willed", 6: "Hesitant", 9: "Average", 12: "Determined", 15: "Indomitable", 18: "Unyielding Will" }, CHA: { 3: "Unlikable", 6: "Awkward", 9: "Average", 12: "Likable", 15: "Charismatic", 18: "Compelling Presence" } };
    const skillDescriptions = {'Accounting': 'The study of finance and business. Use it to sift through financial records for anomalies, such as a hidden bank account or money laundering.', 'Alertness': 'Alertness detects danger. Use it to hear a safety being switched off, to understand the mumbling on the other side of a wall, to spot the bulge of a pistol hidden under a jacket, or to catch someone who is trying to escape notice using Stealth.', 'Artillery': 'Safe and accurate use of mortars, missiles, howitzers, tank cannons, and other heavy gunnery. Use it to destroy troops or a hard target in battle.', 'Athletics': 'Represents long practice doing things like running, jumping, climbing, and throwing. Use Athletics to outrun someone, jump a gap, climb in a crisis, land safely in a fall, hit a target with a thrown knife, or catch something without warning.', 'Craft': 'Making and repairing sophisticated tools and structures. A job that most people could figure out does not require the Craft skill, only an INT or DEX test.', 'Criminology': 'Knowledge of criminal and conspiratorial behavior. Use it to identify and predict criminal behavior, deduce relationships between members of a conspiracy, analyze criminal activity, examine witness statements, or know whom to talk to in the criminal underground.', 'Disguise': 'Alter your Agent’s appearance, voice, posture, body language, and mannerisms to avoid recognition without drawing attention.', 'Dodge': 'Evading danger through instinct and reflexes. Use Dodge to avoid an attack. Against firearms and explosives, Dodge is only useful to get to cover.', 'Drive': 'Handling an automobile or a motorcycle safely in a crisis. Every Agent can drive a car in normal conditions. Use this skill to keep a vehicle safe in a high-speed pursuit or on dangerous terrain.', 'Firearms': 'Safe and accurate shooting with weaponry in combat. Use it to hit a target despite the adrenaline, panic, and shock of violence interfering with hand-eye coordination.', 'First Aid': 'The initial treatment and stabilization of of injuries. Use it to help a character recover lost Hit Points. By comparison, Surgery corrects a severe wound and Medicine ensures long-term recovery.', 'Forensics': 'Gathering detailed information and evidence using forensic equipment. Use it to record biometric data, determine details about a weapon used, discern crucial clues, clean a scene of incriminating evidence, or collect, analyze, and compare fingerprints and DNA samples.', 'HUMINT': 'Human intelligence. Obtains information about a subject through observation, conversation, or examining patterns of behavior and relationships. Use HUMINT to recognize signs of dishonesty, gauge attitude, cultivate sources, or determine what it would take to get a subject to cooperate.', 'Heavy Machinery': 'Safe operation of a tractor, crane, bulldozer, tank, heavy truck, or other big machine in a crisis.', 'Heavy Weapons': 'Safe and accurate use of man-portable heavy ordnance such as machine guns and rocket launchers. Use Heavy Weapons to suppress enemies, or destroy a vehicle in combat.', 'Human Studies': 'Interdisciplinary skill combining art, archaeology, anthropology, history, and geography. Use this skill to investigate ancient artifacts, study lost civilizations, analyze societal structures, decipher historical texts, or map out the geography of a region.', 'Medicine': 'The study and treatment of injury and illness. Use it to diagnose the cause of an injury, disease, or poisoning, identify abnormalities, determine cause of death, or prescribe proper long-term care.', 'Leadership': 'The ability to inspire, guide, and coordinate people, especially in high-pressure situations. Use this skill to organize complex operations, provide clear commands under stress, motivate allies, and keep the team focused on objectives.', 'Melee Weapons': 'Lethal use of melee weapons in combat. Use it to hurt or kill an opponent with a knife, axe, club, or other weapon.', 'Military Science': 'Knowledge of military culture, techniques, and regulations. Use it to identify threats, find ranges, recognize weaknesses in a fortification, deduce training level of a unit, reconstruct a battle, or deploy forces advantageously. Types are Land, Air, and Sea.', 'Navigate': 'Finding your way quickly with maps, charts and tables, orienteering, instruments, or dead reckoning.', 'Paranormal': 'The understanding and investigation of supernatural phenomena, including occult practices, unexplained events, and unnatural entities. Use this skill to decipher occult rituals, track and identify otherworldly threats, or understand the motives of paranormal entities.', 'Persuade': 'Changing another’s deeply-held decision or desire. Use Persuade to get your way when the subject is stubborn or the deception is flagrant. This skill also allows your Agent to resist persuasion and interrogation.', 'Pharmacy': 'Knowledge of drugs, from their ingredients and creation, to their effects, uses, and misuses. Use it to identify and produce medicines and antidotes—as well as poisons. Misusing Pharmacy is a quick way to kill a patient.', 'Pilot': 'Piloting, navigating, and captaining waterborne or airborne vehicles. Use it to keep a vessel safe in a crisis, such as through a storm or in a dangerous pursuit. Each vessel type is a separate skill.', 'Psychotherapy': 'The diagnosis and treatment of mental illness. Use it to identify a mental disorder, help a patient recover, and treat mental illness in the long term. You cannot use Psychotherapy on yourself.', 'Ride': 'Handling, training, and riding an animal—horses, donkeys, camels, whatever. Use it to keep safe on an animal in a crisis and to keep riding animals safe, calm, and healthy.', 'SIGINT': 'Signals intelligence. It encompasses encryption, communications intelligence, electronic intelligence, computer science, surveillance of radio and digital communications, and the making and breaking of codes.', 'Search': 'Finding things that are concealed or obscured from plain sight. Use Search to find an object that was hidden with the Stealth skill, or is otherwise so well hidden or disguised that it needs an expert.', 'Science': 'The deep study of the processes of the world. Science is used to find a key insight about the way the universe works—or at least, the way it’s supposed to work.', 'Stealth': 'Concealing your presence or activities. Use it to hide a pistol, camouflage a position, conceal a microphone, pick a pocket, move silently, or follow without being seen. An Agent attempting Stealth can be detected only by an opposing Alertness or Search skill.', 'Surgery': 'The treatment of an injury or abnormality by invasive means. By comparison, First Aid keeps a patient alive until surgery is possible and Medicine ensures longterm recovery.', 'Support Int.': 'The ability to coordinate and direct external resources, such as air support, medical evacuations, or artillery fire, while under duress. Use this skill to effectively integrate support assets into operations while managing the pressure of a hostile environment.', 'Survival': 'Knowledge of the natural world. Use it to find tracks and trails, plan an expedition, predict weather, recognize when fauna or flora are unusual, or find food, water, and shelter.', 'Swim': 'Most Agents can swim for leisure. Use the Swim skill in a dangerous crisis: going a long distance in choppy water, keeping a friend from drowning, or similar situations.', 'Tech Procedures': 'The knowledge of laws, bureaucratic processes, and regulations that govern actions in operational contexts, particularly those involving command structures, military protocols, and local legal systems. Use this skill to navigate complex rules of engagement (ROE), make equipment requistions, and navigate the command chain.', 'Unarmed Combat': 'Use Unarmed Combat to hurt or kill an opponent with your Agent’s bare hands (or feet, elbows, teeth, or head).'};
    const weaponPresets = {"Melee Weapons":[{name:"Unarmed",expense:"N/A",skillIdentifier:"Unarmed Combat",range:1,dmg:"1D4-1",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"Basic hand-to-hand strikes with fists, kicks, and elbows. Damage can be improved with training.",examples:"e.g., Boxing, Karate, Krav Maga."},{name:"Brass Knuckles/Steel-toe boots",expense:"Incidental",skillIdentifier:"Unarmed Combat",range:1,dmg:"1D4",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A simple, concealable force-multiplier for unarmed strikes, or using a heavy, blunt object.",examples:"e.g., Weighted gloves, heavy flashlight."},{name:"Garotte",expense:"Incidental",skillIdentifier:"Unarmed Combat",range:1,dmg:"Special",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A wire or cord for silent strangulation. Works only from surprise. On success, target is pinned and silenced, taking 1D6 damage per round until escape. Kevlar cord can cut flex-cuffs.",examples:"e.g., Piano wire, kevlar cord."},{name:"Knife",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D4",ap:"3",lethality:"",ammoC:"",ammoM:"",desc:"A small, single-edged blade. Common and easily concealable.",examples:"e.g., Pocket knife, boot knife."},{name:"Hatchet",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D4",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A small, short-handled axe for chopping, utility, or combat.",examples:"e.g., Camping hatchet, survival tomahawk."},{name:"Large knife/Combat dagger",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D6",ap:"3",lethality:"",ammoC:"",ammoM:"",desc:"A dedicated combat knife with a larger, often double-edged blade for increased lethality.",examples:"e.g., Ka-Bar, Fairbairn-Sykes dagger."},{name:"Club/Baton",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D6",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A blunt instrument designed for subduing targets through impact.",examples:"e.g., Police nightstick, collapsible ASP baton."},{name:"Machete/Tomahawk/Sword",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D8",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A large, heavy blade or axe designed for clearing brush or as a formidable weapon.",examples:"e.g., Kukri, Latin machete, Gladius."},{name:"Baseball bat/Rifle butt",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D8",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A heavy club for sport or improvised combat. A rifle can be used as a club in melee.",examples:"e.g., Louisville Slugger, rifle stock strike."},{name:"Spear/Fixed bayonet",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D8",ap:"3",lethality:"",ammoC:"",ammoM:"",desc:"A pole weapon with a pointed tip, effective at keeping enemies at a distance or for thrusting attacks.",examples:"e.g., Improvised spear, M9 bayonet."},{name:"Wood axe",expense:"Incidental",skillIdentifier:"Melee Weapons",range:1,dmg:"1D10",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A heavy, typically two-handed axe for felling trees, breaching doors, or causing massive trauma.",examples:"e.g., Felling axe, fire axe."},{name:"Large sword",expense:"Standard",skillIdentifier:"Melee Weapons",range:1,dmg:"1D10",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A one-handed sword, requiring training but highly effective for cutting and thrusting in combat.",examples:"e.g., Arming sword, Katana."},{name:"Two-handed sword",expense:"Standard",skillIdentifier:"Melee Weapons",range:1,dmg:"1D12",ap:"",lethality:"",ammoC:"",ammoM:"",desc:"A massive blade requiring two hands, delivering devastating blows with superior reach.",examples:"e.g., Zweihänder, Claymore."}],"Firearms":[{name:"Light Pistol",expense:"Standard",skillIdentifier:"Firearms",range:10,dmg:"1D8",ap:"",lethality:"",ammoC:7,ammoM:7,desc:"Small-caliber sidearms, easily concealable but lacking stopping power.",examples:"e.g., Ruger SR22, Walther PPK, Colt Detective Special"},{name:"Medium Pistol",expense:"Standard",skillIdentifier:"Firearms",range:15,dmg:"1D10",ap:"",lethality:"",ammoC:15,ammoM:15,desc:"Standard-issue service pistols, balancing magazine capacity and effectiveness.",examples:"e.g., Glock 19, SIG Sauer P226, Beretta M9"},{name:"Heavy Pistol",expense:"Standard",skillIdentifier:"Firearms",range:20,dmg:"1D12",ap:"",lethality:"",ammoC:8,ammoM:8,desc:"Large-caliber handguns and revolvers known for their immense stopping power.",examples:"e.g., Desert Eagle .50 AE, S&W Model 29, Colt Python"},{name:"Shotgun (Nonlethal)",expense:"Standard",skillIdentifier:"Firearms",range:10,dmg:"Stunned",ap:"",lethality:"",ammoC:5,ammoM:5,desc:"Fires beanbag rounds or rubber slugs designed to incapacitate targets without lethal force.",examples:"e.g., Rounds for Mossberg 500, Remington 870"},{name:"Shotgun (Shot)",expense:"Standard",skillIdentifier:"Firearms",range:50,dmg:"2D10",ap:"",lethality:"",ammoC:5,ammoM:5,desc:"Fires a spread of pellets, devastating at close range.",examples:"e.g., Mossberg 500, Remington 870, Benelli M4"},{name:"Shotgun (Slug)",expense:"Standard",skillIdentifier:"Firearms",range:75,dmg:"2D8",ap:"",lethality:"",ammoC:5,ammoM:5,desc:"Fires a single, solid projectile for greater range and accuracy.",examples:"e.g., Rounds for Mossberg 500, Remington 870"},{name:"Submachine Gun",expense:"Unusual",skillIdentifier:"Firearms",range:50,dmg:"1D10",ap:"",lethality:"10",ammoC:30,ammoM:30,desc:"Compact, automatic weapons ideal for close-quarters combat. RESTRICTED.",examples:"e.g., H&K MP5, FN P90, IMI Uzi"},{name:"Light Rifle/Carbine",expense:"Unusual",skillIdentifier:"Firearms",range:100,dmg:"1D12",ap:"3",lethality:"10",ammoC:30,ammoM:30,desc:"Standard military assault rifles, versatile for most combat scenarios. RESTRICTED.",examples:"e.g., M4A1, AK-74, Steyr AUG, SIG MCX"},{name:"Heavy Rifle",expense:"Unusual",skillIdentifier:"Firearms",range:150,dmg:"1D12+2",ap:"5",lethality:"10",ammoC:20,ammoM:20,desc:"Battle rifles firing full-power cartridges for superior range and penetration. RESTRICTED.",examples:"e.g., FN FAL, H&K G3, M14, Dragunov SVD"},{name:"Very Heavy Rifle",expense:"Major",skillIdentifier:"Firearms",range:250,dmg:"",ap:"",lethality:"20",ammoC:10,ammoM:10,desc:"High-caliber sniper and anti-materiel rifles for extreme long-range engagements. RESTRICTED.",examples:"e.g., Barrett M82A1, McMillan TAC-50, CheyTac M200"}],"Heavy Weapons":[{name:"Hand grenade",expense:"Incidental",skillIdentifier:"Athletics+20",range:20,dmg:"",ap:"",lethality:"15",ammoC:1,ammoM:1,desc:"Thrown explosive with a timed fuse. Kill Radius: 10m. RESTRICTED.",examples:"e.g., M67 Fragmentation, RGO Impact."},{name:"Handheld flamethrower",expense:"Unusual",skillIdentifier:"Heavy Weapons",range:5,dmg:"10% Lethality",ap:"",lethality:"10",ammoC:20,ammoM:20,desc:"A portable incendiary device that projects a stream of fire. Kill Radius: 1m.",examples:"e.g., Ion XM42."},{name:"Military flamethrower",expense:"Unusual",skillIdentifier:"Heavy Weapons",range:10,dmg:"10% Lethality",ap:"",lethality:"10",ammoC:5,ammoM:5,desc:"A backpack-fed incendiary weapon with greater range and fuel capacity. Kill Radius: 2m. RESTRICTED.",examples:"e.g., AEC M9A1-7."},{name:"Light machine gun (LMG)",expense:"Major",skillIdentifier:"Heavy Weapons",range:200,dmg:"1D12",ap:"3",lethality:"10",ammoC:100,ammoM:200,desc:"An automatic rifle designed for sustained suppressive fire at the squad level. Kill Radius: Burst Length. RESTRICTED.",examples:"e.g., FN MINIMI (M249 SAW), Molot RPK."},{name:"General-purpose machine gun (GPMG)",expense:"Major",skillIdentifier:"Heavy Weapons",range:300,dmg:"1D12+2",ap:"3",lethality:"15",ammoC:100,ammoM:100,desc:"A medium machine gun, effective in both offensive and defensive roles. Kill Radius: Burst Length. RESTRICTED.",examples:"e.g., FN MAG (M240), Kovrov PKM, Saco M60."},{name:"Minigun",expense:"Extreme",skillIdentifier:"Heavy Weapons",range:300,dmg:"1D12+2",ap:"5",lethality:"20",ammoC:4000,ammoM:4000,desc:"An electrically-driven, multi-barrel rotary machine gun with an extremely high rate of fire. Kill Radius: Long spray. RESTRICTED.",examples:"e.g., Dillon GAU-17/A, GE M134, KBP GShG-7.62."},{name:"Heavy machine gun (HMG)",expense:"Major",skillIdentifier:"Heavy Weapons",range:400,dmg:"",ap:"5",lethality:"20",ammoC:100,ammoM:100,desc:"A large-caliber machine gun, typically mounted, effective against infantry and light vehicles. Kill Radius: Burst Length. RESTRICTED.",examples:"e.g., Browning M2HB, Degtyaryov DShKM, Kovrov NSV."},{name:"Autocannon",expense:"Extreme",skillIdentifier:"Heavy Weapons",range:400,dmg:"",ap:"5",lethality:"30",ammoC:100,ammoM:100,desc:"A large-caliber automatic gun firing explosive shells, too large for a single person to operate. Kill Radius: 3m. RESTRICTED.",examples:"e.g., M242 Bushmaster."},{name:"Grenade launcher (GL)",expense:"Major",skillIdentifier:"Heavy Weapons",range:150,dmg:"",ap:"",lethality:"15",ammoC:1,ammoM:6,desc:"A single-shot weapon that fires explosive grenades further than they can be thrown. Revolver capacity: 6. Kill Radius: 10m. RESTRICTED.",examples:"e.g., Colt M203, H&K M320, Milkor M32, Springfield M79."},{name:"Grenade machine gun (GMG)",expense:"Major",skillIdentifier:"Heavy Weapons",range:300,dmg:"",ap:"",lethality:"15",ammoC:30,ammoM:30,desc:"An automatic, belt-fed grenade launcher for sustained fire support. *If firing a burst (5 grenades), Lethality is 20%. Kill Radius: 10m. RESTRICTED.",examples:"e.g., H&K GMG, Saco MK 19 MOD 3, KBP AGS-17."},{name:"Rocket-propelled grenade launcher (RPG)",expense:"Standard",skillIdentifier:"Heavy Weapons",range:200,dmg:"",ap:"20",lethality:"30",ammoC:1,ammoM:1,desc:"A shoulder-fired anti-tank weapon that launches a rocket with an explosive warhead. Kill Radius: 10m. RESTRICTED.",examples:"e.g., ATK M72 LAW, Bazalt RPG-7V, Bofors AT4 (M136)."}],"Electro-Shock":[{name:"Stun Gun",expense:"Incidental",skillIdentifier:"DEX*5",range:1,dmg:"Penalty -20%",ap:"",lethality:"",ammoC:1,ammoM:1,desc:"A close-range electroshock weapon designed to incapacitate through pain compliance.",examples:"e.g., TASER Pulse, VIPERTEK VTS-989."},{name:"Shock Baton",expense:"Incidental",skillIdentifier:"DEX*5",range:1,dmg:"Penalty -20%",ap:"",lethality:"",ammoC:4,ammoM:4,desc:"A melee-range electroshock weapon for crowd control or subduing resistant targets.",examples:"e.g., Maglite Stun Gun Baton, Police-grade stun baton."},{name:"CED Pistol",expense:"Standard",skillIdentifier:"Firearms",range:4,dmg:"Penalty -20%",ap:"",lethality:"",ammoC:1,ammoM:1,desc:"A ranged electroshock weapon that fires wired projectiles to immobilize a target from a distance.",examples:"e.g., TASER X26, Axon TASER 7."}],"Grenades & Chemical":[{name:"Flash Grenade (Thrown)",expense:"Incidental",skillIdentifier:"Athletics+20",range:10,dmg:"Penalty -40%",ap:"",lethality:"",ammoC:1,ammoM:1,desc:"Non-lethal explosive device that produces a blinding flash and deafening bang to disorient targets.",examples:"e.g., M84 Stun Grenade."},{name:"Flash Grenade (Launched)",expense:"Incidental",skillIdentifier:"Heavy Weapons",range:50,dmg:"Penalty -40%",ap:"",lethality:"",ammoC:1,ammoM:1,desc:"Grenade launcher variant of the flash grenade for greater range.",examples:"e.g., 40mm Stun/Flash Cartridge."},{name:"Pepper Spray Keychain",expense:"Incidental",skillIdentifier:"DEX*5",range:1,dmg:"Penalty -20%",ap:"",lethality:"",ammoC:12,ammoM:12,desc:"A small, concealable canister of oleoresin capsicum for self-defense.",examples:"e.g., SABRE Red, POM."},{name:"Pepper Spray Can",expense:"Incidental",skillIdentifier:"DEX*5",range:3,dmg:"Penalty -20%",ap:"",lethality:"",ammoC:12,ammoM:12,desc:"A larger canister of oleoresin capsicum for crowd control or more sustained use.",examples:"e.g., Police-issue OC spray."},{name:"Tear Gas (Thrown)",expense:"Standard",skillIdentifier:"Athletics+20",range:10,dmg:"Penalty -40%",ap:"",lethality:"",ammoC:1,ammoM:1,desc:"Canister that releases a chemical agent (CS or CN gas) causing severe irritation and temporary blindness.",examples:"e.g., M7A3 CS Grenade."},{name:"Tear Gas (Launched)",expense:"Standard",skillIdentifier:"Heavy Weapons",range:50,dmg:"Penalty -40%",ap:"",lethality:"",ammoC:1,ammoM:1,desc:"Grenade launcher variant of the tear gas canister for area denial at range.",examples:"e.g., 40mm CS Gas Cartridge."}],"Demolitions":[{name:"Det Cord/Extrudable Explosive",expense:"Incidental",skillIdentifier:"Science",range:0,dmg:"",ap:"",lethality:"10",ammoC:1,ammoM:1,desc:"500g of flexible explosive cord or plastic explosive for precise cutting or breaching. Kill Radius: 5m. RESTRICTED.",examples:"e.g., Primacord, Semtex, C-4."},{name:"Improvised Explosive (IED)",expense:"Incidental",skillIdentifier:"Science",range:0,dmg:"",ap:"",lethality:"15",ammoC:1,ammoM:1,desc:"A homemade bomb, often powerful but potentially unreliable. Ingredients are not restricted. Kill Radius: 10m. RESTRICTED.",examples:"e.g., Pipe bomb, fertilizer bomb."},{name:"Bundled IED",expense:"Incidental",skillIdentifier:"Science",range:0,dmg:"",ap:"",lethality:"30",ammoC:1,ammoM:1,desc:"Multiple IEDs wired together for a much larger blast. Kill Radius: 20m. RESTRICTED.",examples:"e.g., A series of pipe bombs."},{name:"Explosively-Formed Penetrator",expense:"Standard",skillIdentifier:"Science",range:0,dmg:"",ap:"20",lethality:"25",ammoC:1,ammoM:1,desc:"A special type of charge designed to fire a molten metal slug capable of defeating heavy armor. Kill Radius: 10m. RESTRICTED.",examples:"e.g., M21 Landmine."},{name:"ANFO Explosive",expense:"Incidental",skillIdentifier:"Science",range:0,dmg:"",ap:"",lethality:"30",ammoC:1,ammoM:1,desc:"A powerful, bulk industrial explosive made from ammonium nitrate and fuel oil. Kill Radius: 20m. RESTRICTED.",examples:"e.g., Fertilizer and fuel oil mixture."}]};
    const armorPresets = [{name:"Kevlar vest",ap:3,desc:"If worn below outer garments, noticing it requires an Alertness test.",isBombSuit:!1},{name:"Reinforced Kevlar vest",ap:4,desc:"If worn below outer garments, noticing it requires an Alertness test at +20%.",isBombSuit:!1},{name:"Tactical body armor",ap:5,desc:"Cannot be concealed.",isBombSuit:!1},{name:"Bomb suit",ap:10,desc:"Already includes a helmet. Cannot be concealed.",isBombSuit:!0}];

    // --- DAILY HISTORY FEED ---
    function loadDailyHistory() {const e=document.getElementById("history-content"),t=document.getElementById("history-title"),n=document.getElementById("history-image"),o=new Date,a=o.getMonth()+1,i=o.getDate(),s=`${String(a).padStart(2,"0")}-${String(i).padStart(2,"0")}-${o.getFullYear()}`;t.textContent=`THIS DAY IN HISTORY // ${s}`,fetch("history.json").then(e=>{if(!e.ok)throw new Error(`Network response was not ok. Status: ${e.status}`);return e.json()}).then(o=>{const s=o.find(e=>e.month===a&&e.day===i);s?(e.textContent=s.event,s.image_url?(n.src=s.image_url,n.alt=s.image_alt||"Historical event",n.style.display="block"):n.style.display="none"):(e.textContent="No significant military events recorded for this date.",n.style.display="none")}).catch(o=>{console.error("Error fetching historical data:",o),e.textContent="Failed to load historical data. Ensure history.json is in the same directory.",n.style.display="none"})}

    // --- INITIALIZATION ---
    window.onload = () => {populateBranches();populateStats();populateSkills();loadSavedSheets();applySavedTheme();setupTooltips();loadDailyHistory();populateWeaponCategories();document.getElementById("settings-btn").addEventListener("click",()=>{document.getElementById("settings-menu").style.display="block"===document.getElementById("settings-menu").style.display?"none":"block"});document.getElementById("lock-branch-rank-checkbox").addEventListener("change",updateBranchRankLockState);document.getElementById("skills-container").addEventListener("input",updateLinkedWeaponStats);document.getElementById("skills-container").addEventListener("change",e=>{"checkbox"===e.target.type&&updateRollSkillsButtonVisibility()});document.getElementById("begin-tutorial-btn").addEventListener("click",startTutorial)};
    
    function resetForm(){document.getElementById("sheet-form").reset(),document.getElementById("bonds-container").innerHTML="",document.getElementById("weapons-body").innerHTML="",deactivateArmor(),populateSkills(),populateStats(),addBond(),addBond(),addBond(),addDefaultUnarmed(),updateAllCalculations(),checkAdaptedStatus(),setupTooltips(),document.getElementById("lock-branch-rank-checkbox").checked=!1,updateBranchRankLockState(),updateRollSkillsButtonVisibility()}
    function populateBranches(){document.getElementById("branch").innerHTML=Object.keys(branches).map(e=>`<option value="${e}">${e.toUpperCase()}</option>`).join("")}
    function populateStats(){document.getElementById("stats-container").innerHTML=stats.map(e=>`<div class="stat-item"><div class="stat-header"><label>${e}</label><button type="button" onclick="changeStat('${e}', -1)">-</button><input type="number" id="${e}" value="${MIN_STAT_VALUE}" readonly oninput="updateAllCalculations()"><button type="button" onclick="changeStat('${e}', 1)">+</button><span id="${e}x5">x5: 0</span></div><div id="${e}-desc" class="stat-desc"></div></div>`).join("")}
    function populateSkills(){const e=document.getElementById("skills-container");let t='<div class="grid-container" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); grid-auto-rows: min-content; align-items: start;">';t+=simpleSkills.map(e=>{const t=baseSkillValues[e]||0,n=`skill-${e.replace(/\s+/g,"-")}`;return`<div class="skill-item-simple"><label class="styled-checkbox"><input type="checkbox" id="check-${n}"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label for="${n}" data-skill="${e}">${e.toUpperCase()}</label><input type="number" id="${n}" min="0" max="100" value="${t}"></div></div>`}).join(""),t+='</div>',t+='<div class="grid-container" style="grid-template-columns: 1fr 1fr; align-items: stretch; margin-top: 10px;">',t+='<div><div class="sub-skill-group"> <h3 class="sub-skill-header" data-skill="Military Science">Military Science</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-land"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Military Science">Land</label><input type="number" id="skill-milsci-land" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-sea"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Military Science">Sea</label><input type="number" id="skill-milsci-sea" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-milsci-air"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Military Science">Air</label><input type="number" id="skill-milsci-air" value="0" min="0" max="100"></div></div> </div><div class="sub-skill-group" style="margin-top: 10px;"> <h3 class="sub-skill-header" data-skill="Pilot">Pilot</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-airplane"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">Airplane</label><input type="number" id="skill-pilot-airplane" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-helicopter"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">Helicopter</label><input type="number" id="skill-pilot-helicopter" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-boat"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">Boat</label><input type="number" id="skill-pilot-boat" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-pilot-rc"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Pilot">RC/Drone</label><input type="number" id="skill-pilot-rc" value="0" min="0" max="100"></div></div> </div></div>',t+='<div class="sub-skill-group"> <h3 class="sub-skill-header" data-skill="Science">Science</h3> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-biology"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Biology</label><input type="number" id="skill-science-biology" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-chemistry"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Chemistry</label><input type="number" id="skill-science-chemistry" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-mathematics"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Mathematics</label><input type="number" id="skill-science-mathematics" value="0" min="0" max="100"></div></div> <div class="sub-skill-item"><label class="styled-checkbox"><input type="checkbox" id="check-skill-science-physics"><span class="checkbox-visual"></span></label><div class="skill-label-input"><label data-skill="Science">Physics</label><input type="number" id="skill-science-physics" value="0" min="0" max="100"></div></div> </div>',t+="</div>",t+='<div class="grid-container" style="grid-template-columns: 1fr 1fr; margin-top: 10px;">',t+='<div class="sub-skill-group"> <div class="sub-skill-header-flex"><h3 class="sub-skill-header" data-skill="Craft">Craft</h3><button type="button" onclick="addCraftSkill()">+ ADD</button></div> <div id="craft-skills-container"></div> </div>',t+='<div class="sub-skill-group"> <div class="sub-skill-header-flex"><h3 class="sub-skill-header">Foreign Language</h3><button type="button" onclick="addLanguageSkill()">+ ADD</button></div> <div id="language-skills-container"></div> </div>',t+="</div>",e.innerHTML=t}

    // --- TOOLTIP MANAGEMENT ---
    function setupTooltips(){const e=document.getElementById("skill-tooltip"),t=document.querySelectorAll("[data-skill]");t.forEach(t=>{t.addEventListener("mouseover",t=>{const n=t.target.dataset.skill,o=skillDescriptions[n];o&&(e.innerHTML=o,e.classList.remove("hidden"))}),t.addEventListener("mousemove",t=>{e.style.left=`${t.pageX+15}px`,e.style.top=`${t.pageY+15}px`}),t.addEventListener("mouseout",()=>{e.classList.add("hidden")})})}

    // --- THEME MANAGEMENT ---
    function changeTheme(e){localStorage.setItem("socom_theme",e),applyCurrentTheme(e)}
    function applyCurrentTheme(e){document.body.className="",isAdmin&&document.body.classList.add("admin-mode"),"default"!==e&&document.body.classList.add(e+"-theme")}
    function applySavedTheme(){const e=localStorage.getItem("socom_theme");e?applyCurrentTheme(e):applyAutoTheme()}
    function applyAutoTheme(){const e=localStorage.getItem("socom_theme");if(e&&"default"!==e&&"army"!==e)return void applyCurrentTheme(e);document.body.className="",isAdmin&&document.body.classList.add("admin-mode");const t=document.getElementById("rank"),n=t.options[t.selectedIndex]?.dataset.grade;if(n&&["O-1","O-2","O-3","GS-14","SIS-2"].includes(n))return void document.body.classList.add("officer-theme");const o=branches[document.getElementById("branch").value];o&&"army"!==o&&document.body.classList.add(o+"-theme")}

    // --- VIEW MANAGEMENT & UI/CALCS ---
    function beginTutorial(){showView("tutorial"),startTutorial()}
    function showView(e){document.querySelectorAll("main").forEach(e=>e.classList.add("hidden"));const t=document.getElementById(`${e}-view`);t&&(t.classList.remove("hidden"),"loader"===e&&loadSavedSheets())}
    function updateRanks(){const e=branches[document.getElementById("branch").value]||"intelligence",t=ranks[e].map(e=>{const t=e.adminOnly&&!isAdmin,n=`${e.name} (${e.grade})${e.adminOnly?" 🔒":""}`;return`<option value="${e.name}" data-grade="${e.grade}" ${t?"disabled":""}>${n}</option>`}).join("");document.getElementById("rank").innerHTML=t,applyAutoTheme()}
    function changeStat(e,t){if(statsUnlocked)return;const n=document.getElementById(e);let o=stats.reduce((e,t)=>e+parseInt(document.getElementById(t).value)-MIN_STAT_VALUE,0),a=parseInt(n.value);t>0&&o<MAX_STAT_POINTS&&a<MAX_STAT_VALUE?n.value=a+1:t<0&&a>MIN_STAT_VALUE&&(n.value=a-1),updateAllCalculations()}
    function updateAllCalculations(){let e=0;stats.forEach(t=>{const n=parseInt(document.getElementById(t).value);e+=n-MIN_STAT_VALUE,document.getElementById(`${t}x5`).textContent=`x5: ${5*n}`,document.getElementById(`${t}-desc`).textContent=getStatDescription(t,n)}),document.getElementById("stat-points-remaining").textContent=MAX_STAT_POINTS-e,updateDerivedAttributes(),updateBondScores(),updateLinkedWeaponStats()}
    function updateDerivedAttributes(){const e=parseInt(document.getElementById("STR").value),t=parseInt(document.getElementById("CON").value),n=parseInt(document.getElementById("POW").value),o=document.getElementById("hp-max"),a=document.getElementById("wp-max"),i=document.getElementById("san-max"),s=document.getElementById("bp");isAdmin||(o.value=Math.ceil((e+t)/2),a.value=n,i.value=5*n,s.value=Math.max(0,parseInt(i.value)-n));const l=document.getElementById("hp-current");l.max=parseInt(o.value),(!l.value||parseInt(l.value)>l.max)&&(l.value=l.max);const c=document.getElementById("wp-current");c.max=parseInt(a.value),(!c.value||parseInt(c.value)>c.max)&&(c.value=c.max);const d=document.getElementById("san-current");d.max=parseInt(i.value),(!d.value||parseInt(d.value)>d.max)&&(d.value=d.max),checkBreakingPoint()}
    function checkBreakingPoint(){const e=parseInt(document.getElementById("san-current").value),t=parseInt(document.getElementById("bp").value);document.getElementById("bp-warning").classList.toggle("hidden",e>t)}
    function acknowledgeBreakingPoint(){document.getElementById("bp").value=Math.max(0,parseInt(document.getElementById("san-current").value)-parseInt(document.getElementById("POW").value)),document.getElementById("bp-warning").classList.add("hidden")}
    function getStatDescription(e,t){const n=statDescriptions[e];let o=n[t]||"";for(const e in n)t>=e&&(o=n[e]);return`// ${o}`}
    
    // --- SKILL IMPROVEMENT ---
    function updateRollSkillsButtonVisibility(){const e=document.querySelectorAll('#skills-container input[type="checkbox"]:checked');document.getElementById("roll-skills-btn").classList.toggle("hidden",0===e.length)}
    function startSkillImprovement(){document.getElementById("skill-roll-modal").classList.remove("hidden"),document.getElementById("skill-roll-prompt").classList.remove("hidden"),document.getElementById("skill-roll-process").classList.add("hidden"),document.getElementById("skill-roll-conclusion").classList.add("hidden")}
    function closeSkillRollModal(){document.getElementById("skill-roll-modal").classList.add("hidden")}
    async function executeSkillRolls(){const e=Array.from(document.querySelectorAll('#skills-container input[type="checkbox"]:checked')),t=[];for(const n of e){const e=n.closest(".skill-item-simple, .sub-skill-item");if(!e)continue;const o=e.querySelector('input[type="number"]');let a="Unknown Skill";if(e.classList.contains("skill-item-simple"))a=e.querySelector(".skill-label-input label").textContent.trim();else{const t=e.querySelector('select[data-skill="Craft"]'),n=e.querySelector('input[placeholder="Language"]');if(t)a=`Craft: ${t.value}`;else if(n)a=`Language: ${n.value||"(Unnamed)"}`;else{const t=e.closest(".sub-skill-group"),n=t.querySelector(".sub-skill-header"),i=e.querySelector(".skill-label-input label").textContent.trim();a=`${n.textContent.trim()}: ${i}`}}const i=parseInt(o.value,10);if(i>=99)return alert(`ERROR: Skill "${a}" is already at its maximum value (99). Cannot improve further.`),void closeSkillRollModal();t.push({name:a,checkbox:n,input:o,currentScore:i})}if(0===t.length)return void closeSkillRollModal();document.getElementById("skill-roll-prompt").classList.add("hidden"),document.getElementById("skill-roll-process").classList.remove("hidden");const n=document.getElementById("rolling-skill-name"),o=document.getElementById("dice-animation"),a=document.getElementById("roll-result-text");for(const e of t){n.textContent=`ROLLING: ${e.name.toUpperCase()}`,a.textContent="";const t=setInterval(()=>{o.textContent=Math.floor(4*Math.random())+1},100);await new Promise(e=>setTimeout(e,1e3)),clearInterval(t);const i=Math.floor(4*Math.random())+1;o.textContent=i;const s=Math.min(99,e.currentScore+i);e.input.value=s,a.textContent=`Result: +${i}. New Score: ${s}.`,e.checkbox.checked=!1,await new Promise(e=>setTimeout(e,2500))}document.getElementById("skill-roll-process").classList.add("hidden"),document.getElementById("skill-roll-conclusion").classList.remove("hidden"),updateRollSkillsButtonVisibility()}

    // --- INTERACTIVE SECTIONS ---
    function checkAdaptedStatus(){const e=document.querySelectorAll("#violence1:checked, #violence2:checked, #violence3:checked").length;document.getElementById("violence-adapted").classList.toggle("hidden",e<3);const t=document.querySelectorAll("#helplessness1:checked, #helplessness2:checked, #helplessness3:checked").length;document.getElementById("helplessness-adapted").classList.toggle("hidden",t<3)}
    function addCraftSkill(e={}){const t=document.getElementById("craft-skills-container"),n=document.createElement("div");n.className="sub-skill-item";let o=["Gunsmith","Locksmith","Mechanic","Microelectronics","Explosives"].map(t=>`<option value="${t}" ${t===e.type?"selected":""}>${t}</option>`).join("");n.innerHTML=`<label class="styled-checkbox"><input type="checkbox" ${e.checked?"checked":""}><span class="checkbox-visual"></span></label><div class="skill-label-input"><select data-skill="Craft">${o}</select><input type="number" min="0" max="100" value="${e.score||0}"></div><button class="remove-btn" onclick="this.parentElement.remove()">X</button>`,t.appendChild(n),setupTooltips()}
    function addLanguageSkill(e={}){const t=document.getElementById("language-skills-container"),n=document.createElement("div");n.className="sub-skill-item",n.innerHTML=`<label class="styled-checkbox"><input type="checkbox" ${e.checked?"checked":""}><span class="checkbox-visual"></span></label><div class="skill-label-input"><input type="text" placeholder="Language" value="${e.lang||""}"><input type="number" min="0" max="100" value="${e.score||0}"></div><button class="remove-btn" onclick="this.parentElement.remove()">X</button>`,t.appendChild(n)}
    function addBond(e={}){const t=document.getElementById("bonds-container"),n=document.createElement("div");n.className="bond-item",n.innerHTML=`<label class="styled-checkbox"><input type="checkbox" ${e.checked?"checked":""}><span class="checkbox-visual"></span></label><input type="text" placeholder="Bond Name" value="${e.name||""}"><select class="bond-score"></select><button class="remove-btn" onclick="this.parentElement.remove()">X</button>`,t.appendChild(n),updateBondScores(),e.score&&n.querySelector(".bond-score").value==e.score}
    function updateBondScores(){const e=parseInt(document.getElementById("CHA").value)||0;document.getElementById("bond-cha-note").textContent=`MAX SCORE: ${e}`,document.querySelectorAll(".bond-score").forEach(t=>{const n=t.value;let o="";for(let t=0;t<=e;t++)o+=`<option value="${t}">${t}</option>`;t.innerHTML=o,t.value=Math.min(n,e)})}
    
    // --- WEAPON MANAGEMENT ---
    function addDefaultUnarmed(){const e=weaponPresets["Melee Weapons"][0];addWeapon(e)}
    function getCalculatedSkill(e){if(!e)return 20;const t=(e,t)=>parseInt(document.getElementById(e)?.value)||t;switch(e){case"Unarmed Combat":return t("skill-Unarmed-Combat",40);case"Melee Weapons":return t("skill-Melee-Weapons",30);case"DEX*5":return 5*t("DEX",10);case"Firearms":return t("skill-Firearms",20);case"Athletics":return t("skill-Athletics",30);case"Athletics+20":return Math.min(99,t("skill-Athletics",30)+20);case"Heavy Weapons":return t("skill-Heavy-Weapons",10);case"Science":return Math.max(...["skill-science-biology","skill-science-chemistry","skill-science-mathematics","skill-science-physics"].map(e=>t(e,0)),10);default:return parseInt(e)||20}}
    function updateLinkedWeaponStats(){document.querySelectorAll("#weapons-body tr").forEach(e=>{const t=e.dataset.skillIdentifier;if(!t)return;const n=getCalculatedSkill(t),o=e.cells[1].querySelector("input");o&&(o.value=n);const a=e.dataset.baseDamage,i=e.cells[3].querySelector("input");if(("Unarmed Combat"===t||"Melee Weapons"===t)&&a&&i){let e=0;n>90?e=3:n>75?e=2:n>50&&(e=1),e>0?i.value=`${a.split(/[-+]/)[0].trim()}+${e}`:i.value=a}})}
    function addWeapon(e,t=!1){const n=document.getElementById("weapons-body").insertRow(),o={name:"",skill:"",range:"",dmg:"",ap:"",lethality:"",ammoC:"",ammoM:""},a=e||{};let i;i=a.skillIdentifier?{...o,...a,skill:getCalculatedSkill(a.skillIdentifier)}:{...o,...a},n.dataset.skillIdentifier=i.skillIdentifier||"",n.dataset.baseDamage=i.dmg||"",n.innerHTML=`<td><input type="text" value="${i.name}"></td><td><input type="number" min="0" max="99" value="${i.skill}"></td><td><div class="input-group"><input type="number" min="0" value="${i.range}"><span class="input-group-addon">m</span></div></td><td><input type="text" value="${i.dmg}"></td><td><input type="text" value="${i.ap}"></td><td><div class="input-group"><input type="number" min="0" max="100" value="${i.lethality}"><span class="input-group-addon">%</span></div></td><td><div class="derived-attr-input"><input type="number" min="0" value="${i.ammoC}"> / <input type="number" min="0" value="${i.ammoM}"></div></td><td><button type="button" class="remove-btn" onclick="this.closest('tr').remove()">X</button></td>`,t&&closeWeaponModal(),updateLinkedWeaponStats()}
    function openWeaponModal(){document.getElementById("weapon-preset-modal").classList.remove("hidden"),populateWeaponPresets()}
    function closeWeaponModal(){document.getElementById("weapon-preset-modal").classList.add("hidden")}
    function populateWeaponCategories(){const e=document.getElementById("weapon-category-select");e.innerHTML=Object.keys(weaponPresets).map(e=>`<option value="${e}">${e.toUpperCase()}</option>`).join("")}
    function populateWeaponPresets(){const e=document.getElementById("weapon-category-select").value,t=document.getElementById("weapon-preset-list");weaponPresets[e]&&(t.innerHTML=weaponPresets[e].map(e=>`\n            <li class="preset-item">\n                <div class="preset-info">\n                    <h4>${e.name} <span class="expense-tag">(${e.expense})</span></h4>\n                    ${e.desc?`<p>${e.desc}</p>`:""}\n                    ${e.examples?`<small>${e.examples}</small>`:""}\n                </div>\n                <button onclick='addWeapon(${JSON.stringify(e)}, true)'>SELECT</button>\n            </li>\n        `).join(""))}
    
    // --- ARMOR MANAGEMENT ---
    function toggleArmor(){isArmorActive?deactivateArmor():openArmorModal()}
    function openArmorModal(){populateArmorPresets(),document.getElementById("armor-modal").classList.remove("hidden")}
    function closeArmorModal(){document.getElementById("armor-modal").classList.add("hidden")}
    function populateArmorPresets(){const e=document.getElementById("armor-preset-list"),t=document.getElementById("helmet-checkbox");e.innerHTML=armorPresets.map(e=>`\n            <li class="preset-item" data-is-bomb-suit="${e.isBombSuit}">\n                <div class="preset-info">\n                    <h4>${e.name} <span class="expense-tag">(AP: ${e.ap})</span></h4>\n                    <p>${e.desc}</p>\n                </div>\n                <button onclick='selectArmor(${e.ap}, ${e.isBombSuit})'>SELECT</button>\n            </li>\n        `).join(""),document.querySelectorAll("#armor-preset-list .preset-item").forEach(e=>{e.addEventListener("mouseover",()=>{const n="true"===e.getAttribute("data-is-bomb-suit");n?(t.checked=!1,t.disabled=!0):t.disabled=!1})})}
    function selectArmor(e,t){const n=document.getElementById("helmet-checkbox");let o=e;n.checked&&!t&&(o+=1),isArmorActive=!0,currentArmorPoints=o;const a=document.getElementById("armor-points"),i=document.getElementById("armor-btn");a.value=o,a.classList.remove("hidden"),a.classList.add("armor-active"),i.classList.add("armor-active"),closeArmorModal()}
    function deactivateArmor(){isArmorActive=!1,currentArmorPoints=0;const e=document.getElementById("armor-points"),t=document.getElementById("armor-btn"),n=document.getElementById("helmet-checkbox");e.value=0,e.classList.add("hidden"),e.classList.remove("armor-active"),t.classList.remove("armor-active"),n.checked=!1,n.disabled=!1}
    function validateArmorPoints(e){const t=e.target;let n=parseInt(t.value,10);isNaN(n)&&(n=currentArmorPoints),n>currentArmorPoints?t.value=currentArmorPoints:currentArmorPoints=n,currentArmorPoints<=0&&deactivateArmor()}

    // --- ADMIN & LOCKING FUNCTIONS ---
    function toggleAdminMode(){const e=document.getElementById("rank"),t=e.value,n=["bp","hp-max","wp-max","san-max"];isAdmin?(isAdmin=!1,statsUnlocked&&toggleStatsLock(),document.body.classList.remove("admin-mode"),document.getElementById("admin-login-btn").textContent="Admin Login",document.getElementById("toggle-stats-lock-btn").classList.add("hidden"),document.getElementById("lock-branch-rank-container").classList.add("hidden"),n.forEach(e=>document.getElementById(e).readOnly=!0),updateAllCalculations(),alert("Admin mode deactivated.")):prompt("Enter NEMESIS clearance code:")===atob(ADMIN_PASSWORD_HASH)?(isAdmin=!0,document.body.classList.add("admin-mode"),document.getElementById("admin-login-btn").textContent="Admin Logout",document.getElementById("toggle-stats-lock-btn").classList.remove("hidden"),document.getElementById("lock-branch-rank-container").classList.remove("hidden"),n.forEach(e=>document.getElementById(e).readOnly=!1),alert("Admin mode activated. Privileges granted.")):alert("Access Denied."),updateRanks(),e.value=t,updateBranchRankLockState()}
    function toggleStatsLock(){statsUnlocked=!statsUnlocked;const e=document.getElementById("toggle-stats-lock-btn"),t=document.getElementById("stat-points-remaining").parentElement.parentElement;stats.forEach(e=>{const t=document.getElementById(e);t.readOnly=!statsUnlocked,t.previousElementSibling.disabled=statsUnlocked,t.nextElementSibling.disabled=statsUnlocked}),statsUnlocked?(e.textContent="LOCK STATS",t.classList.add("hidden")):(e.textContent="FORCE STATS",t.classList.remove("hidden"),updateAllCalculations())}
    function updateBranchRankLockState(){const e=document.getElementById("lock-branch-rank-checkbox").checked;document.getElementById("branch").disabled=e&&!isAdmin,document.getElementById("rank").disabled=e&&!isAdmin}

    // --- DATA MANAGEMENT ---
    function getCompleteFormData(){const e={id:document.getElementById("character-id").value||`sheet_${Date.now()}`};return e.branchRankLocked=document.getElementById("lock-branch-rank-checkbox").checked,document.querySelectorAll("#sheet-form [id]").forEach(t=>{t.id&&(e[t.id]="checkbox"===t.type?t.checked:t.value)}),e.crafts=Array.from(document.querySelectorAll("#craft-skills-container .sub-skill-item")).map(e=>({checked:e.querySelector("input[type=checkbox]").checked,type:e.querySelector("select").value,score:e.querySelector('input[type="number"]').value})),e.languages=Array.from(document.querySelectorAll("#language-skills-container .sub-skill-item")).map(e=>({checked:e.querySelector("input[type=checkbox]").checked,lang:e.querySelector('input[type="text"]').value,score:e.querySelector('input[type="number"]').value})),e.weapons=Array.from(document.querySelectorAll("#weapons-body tr")).map(e=>{const t=e.querySelectorAll("input");return{name:t[0].value,skill:t[1].value,range:t[2].value,dmg:t[3].value,ap:t[4].value,lethality:t[5].value,ammoC:t[6].value,ammoM:t[7].value}}),e.bonds=Array.from(document.querySelectorAll(".bond-item")).map(e=>({checked:e.querySelector('input[type="checkbox"]').checked,name:e.querySelector('input[type="text"]').value,score:e.querySelector("select").value})),e.isArmorActive=isArmorActive,e.currentArmorPoints=currentArmorPoints,e}
    function populateCompleteForm(e){resetForm(),document.getElementById("weapons-body").innerHTML="",Object.keys(e).forEach(t=>{"weapons"===t||"bonds"===t||"crafts"===t||"languages"===t||"branchRankLocked"===t||"isArmorActive"===t||"currentArmorPoints"===t||(document.getElementById(t)[document.getElementById(t).type==="checkbox"?"checked":"value"]=e[t])}),document.getElementById("bonds-container").innerHTML="",e.crafts&&e.crafts.forEach(e=>addCraftSkill(e)),e.languages&&e.languages.forEach(e=>addLanguageSkill(e)),e.weapons&&e.weapons.length>0?e.weapons.forEach(e=>addWeapon(e)):addDefaultUnarmed(),e.bonds&&e.bonds.length>0?e.bonds.forEach(e=>addBond(e)):(addBond(),addBond(),addBond()),document.getElementById("lock-branch-rank-checkbox").checked=e.branchRankLocked||!1,updateRanks(),e.rank&&(document.getElementById("rank").value=e.rank),updateAllCalculations(),checkAdaptedStatus(),applyAutoTheme(),updateBranchRankLockState(),e.isArmorActive?(isArmorActive=!0,currentArmorPoints=e.currentArmorPoints||0,currentArmorPoints>0?(document.getElementById("armor-points").value=currentArmorPoints,document.getElementById("armor-points").classList.remove("hidden"),document.getElementById("armor-points").classList.add("armor-active"),document.getElementById("armor-btn").classList.add("armor-active")):deactivateArmor()):deactivateArmor(),updateRollSkillsButtonVisibility()}
    function saveCharacter(){const e=getCompleteFormData(),t=e["full-name"]||"UNNAMED_AGENT",n=prompt("Save file as:",t);n&&(localStorage.setItem(e.id,JSON.stringify({name:n,...e})),alert(`Agent file '${n}' saved locally.`),loadSavedSheets())}
    function loadSavedSheets(){const e=document.getElementById("saved-sheets-list");e.innerHTML="";for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(n.startsWith("sheet_")){const o=JSON.parse(localStorage.getItem(n)),a=document.createElement("li");a.innerHTML=`<span>${o.name}</span><div><button onclick="renameSheet('${n}')">RENAME</button><button onclick="loadSheet('${n}')">LOAD</button><button class="remove-btn" onclick="deleteSheet('${n}')">DELETE</button></div>`,e.appendChild(a)}}}
    function loadSheet(e){populateCompleteForm(JSON.parse(localStorage.getItem(e))),showView("character-sheet")}
    function deleteSheet(e){confirm("DELETE FILE?")&&(localStorage.removeItem(e),loadSavedSheets())}
    function renameSheet(e){const t=JSON.parse(localStorage.getItem(e)),n=prompt("New filename:",t.name);n&&(t.name=n,localStorage.setItem(e,JSON.stringify(t)),loadSavedSheets())}
    function loadCharacterFromFile(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{populateCompleteForm(JSON.parse(e.target.result)),showView("character-sheet")},n.readAsText(t)}
    function exportToJson(){const e=getCompleteFormData(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`${(e["full-name"]||"agent").replace(/\s+/g,"_")}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}
    function screenshotPage(e){const t=e.currentTarget,n=t.textContent;t.textContent="...CAPTURING...",t.disabled=!0,html2canvas(document.querySelector(".container"),{useCORS:!0,allowTaint:!0,scrollX:0,scrollY:-window.scrollY}).then(e=>{const n=document.createElement("a");n.href=e.toDataURL("image/png",1),n.download=`${(document.getElementById("full-name").value||"UNNAMED_AGENT").replace(/\s+/g,"_")}_Sheet.png`,n.click(),n.remove()}).catch(e=>{console.error("Screenshot failed:",e),alert("Could not capture screenshot. See console for details.")}).finally(()=>{t.textContent=n,t.disabled=!1})}

    // --- TUTORIAL MODULE ---
    let currentTutorialStep = -1;
    let highlightedElement = null;
    let originalPadding = '';
    let currentValidationListener = null;

    // --- Validation Functions for Tutorial ---
    const areStatPointsSpent = () => (MAX_STAT_POINTS - stats.reduce((acc, s) => acc + (parseInt(document.getElementById(s).value) - MIN_STAT_VALUE), 0)) <= 0;
    const areSkillPointsSpent = () => {
        let totalSpent = 0; let langSpent = 0; let allUnderMax = true;
        document.querySelectorAll('#skills-container input[type="number"]').forEach(input => {
            const val = parseInt(input.value) || 0;
            if (val > 80) allUnderMax = false;
            const isLang = input.closest('#language-skills-container');
            if(isLang) { langSpent += val; } 
            else { totalSpent += val - (baseSkillValues[input.id.replace('skill-','').replace(/-/g, ' ')] || 0); }
        });
        return totalSpent >= 300 && langSpent >= 50 && allUnderMax;
    };
    const isAlertnessChecked = () => document.getElementById('check-skill-Alertness').checked;
    const isRollBtnClicked = () => document.getElementById('skill-roll-modal').classList.contains('hidden');
    const isMediumPistolAdded = () => !!Array.from(document.querySelectorAll('#weapons-body tr input[type="text"]')).find(el => el.value === 'Medium Pistol');

    const tutorialSteps = [
        { title: "SYSTEM INDUCTION", text: "This tutorial will guide you through creating and editing your agent dossier. This process is critical for operational readiness. You may cancel at any time. Click 'Continue' to proceed.", target: "#tutorial-prompt", isPromptOnly: true, before: () => showView('tutorial') },
        { title: "ACCESSING THE ROSTER", text: "All new agent files are initiated from the main system menu. Your first step is to access the creation interface. Click the highlighted button.", target: '#main-view button[onclick*="character-sheet"]', before: () => showView('main') },
        { title: "IDENTIFICATION: NAME", text: "An agent's identity is their first line of defense and their last link to the world. Enter your full name here. This is a non-negotiable field.", target: "#tutorial-target-fullname", before: () => { resetForm(); showView('character-sheet'); } },
        { title: "IDENTIFICATION: BRANCH", text: "Your branch determines your background and initial training. Operatives from the NSA and CIA excel at intelligence and espionage. Military branches are specialists in direct action. Your choice has minor gameplay effects but shapes your story.", target: "#tutorial-target-branch", positionHint: 'right' },
        { title: "SYSTEM INTERFACE THEME", text: "This system allows for cosmetic interface adjustments. Access the settings with the gear icon to change your theme. This has no impact on gameplay.", target: "#settings-container", noOverlay: true, after: () => document.getElementById('settings-menu').style.display = 'block' },
        { title: "IDENTIFICATION: RANK/GRADE", text: "All new agents begin at a probationary rank (E-5 for enlisted, GS-11 for officers). Higher ranks are earned through exemplary performance in the field and are locked until authorized by NEMESIS. Proceed to the next step.", target: "#tutorial-target-rank", positionHint: 'right' },
        { title: "IDENTIFICATION: TEAM", text: "You will be assigned to a SOCOM team. For this simulation, select either Team 1 or Team 2.", target: "#tutorial-target-team", positionHint: 'right' },
        { title: "IDENTIFICATION: BIOGRAPHICS", text: "Complete the remaining biographical data. Your 'Employer' should reflect your specific background (e.g., 'U.S. Army Rangers', 'CIA SAD'). Education can be detailed later.", target: "#tutorial-target-sex", positionHint: 'bottom' },
        { title: "CORE ATTRIBUTES", text: "These six statistics define your raw capabilities. You have 25 points to distribute. Each point increases a stat from the base of 8. Distribute all points to continue.", target: "#stats-container", positionHint: 'right', highlightPadding: '10px', validation: areStatPointsSpent, validationMsg: "Distribute all 25 points." },
        { title: "DERIVED ATTRIBUTES", text: "These values are calculated from your Core Attributes. Hit Points (HP) measure physical endurance. Willpower (WP) is for resisting psychological stress. Sanity (SAN) represents your mental stability. If your SAN drops to your Breaking Point (BP), you will suffer psychological trauma.", target: '#character-sheet-view .form-grid .col-1 .form-section:nth-of-type(2)', positionHint: 'right', highlightPadding: '10px' },
        { title: "BONDS", text: "Bonds are connections to your life outside the program—people and principles that keep you sane. They are your primary defense against Sanity loss. The number of points in your Bonds cannot exceed your Charisma (CHA) score.", target: '#character-sheet-view .form-grid .col-1 .form-section:nth-of-type(3)', positionHint: 'right', highlightPadding: '10px' },
        { title: "PSYCHOLOGICAL PROFILE", text: "Operations will expose you to extreme trauma. These checkboxes track your exposure to Violence and Helplessness. After three exposures of one type, you become 'Adapted,' and the SAN cost for similar events is reduced.", target: '#character-sheet-view .form-grid .col-1 .form-section:nth-of-type(4)', positionHint: 'right', highlightPadding: '10px' },
        { title: "GEAR & NOTES", text: "The final fields are for inventory and mission logs. Use 'Armor and Gear' to list your equipment. The 'Notes' field is for tracking injuries, mission objectives, or any other relevant data.", target: "#tutorial-target-gear", positionHint: 'top', highlightPadding: '10px' },
        { title: "SKILLS", text: "Skills represent trained abilities. You have 300 points for general skills and 50 for languages. No skill may exceed 80% at creation. Distribute your points to proceed.", target: "#skills-container", positionHint: 'top', highlightPadding: '10px', validation: areSkillPointsSpent, validationMsg: "Spend 300 general & 50 language points. Max skill 80%." },
        { title: "SKILL IMPROVEMENT: PART 1", text: "After a mission, you can improve skills you failed. You mark the failed skill by checking the box next to it. For this demonstration, mark 'Alertness.'", target: '#check-skill-Alertness', noOverlay: true, validation: isAlertnessChecked, validationMsg: "Check the box next to ALERTNESS." },
        { title: "SKILL IMPROVEMENT: PART 2", text: "With a skill checked, the 'Roll 1d4s' button appears. Clicking this initiates a final, irreversible roll to improve all checked skills. Proceed.", target: "#roll-skills-btn", noOverlay: true, after: () => document.getElementById('roll-skills-btn').classList.remove('hidden') },
        { title: "SKILL IMPROVEMENT: PART 3", text: "The system processes the improvement roll. In a real scenario, this would be permanent. For this tutorial, we will reset the value. Confirm and close the window to continue.", target: "#skill-roll-modal .modal-content", noOverlay: true, positionHint: 'left', before: () => { skillValueBeforeRoll = document.getElementById('skill-Alertness').value; startSkillImprovement(); }, after: () => setTimeout(() => { executeSkillRolls().then(() => { document.getElementById('skill-Alertness').value = skillValueBeforeRoll; }); }, 500) },
        { title: "WEAPONS & LOADOUT", text: "An agent is only as good as their equipment. To add a weapon to your loadout, access the preset database. Click '+ ADD WEAPON'.", target: 'button[onclick="openWeaponModal()"]' },
        { title: "WEAPON SELECTION", text: "The database is categorized for ease of access. We will equip a standard sidearm. Select 'Medium Pistol' from the 'Firearms' category.", target: '#weapon-preset-modal .modal-content', noOverlay: true, positionHint: 'left', before: openWeaponModal, validation: isMediumPistolAdded, validationMsg: "Select a 'Medium Pistol'." },
        { title: "WEAPON DATA", text: "The weapon is now added to your dossier. Its stats are listed here, including the required skill, damage, and ammo. All fields can be manually edited.", target: '#weapons-body tr:last-child', highlightPadding: '5px' },
        { title: "INDUCTION COMPLETE", text: "You have completed the NEMESIS agent induction protocol. Save your file after every session, and check skills you fail in the field. Your life depends on it. Good luck, agent. //NEMESIS", target: "#tutorial-prompt", isPromptOnly: true, before: () => showView('character-sheet') },
    ];
    
    function startTutorial() { document.getElementById('tutorial-container').classList.remove('hidden'); const audio = document.getElementById('tutorial-audio'); audio.volume = 0.3; audio.play().catch(e => console.log("Autoplay blocked.")); currentTutorialStep = 0; runTutorialStep(currentTutorialStep); }
    function cancelTutorial() { const audio = document.getElementById('tutorial-audio'); audio.pause(); audio.currentTime = 0; document.getElementById('tutorial-container').classList.add('hidden'); if (highlightedElement) { highlightedElement.classList.remove('tutorial-highlight'); highlightedElement.style.padding = originalPadding; highlightedElement = null; } document.getElementById('settings-menu').style.display = 'none'; if(currentValidationListener) { document.body.removeEventListener('input', currentValidationListener); currentValidationListener = null; } showView('character-sheet'); }
    function advanceTutorial(dir) { currentTutorialStep += dir; if(currentTutorialStep < 0) currentTutorialStep = 0; if(currentTutorialStep >= tutorialSteps.length) { cancelTutorial(); return; } runTutorialStep(currentTutorialStep); }
    function highlightElement(el, padding = '0px') { if (highlightedElement) { highlightedElement.classList.remove('tutorial-highlight'); highlightedElement.style.padding = originalPadding; } if (el) { originalPadding = el.style.padding; el.style.padding = padding; el.classList.add('tutorial-highlight'); highlightedElement = el; el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' }); } }
    function positionPrompt(targetEl, hint = 'bottom') {
        const promptEl = document.getElementById('tutorial-prompt');
        if (!targetEl) { promptEl.style.top = '50%'; promptEl.style.left = '50%'; promptEl.style.transform = 'translate(-50%, -50%)'; return; }
        const targetRect = targetEl.getBoundingClientRect(); const promptRect = promptEl.getBoundingClientRect();
        let top, left;
        switch(hint) {
            case 'right': top = targetRect.top; left = targetRect.right + 15; break;
            case 'left': top = targetRect.top; left = targetRect.left - promptRect.width - 15; break;
            case 'top': top = targetRect.top - promptRect.height - 15; left = targetRect.left + (targetRect.width / 2) - (promptRect.width / 2); break;
            default: top = targetRect.bottom + 15; left = targetRect.left + (targetRect.width / 2) - (promptRect.width / 2);
        }
        if (top + promptRect.height > window.innerHeight) top = window.innerHeight - promptRect.height - 10;
        if (top < 10) top = 10;
        if (left + promptRect.width > window.innerWidth) left = window.innerWidth - promptRect.width - 10;
        if (left < 10) left = 10;
        promptEl.style.top = `${top}px`; promptEl.style.left = `${left}px`; promptEl.style.transform = 'none';
    }
    
    async function runTutorialStep(stepIndex) {
        if (highlightedElement) { highlightedElement.classList.remove('tutorial-highlight'); highlightedElement.style.padding = originalPadding; }
        if (currentValidationListener) { document.body.removeEventListener('input', currentValidationListener); currentValidationListener = null; }
        document.getElementById('settings-menu').style.display = 'none';

        const step = tutorialSteps[stepIndex];
        if (step.before) { step.before(); await new Promise(resolve => setTimeout(resolve, 150)); }
        
        document.getElementById('tutorial-title').textContent = step.title;
        document.getElementById('tutorial-text').innerHTML = step.text;
        document.querySelector('.tutorial-overlay').style.display = step.noOverlay ? 'none' : 'block';
        
        let navHTML = `<div>`;
        if (stepIndex > 0) navHTML += `<button id="tutorial-back-btn"><< BACK</button>`;
        navHTML += `<button id="tutorial-cancel-btn">CANCEL</button></div>`;
        navHTML += `<span class="step-counter">${stepIndex + 1} / ${tutorialSteps.length}</span>`;
        if (step.title === "SYSTEM INDUCTION") navHTML += `<button id="tutorial-next-btn">CONTINUE >></button>`;
        else if (stepIndex < tutorialSteps.length -1) navHTML += `<button id="tutorial-next-btn">NEXT >></button>`;
        else navHTML += `<button id="tutorial-finish-btn">FINISH</button>`;
        document.getElementById('tutorial-nav').innerHTML = navHTML;

        const nextBtn = document.getElementById('tutorial-next-btn');
        if (document.getElementById('tutorial-back-btn')) document.getElementById('tutorial-back-btn').onclick = () => advanceTutorial(-1);
        if (document.getElementById('tutorial-cancel-btn')) document.getElementById('tutorial-cancel-btn').onclick = cancelTutorial;
        if (document.getElementById('tutorial-finish-btn')) document.getElementById('tutorial-finish-btn').onclick = cancelTutorial;
        if (nextBtn) nextBtn.onclick = () => advanceTutorial(1);

        const validationMsgEl = document.getElementById('tutorial-validation-msg');
        validationMsgEl.textContent = '';

        if (step.validation && nextBtn) {
            const check = () => {
                if (step.validation()) {
                    nextBtn.disabled = false;
                    validationMsgEl.textContent = '';
                } else {
                    nextBtn.disabled = true;
                    validationMsgEl.textContent = step.validationMsg || 'Requirement not met.';
                }
            };
            currentValidationListener = check;
            document.body.addEventListener('input', currentValidationListener);
            document.body.addEventListener('change', currentValidationListener); // For checkboxes & selects
            document.body.addEventListener('click', currentValidationListener); // For button clicks that change state
            check();
        }

        let targetEl = step.target ? document.querySelector(step.target) : null;
        if(step.isPromptOnly) targetEl = null;

        highlightElement(targetEl, step.highlightPadding);
        positionPrompt(targetEl, step.positionHint);

        if (step.after) step.after();
    }
</script>

</body>
</html>
