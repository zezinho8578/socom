<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.O.C.O.M. // Network Intrusion</title>
    <link rel="icon" type="image/png" href="https://www.socom.mil/SOF-ATL/PublishingImages/eSOF-Logo.png">
    <style>
        /* Base styles copied from your main project */
        @keyframes flicker { 0%, 100% { opacity: 0.95; } 50% { opacity: 1; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes pulse-blue { 0%, 100% { box-shadow: 0 0 8px #4682B4; } 50% { box-shadow: 0 0 12px #6ca2cf; } }
        @keyframes pulse-red { 0%, 100% { background-color: #B22222; } 50% { background-color: #d84545; } }

        :root {
            --bg-color: #050805; --scanline-color: rgba(0, 255, 85, 0.1); --text-color: #00ff55;
            --accent-color: #00ff55; --border-color: #00521d; --input-bg: rgba(0, 31, 9, 0.95);
            --danger-color: #ff4141; --danger-bg: rgba(255, 65, 65, 0.15); --container-bg: rgba(0,0,0,0.4);
            --success-color: #0f0;
            --node-color: rgba(0, 82, 29, 0.5);
            --node-border: #00521d;
            --node-captured: #00ff55;
            --node-firewall: #B22222;
            --node-start: #4682B4;
        }

        body { font-family: 'Courier New', Courier, monospace; margin: 0; background-color: var(--bg-color); color: var(--text-color); text-shadow: 0 0 4px var(--accent-color); animation: flicker 0.15s infinite; }
        .container { max-width: 1200px; margin: 10px auto; padding: 10px; border: 1px solid var(--border-color); background: var(--container-bg); }
        .header { display: flex; align-items: center; border-bottom: 1px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 15px; }
        .logo { max-width: 80px; margin-right: 15px; filter: grayscale(100%) brightness(200%) contrast(150%); }
        h1 { font-size: 22px; text-transform: uppercase; } h1::after { content: '_'; animation: blink 1s step-end infinite; }
        h2 { text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; margin-top: 20px; }
        .content-menu { padding: 20px; border: 1px solid var(--border-color); margin: 20px 0; background: var(--input-bg); }
        button, .button { background: transparent; color: var(--accent-color); border: 1px solid var(--accent-color); padding: 8px 15px; font-size: 14px; cursor: pointer; margin: 5px; font-family: 'Courier New', Courier, monospace; text-transform: uppercase; text-decoration: none; }
        button:hover, .button:hover { background: var(--accent-color); color: var(--bg-color); text-shadow: none; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        input, select { width: 100%; padding: 6px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); font-family: 'Courier New', Courier, monospace; }
        label { font-weight: bold; display: block; margin-bottom: 4px; color: var(--accent-color); font-size: 14px; }
        .hidden { display: none !important; }
        .grid-3-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .status-message { padding: 10px; margin-bottom: 15px; border: 1px solid; text-align: center; }

        /* --- Game Specific Styles --- */
        #game-view { border: 1px solid var(--border-color); padding: 15px; }
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .trace-container { flex-grow: 1; }
        .trace-bar-outer { width: 100%; background: #000; border: 1px solid var(--border-color); padding: 2px; }
        #trace-bar-inner { height: 15px; background: var(--danger-color); width: 0%; transition: width 0.1s linear; }
        .status-display { font-size: 1.2em; font-weight: bold; margin-left: 20px; white-space: nowrap; }

        #grid-container {
            display: grid;
            gap: 4px;
            border: 1px solid var(--border-color);
            background: #000;
            padding: 5px;
            aspect-ratio: 1 / 1;
        }

        .node {
            background-color: var(--node-color);
            border: 1px solid var(--node-border);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .node:not(.captured):hover { background-color: #00521d; }

        .node.start { background-color: var(--node-start); animation: pulse-blue 1.5s infinite; }
        .node.end { border: 2px dashed var(--accent-color); }
        .node.end::after { 
            content: 'TARGET'; 
            font-size: 10px; 
            font-weight: bold;
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            color: var(--accent-color); 
            opacity: 0.8;
            text-shadow: 0 0 3px var(--bg-color);
        }
        .node.firewall { background-color: var(--node-firewall); }
        .node.captured { background-color: var(--node-captured); box-shadow: 0 0 5px var(--node-captured); z-index: 2; }
        .node.ice-flash { animation: pulse-red 0.5s ease; }

        /* Game over states */
        .game-lost .node:not(.captured) { background-color: rgba(255, 65, 65, 0.1); border-color: rgba(255, 65, 65, 0.4); }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <img src="https://images.squarespace-cdn.com/content/v1/629e0596d168b365d297c6c4/cea70b06-895e-401c-9669-04fa59cfc5e6/socom-logo.png" alt="SOCOM Logo" class="logo">
            <h1>S.O.C.O.M. // NETWORK INTRUSION</h1>
        </header>

        <!-- SETUP VIEW -->
        <div id="setup-view">
            <div class="content-menu">
                <h2>PROCEDURAL SETUP</h2>
                <div class="grid-3-col">
                    <div>
                        <label for="difficulty">NETWORK COMPLEXITY</label>
                        <select id="difficulty">
                            <option value="easy">LOW (5x5 Grid)</option>
                            <option value="medium" selected>STANDARD (8x8 Grid)</option>
                            <option value="hard">HIGH (12x12 Grid)</option>
                        </select>
                    </div>
                    <div>
                        <label for="hacking-skill">AGENT SIGINT SKILL %</label>
                        <input type="number" id="hacking-skill" min="0" max="100" placeholder="e.g., 65">
                    </div>
                    <div>
                        <label for="d100-roll">D100 ROLL</label>
                        <input type="number" id="d100-roll" min="1" max="100" placeholder="e.g., 34">
                    </div>
                </div>
                 <div style="text-align: center; margin-top: 20px;">
                    <button onclick="startIntrusion()">INITIATE INTRUSION</button>
                </div>
            </div>
        </div>

        <!-- GAME VIEW -->
        <div id="game-view" class="hidden">
            <div class="game-header">
                 <div class="trace-container">
                    <label>SYSTEM TRACE PROGRESS</label>
                    <div class="trace-bar-outer">
                        <div id="trace-bar-inner"></div>
                    </div>
                </div>
                <div id="status-display" class="status-display">STATUS: Establishing Uplink...</div>
            </div>
           
            <div id="roll-result" class="status-message"></div>

            <div id="grid-container"></div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <a href="https://socom.vercel.app/minigames/" class="button">> RETURN TO UTILITIES MENU</a>
            <button id="reset-btn" class="hidden" onclick="resetSim()">RESTART SIM</button>
        </div>
    </div>

    <script>
        // --- GAME STATE & CORE LOGIC ---
        let game = {};

        function initializeSim() {
            // --- PERSISTENT LOCKOUT CHECK ---
            const perm_lock_time = localStorage.getItem('socom_net_perm_lock');
            if (perm_lock_time) {
                const time_diff = Date.now() - parseInt(perm_lock_time, 10);
                if (time_diff < 300000) { // 5 minutes in ms
                    forceShowLostState(true); // true for permanent lock
                    return;
                } else {
                    localStorage.removeItem('socom_net_perm_lock');
                    localStorage.removeItem('socom_net_attempts');
                }
            }

            const lockout = localStorage.getItem('socom_net_lockout');
            if (lockout) {
                forceShowLostState(false);
                return;
            }

            // If no locks, show setup
            document.getElementById('setup-view').classList.remove('hidden');
        }


        function startIntrusion() {
            // --- 1. GATHER SETUP DATA ---
            const difficulty = document.getElementById('difficulty').value;
            const skill = parseInt(document.getElementById('hacking-skill').value);
            const roll = parseInt(document.getElementById('d100-roll').value);
            if (isNaN(skill) || isNaN(roll)) {
                alert('Please fill in your Hacking skill and d100 roll.');
                return;
            }

            // --- 2. CONFIGURE GAME BASED ON DIFFICULTY ---
            let gridSize, baseTraceSpeed, firewallRatio;
            switch(difficulty) {
                case 'easy': gridSize = 5; baseTraceSpeed = 0.2; firewallRatio = 0.10; break;
                case 'hard': gridSize = 12; baseTraceSpeed = 0.4; firewallRatio = 0.25; break;
                default: gridSize = 8; baseTraceSpeed = 0.3; firewallRatio = 0.20; break;
            }

            // --- 3. PERFORM SKILL CHECK ---
            game = {
                gridSize,
                grid: [],
                path: [],
                traceProgress: 0,
                traceSpeed: baseTraceSpeed,
                iceActive: false,
                isActive: true,
            };
            
            const resultEl = document.getElementById('roll-result');
            let resultText = '';
            if (roll >= 96) {
                resultText = `FUMBLE (${roll}) - Counter-hack detected! Active ICE countermeasures and accelerated trace.`;
                resultEl.style.borderColor = 'var(--danger-color)';
                game.traceSpeed *= 1.5;
                game.iceActive = true;
            } else if (roll > skill) {
                resultText = `FAILURE (${roll}) - Unfamiliar network architecture. System trace is faster than anticipated.`;
                resultEl.style.borderColor = 'var(--danger-color)';
                game.traceSpeed *= 1.25;
            } else if (roll <= 5) {
                resultText = `CRITICAL (${roll}) - Found a backdoor exploit. The system trace is significantly slowed.`;
                resultEl.style.borderColor = 'var(--success-color)';
                game.traceSpeed *= 0.5;
            } else { // Success
                resultText = `SUCCESS (${roll}) - Standard intrusion. Operating within expected parameters.`;
                resultEl.style.borderColor = 'var(--accent-color)';
            }
            resultEl.textContent = resultText;

            // --- 4. INITIALIZE UI & GENERATE GRID ---
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');
            document.getElementById('status-display').textContent = "STATUS: IN PROGRESS";

            generateGrid(firewallRatio);
            renderGrid();

            // --- 5. START TRACE TIMER ---
            game.timerInterval = setInterval(updateTrace, 100);
        }

        function generateGrid(firewallRatio) {
            game.grid = []; // Reset grid
            // Create a 2D array of node objects
            for (let y = 0; y < game.gridSize; y++) {
                const row = [];
                for (let x = 0; x < game.gridSize; x++) {
                    row.push({ x, y, type: 'normal', captured: false });
                }
                game.grid.push(row);
            }

            // Set start and end nodes
            const startNode = game.grid[0][0];
            startNode.type = 'start';
            startNode.captured = true;
            game.path = [startNode];

            const endNode = game.grid[game.gridSize - 1][game.gridSize - 1];
            endNode.type = 'end';
            
            // Place firewalls randomly
            const totalNodes = game.gridSize * game.gridSize;
            const firewallCount = Math.floor(totalNodes * firewallRatio);
            for (let i = 0; i < firewallCount; i++) {
                let randX, randY;
                do {
                    randX = Math.floor(Math.random() * game.gridSize);
                    randY = Math.floor(Math.random() * game.gridSize);
                } while (game.grid[randY][randX].type !== 'normal'); // Ensure we don't overwrite start/end
                game.grid[randY][randX].type = 'firewall';
            }
        }

        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${game.gridSize}, 1fr)`;

            for (let y = 0; y < game.gridSize; y++) {
                for (let x = 0; x < game.gridSize; x++) {
                    const node = game.grid[y][x];
                    const el = document.createElement('div');
                    el.className = 'node';
                    el.classList.add(node.type);
                    if (node.captured) el.classList.add('captured');
                    el.dataset.x = x;
                    el.dataset.y = y;
                    el.onclick = () => handleNodeClick(x, y);
                    container.appendChild(el);
                }
            }
        }

        function handleNodeClick(x, y) {
            if (!game.isActive) return;
            const node = game.grid[y][x];
            if (node.captured) return;

            const isAdjacent = game.path.some(p => 
                (Math.abs(p.x - x) === 1 && p.y === y) || (p.x === x && Math.abs(p.y - y) === 1)
            );
            if (!isAdjacent) return;

            if (node.type === 'firewall') {
                game.traceProgress = Math.min(100, game.traceProgress + 5);
            }
            node.captured = true;
            game.path.push(node);
            
            const el = document.querySelector(`.node[data-x='${x}'][data-y='${y}']`);
            el.classList.add('captured');

            if (node.type === 'end') {
                winGame();
            }
        }

        function updateTrace() {
            if (!game.isActive) return;
            game.traceProgress += game.traceSpeed;
            document.getElementById('trace-bar-inner').style.width = `${game.traceProgress}%`;

            if (game.iceActive && Math.random() < 0.05) {
                triggerICE();
            }
            if (game.traceProgress >= 100) {
                loseGame();
            }
        }

        function triggerICE() {
            if (game.path.length <= 1) return;
            const nodeToReset = game.path[Math.floor(Math.random() * (game.path.length - 1)) + 1];
            if (!nodeToReset) return;
            const resetIndex = game.path.findIndex(p => p.x === nodeToReset.x && p.y === nodeToReset.y);
            const nodesToSever = game.path.slice(resetIndex);
            game.path = game.path.slice(0, resetIndex);
            nodesToSever.forEach(node => {
                node.captured = false;
                const el = document.querySelector(`.node[data-x='${node.x}'][data-y='${node.y}']`);
                if (el) {
                    el.classList.remove('captured');
                    el.classList.add('ice-flash');
                    setTimeout(() => el.classList.remove('ice-flash'), 500);
                }
            });
        }

        function winGame() {
            clearInterval(game.timerInterval);
            game.isActive = false;
            document.getElementById('status-display').textContent = "STATUS: SUCCESS";
            document.getElementById('status-display').style.color = 'var(--success-color)';
            // Clear any locks from previous failures
            localStorage.removeItem('socom_net_lockout');
            localStorage.removeItem('socom_net_attempts');
            localStorage.removeItem('socom_net_perm_lock');
        }

        function loseGame() {
            clearInterval(game.timerInterval);
            game.isActive = false;
            document.getElementById('status-display').textContent = "STATUS: TRACE COMPLETE";
            document.getElementById('status-display').style.color = 'var(--danger-color)';
            document.getElementById('grid-container').classList.add('game-lost');
            localStorage.setItem('socom_net_lockout', Date.now());
            localStorage.setItem('socom_net_attempts', '0');
        }

        function resetSim() {
            const code = prompt("ADMINISTRATIVE OVERRIDE REQUIRED.\nEnter 4-digit reset code:");
            if (code === null) return;

            if (code === "1711") {
                localStorage.removeItem('socom_net_lockout');
                localStorage.removeItem('socom_net_attempts');
                localStorage.removeItem('socom_net_perm_lock');
                window.location.reload();
            } else {
                let attempts = parseInt(localStorage.getItem('socom_net_attempts') || '0', 10);
                attempts++;
                localStorage.setItem('socom_net_attempts', attempts);
                alert('ERROR: Invalid override code.');
                if (attempts >= 2) {
                    localStorage.setItem('socom_net_perm_lock', Date.now());
                    forceShowLostState(true);
                }
            }
        }

        function forceShowLostState(isPermanent) {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');
            
            document.getElementById('grid-container').innerHTML = '';
            document.getElementById('roll-result').classList.add('hidden');
            document.getElementById('trace-bar-inner').style.width = '100%';
            
            const statusDisplay = document.getElementById('status-display');
            const resetButton = document.getElementById('reset-btn');

            if (isPermanent) {
                statusDisplay.textContent = 'STATUS: TERMINAL LOCKED';
                statusDisplay.style.color = 'var(--danger-color)';
                resetButton.disabled = true;
            } else {
                statusDisplay.textContent = 'STATUS: TRACE COMPLETE';
                statusDisplay.style.color = 'var(--danger-color)';
                resetButton.disabled = false;
            }
        }

        // --- INITIALIZE ---
        window.onload = initializeSim;

    </script>
</body>
</html>
