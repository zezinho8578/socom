<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.O.C.O.M. // EOD Simulation</title>
    <link rel="icon" type="image/png" href="https://www.socom.mil/SOF-ATL/PublishingImages/eSOF-Logo.png">
    <style>
        /* Base styles copied from your main project */
        @keyframes flicker { 0%, 100% { opacity: 0.95; } 50% { opacity: 1; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes flash-red { 0%, 100% { background-color: var(--danger-bg); } 50% { background-color: var(--bg-color); } }

        :root {
            --bg-color: #050805; --scanline-color: rgba(0, 255, 85, 0.1); --text-color: #00ff55;
            --accent-color: #00ff55; --border-color: #00521d; --input-bg: rgba(0, 31, 9, 0.95);
            --danger-color: #ff4141; --danger-bg: rgba(255, 65, 65, 0.15); --container-bg: rgba(0,0,0,0.4);
            --success-color: #0f0;
        }

        body { font-family: 'Courier New', Courier, monospace; margin: 0; background-color: var(--bg-color); color: var(--text-color); text-shadow: 0 0 4px var(--accent-color); animation: flicker 0.15s infinite; }
        body.flash { animation: flash-red 0.3s ease-in-out; }

        .container { max-width: 1200px; margin: 10px auto; padding: 10px; border: 1px solid var(--border-color); background: var(--container-bg); }
        .header { display: flex; align-items: center; border-bottom: 1px solid var(--accent-color); padding-bottom: 5px; margin-bottom: 15px; }
        .logo { max-width: 80px; margin-right: 15px; filter: grayscale(100%) brightness(200%) contrast(150%); }
        h1 { font-size: 22px; text-transform: uppercase; } h1::after { content: '_'; animation: blink 1s step-end infinite; }
        h2, h3 { text-transform: uppercase; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; margin-top: 20px; }
        h3:first-child { margin-top: 0; }
        .content-menu { padding: 20px; border: 1px solid var(--border-color); margin: 20px 0; background: var(--input-bg); }
        button, .button { background: transparent; color: var(--accent-color); border: 1px solid var(--accent-color); padding: 8px 15px; font-size: 14px; cursor: pointer; margin: 5px; font-family: 'Courier New', Courier, monospace; text-transform: uppercase; text-decoration: none; }
        button:hover, .button:hover { background: var(--accent-color); color: var(--bg-color); text-shadow: none; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
        input { width: 100%; padding: 6px; box-sizing: border-box; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); font-family: 'Courier New', Courier, monospace; }
        label { font-weight: bold; display: block; margin-bottom: 4px; color: var(--accent-color); font-size: 14px; }
        .hidden { display: none !important; }
        .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        ul { list-style-type: none; padding-left: 0; }
        li { background: rgba(0,0,0,0.2); border-left: 3px solid var(--border-color); padding: 10px; margin-bottom: 8px; }
        li strong { color: var(--accent-color); }
        
        /* --- Game Specific Styles --- */
        #game-view { display: grid; grid-template-columns: 1fr 1.5fr; gap: 20px; align-items: flex-start; }
        .device-panel { border: 1px solid var(--border-color); padding: 15px; }
        .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .timer-display { font-size: 2.5em; font-weight: bold; color: var(--danger-color); }
        .strike-display { font-size: 1.5em; }
        .status-display { text-align: center; font-size: 1.5em; font-weight: bold; margin-top: 20px; }
        .serial-number { text-align: center; padding: 5px; background: #000; border: 1px solid var(--border-color); margin-bottom: 15px; font-size: 1.1em; letter-spacing: 2px; }
        #roll-result-display { margin-top: 20px; padding: 15px; border: 1px solid; text-align: center; }
        #roll-result-display.crit { border-color: var(--success-color); color: var(--success-color); }
        #roll-result-display.success { border-color: var(--accent-color); }
        #roll-result-display.fail { border-color: var(--danger-color); color: var(--danger-color); }

        /* Module Styles */
        .module { background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); margin-bottom: 15px; position: relative; }
        .module-header { background: var(--border-color); padding: 5px 10px; font-weight: bold; }
        .module-content { padding: 15px; }
        .module-solved-light { width: 10px; height: 10px; background: #444; border-radius: 50%; position: absolute; top: 8px; right: 10px; border: 1px solid #000; }
        .module-solved-light.solved { background: var(--success-color); box-shadow: 0 0 5px var(--success-color); }

        .wires-container { display: flex; justify-content: center; align-items: center; gap: 15px; height: 160px; }
        .wire { width: 30px; height: 150px; border: 2px solid #111; border-radius: 5px; cursor: pointer; transition: all 0.1s; }
        .wire:hover { transform: scale(1.1); }
        .wire.cut { height: 10px; background: #333 !important; cursor: not-allowed; border-color: #555; align-self: flex-end; }

        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .keypad-display { height: 30px; background: #000; border: 1px solid var(--border-color); margin-bottom: 10px; text-align: right; padding: 5px; font-size: 1.5em; }
        
        #big-button { width: 100%; height: 80px; font-size: 1.8em; font-weight: bold; user-select: none; }
        
        /* Setup Styles */
        .series-selection-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .series-btn { padding: 20px 10px; font-size: 1.1em; }
        .series-btn.green { border-color: #2E8B57; color: #2E8B57; } .series-btn.green:hover { background: #2E8B57; color: var(--bg-color); }
        .series-btn.blue { border-color: #4682B4; color: #4682B4; } .series-btn.blue:hover { background: #4682B4; color: var(--bg-color); }
        .series-btn.red { border-color: #B22222; color: #B22222; } .series-btn.red:hover { background: #B22222; color: var(--bg-color); }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <img src="https://images.squarespace-cdn.com/content/v1/629e0596d168b365d297c6c4/cea70b06-895e-401c-9669-04fa59cfc5e6/socom-logo.png" alt="SOCOM Logo" class="logo">
            <h1>S.O.C.O.M. // EOD SIMULATION</h1>
        </header>

        <!-- SETUP VIEW -->
        <div id="setup-view">
            <div class="content-menu">
                <h2>PROCEDURAL SETUP</h2>
                <div class="grid-2-col">
                    <div>
                        <label for="demo-skill">AGENT DEMOLITIONS SKILL %</label>
                        <input type="number" id="demo-skill" min="0" max="100" placeholder="e.g., 65">
                    </div>
                    <div>
                        <label for="d100-roll">D100 ROLL</label>
                        <input type="number" id="d100-roll" min="1" max="100" placeholder="e.g., 34">
                    </div>
                </div>
            </div>
            <div class="content-menu">
                <h2>SELECT BOMB SERIES</h2>
                <div id="series-selection-grid" class="series-selection-grid"></div>
            </div>
        </div>

        <!-- GAME VIEW -->
        <div id="game-view" class="hidden">
            <div class="device-panel">
                <div class="device-header">
                    <div id="timer" class="timer-display">--:--</div>
                    <div id="strikes" class="strike-display">STRIKES: -/-</div>
                </div>
                <div id="serial-number" class="serial-number"></div>
                <div id="modules-container"></div>
                <div id="status" class="status-display">STATUS: STANDBY</div>
            </div>
            <div id="manual-panel" class="content-menu"></div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <a href="../" class="button">> RETURN TO UTILITIES MENU</a>
            <button id="reset-btn" class="hidden" onclick="resetGame()">RESTART SIM</button>
        </div>
    </div>

    <script>
        // --- DATA LIBRARIES ---
        const BOMB_SERIES_DEFINITIONS = {
            'M1-T': { name: "M1-T 'Tutor'", difficulty: 'Training', color: 'green', baseTime: 300, baseStrikes: 3, modulePool: ['wires'], moduleCount: 1 },
            'M4-S': { name: "M4-S 'Scorpion'", difficulty: 'Standard', color: 'blue', baseTime: 240, baseStrikes: 2, modulePool: ['wires', 'keypad'], moduleCount: 2 },
            'M7-B': { name: "M7-B 'Spectre'", difficulty: 'Hard', color: 'red', baseTime: 180, baseStrikes: 2, modulePool: ['wires', 'keypad', 'button'], moduleCount: 2 }
        };

        const MODULE_GENERATORS = {
            wires: {
                name: "WIRES",
                generate(game) {
                    const numWires = 4 + Math.floor(Math.random() * 3);
                    const colors = ['red', 'blue', 'yellow', 'white', 'black'];
                    const currentWires = Array.from({ length: numWires }, () => colors[Math.floor(Math.random() * colors.length)]);
                    
                    const rulePool = [
                        { text: "IF there are no red wires, <strong>CUT</strong> the second wire.", test: (wires) => wires.filter(c => c === 'red').length === 0, action: () => 1 },
                        { text: "IF there is exactly one blue wire, <strong>CUT</strong> the last white wire.", test: (wires) => wires.filter(c => c === 'blue').length === 1, action: (wires) => wires.lastIndexOf('white') },
                        { text: "IF there are more yellow than white wires, <strong>CUT</strong> the first yellow wire.", test: (wires) => wires.filter(c=>c==='yellow').length > wires.filter(c=>c==='white').length, action: (wires) => wires.indexOf('yellow') },
                        { text: "IF the last wire is black, <strong>CUT</strong> the fourth wire.", test: (wires) => wires[wires.length - 1] === 'black' && wires.length >= 4, action: () => 3 },
                        { text: "OTHERWISE, <strong>CUT</strong> the last red wire.", test: () => true, action: (wires) => wires.lastIndexOf('red') },
                        { text: "OTHERWISE, <strong>CUT</strong> the first wire.", test: () => true, action: () => 0 }
                    ];
                    
                    const shuffledRules = rulePool.filter(r => !r.text.startsWith("OTHERWISE")).sort(() => 0.5 - Math.random());
                    const chosenRules = shuffledRules.slice(0, 3);
                    chosenRules.push(Math.random() > 0.5 ? rulePool[4] : rulePool[5]);

                    return {
                        data: { currentWires, solved: false, steps: 1, completedSteps: 0, cutIndexes: [] },
                        manualHTML: `<h3>WIRES</h3><ul>${chosenRules.map(r => `<li>${r.text}</li>`).join('')}</ul>`,
                        logic: {
                            getCorrectWire: () => {
                                const activeWires = game.modules.wires.data.currentWires.map((color, index) => ({ color, index })).filter(w => !game.modules.wires.data.cutIndexes.includes(w.index));
                                for (const rule of chosenRules) {
                                    if (rule.test(activeWires.map(w => w.color))) {
                                        const targetIndexInActive = rule.action(activeWires.map(w => w.color));
                                        return targetIndexInActive !== -1 && targetIndexInActive < activeWires.length ? activeWires[targetIndexInActive].index : -1;
                                    }
                                }
                                return -1;
                            }
                        }
                    };
                }
            },
            keypad: {
                name: "KEYPAD",
                generate(game) {
                    const rulePool = [
                        { text: "The first digit is the number of starting strikes.", depends: null, getValue: () => game.maxStrikes },
                        { text: "The second digit is the first number in the serial number.", depends: null, getValue: () => { const d = game.serial.match(/\d/); return d ? d[0] : 0; } },
                        { text: "The third digit is the total number of modules on the device.", depends: null, getValue: () => Object.keys(game.modules).length },
                        { text: "The last digit is the number of vowels in the serial number.", depends: null, getValue: () => (game.serial.match(/[AEIOU]/gi) || []).length },
                        { text: "The first digit is the number of <strong>BLACK</strong> wires.", depends: 'wires', getValue: () => game.modules.wires.data.currentWires.filter(c=>c==='black').length },
                        { text: "The second digit is one more than the number of <strong>BLUE</strong> wires.", depends: 'wires', getValue: () => game.modules.wires.data.currentWires.filter(c=>c==='blue').length + 1 },
                    ];

                    const validRules = rulePool.filter(r => r.depends === null || !!game.modules[r.depends]).sort(() => 0.5 - Math.random());
                    const chosenRules = validRules.slice(0, 4);
                    const correctCode = chosenRules.map(r => r.getValue()).join('');

                    return {
                        data: { display: "", correctCode, solved: false },
                        manualHTML: `<h3>KEYPAD (4 DIGITS)</h3><ul>${chosenRules.map(r => `<li>${r.text}</li>`).join('')}</ul>`,
                    };
                }
            },
            button: {
                name: "BUTTON",
                generate(game) {
                    const colors = ['red', 'blue', 'white', 'yellow'];
                    const labels = ['DETONATE', 'ABORT', 'HOLD', 'PRESS'];
                    const data = {
                        currentColor: colors[Math.floor(Math.random() * colors.length)],
                        currentLabel: labels[Math.floor(Math.random() * labels.length)],
                        solved: false, isHeld: false
                    };
                    
                    const rulePool = [
                        { text: "<strong>IF</strong> the button is BLUE and says 'ABORT', <strong>PRESS AND HOLD</strong>.", test: () => data.currentColor === 'blue' && data.currentLabel === 'ABORT', action: 'hold' },
                        { text: "<strong>IF</strong> the serial number contains a vowel, <strong>PRESS AND RELEASE</strong>.", test: () => /[AEIOU]/i.test(game.serial), action: 'release' },
                        { text: "<strong>IF</strong> there are more than 2 <strong>RED</strong> wires, <strong>PRESS AND RELEASE</strong>.", depends: 'wires', test: () => game.modules.wires.data.currentWires.filter(c=>c==='red').length > 2, action: 'release' },
                        { text: "<strong>OTHERWISE</strong>, <strong>PRESS AND HOLD</strong>.", test: () => true, action: 'hold' }
                    ];
                    
                    const validRules = rulePool.filter(r => !r.depends || !!game.modules[r.depends]);
                    const holdRuleDigit = Math.floor(Math.random() * 6) + 1;

                    return {
                        data,
                        manualHTML: `<h3>BUTTON</h3><ul>${validRules.map(r => `<li>${r.text}</li>`).join('')}</ul><p><strong>IF HOLDING:</strong> Release when the timer has a '<strong>${holdRuleDigit}</strong>' in any position.</p>`,
                        logic: {
                            getCorrectAction: () => { for (const rule of validRules) { if (rule.test()) return rule.action; } },
                            getCorrectReleaseDigit: () => holdRuleDigit.toString()
                        }
                    };
                }
            }
        };
        
        // --- GAME STATE & CORE LOGIC ---
        let game = {};

        function initializeSetup() {
            const grid = document.getElementById('series-selection-grid');
            grid.innerHTML = '';
            for(const key in BOMB_SERIES_DEFINITIONS) {
                const series = BOMB_SERIES_DEFINITIONS[key];
                const btn = document.createElement('button');
                btn.className = `series-btn ${series.color}`;
                btn.innerHTML = `${series.name}<br><small>(${series.difficulty})</small>`;
                btn.onclick = () => startGame(series);
                grid.appendChild(btn);
            }
        }
        
        function startGame(series) {
            const skill = parseInt(document.getElementById('demo-skill').value);
            const roll = parseInt(document.getElementById('d100-roll').value);
            if (isNaN(skill) || isNaN(roll)) { alert('Please fill in your Demolitions skill and d100 roll.'); return; }

            game = { series, timeLeft: series.baseTime, maxStrikes: series.baseStrikes, strikes: 0, isActive: true, modules: {} };

            let statusText = ''; let statusClass = '';
            if (roll >= 96) { statusText = `FUMBLE (${roll}) - Panic sets in! Less time, one mistake is fatal.`; statusClass='fail'; game.timeLeft = Math.floor(series.baseTime * 0.7); game.maxStrikes = 0; }
            else if (roll > skill) { statusText = `FAILURE (${roll}) - Unfamiliar configuration. Time pressure is on.`; statusClass='fail'; game.timeLeft = Math.floor(series.baseTime * 0.85); game.maxStrikes = Math.max(0, series.baseStrikes - 1); }
            else if (roll <= 5) { statusText = `CRITICAL (${roll}) - You've seen this before. Extra time and margin for error.`; statusClass='crit'; game.timeLeft = Math.floor(series.baseTime * 1.5); game.maxStrikes = series.baseStrikes + 1; }
            else { statusText = `SUCCESS (${roll}) - Standard procedure. Operating within parameters.`; statusClass='success'; }
            
            game.serial = Array.from({length: 6}, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random() * 36)]).join('');
            
            const availableModules = [...series.modulePool].sort(() => 0.5 - Math.random());
            const chosenModuleKeys = availableModules.slice(0, series.moduleCount);
            
            let manualHTML = '';
            for(const key of chosenModuleKeys) {
                game.modules[key] = MODULE_GENERATORS[key].generate(game);
            }
            // Re-generate to ensure all dependencies are met
            for(const key of chosenModuleKeys) {
                 game.modules[key] = MODULE_GENERATORS[key].generate(game);
                 manualHTML += game.modules[key].manualHTML;
            }
            
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('game-view').classList.remove('hidden');
            document.getElementById('reset-btn').classList.remove('hidden');
            
            const manualPanel = document.getElementById('manual-panel');
            manualPanel.innerHTML = manualHTML + `<div id="roll-result-display" class="${statusClass}">${statusText}</div>`;
            document.getElementById('status').textContent = 'STATUS: ARMED';

            renderModules();
            updateDisplays();
            game.timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() { if (!game.isActive) return; game.timeLeft--; if (game.timeLeft <= 0) { game.timeLeft = 0; detonate(); } updateDisplays(); }
        function updateDisplays() {
            const minutes = String(Math.floor(game.timeLeft / 60)).padStart(2, '0');
            const seconds = String(game.timeLeft % 60).padStart(2, '0');
            document.getElementById('timer').textContent = `${minutes}:${seconds}`;
            document.getElementById('strikes').textContent = `STRIKES: ${game.strikes}/${game.maxStrikes}`;
            document.getElementById('serial-number').textContent = `S/N: ${game.serial}`;
        }
        function handleStrike() { if (!game.isActive) return; game.strikes++; updateDisplays(); document.body.classList.add('flash'); setTimeout(() => document.body.classList.remove('flash'), 300); if (game.strikes > game.maxStrikes) { detonate(); } }
        function checkWinCondition() { if (Object.values(game.modules).every(m => m.data.solved)) { disarm(); } }
        function detonate() { game.isActive = false; clearInterval(game.timerInterval); document.getElementById('status').textContent = 'STATUS: DETONATED'; document.getElementById('status').style.color = 'var(--danger-color)'; }
        function disarm() { game.isActive = false; clearInterval(game.timerInterval); document.getElementById('status').textContent = 'STATUS: DISARMED'; document.getElementById('status').style.color = 'var(--success-color)'; }
        function resetGame() { clearInterval(game.timerInterval); game = {}; document.getElementById('game-view').classList.add('hidden'); document.getElementById('reset-btn').classList.add('hidden'); document.getElementById('setup-view').classList.remove('hidden'); }

        // --- MODULE RENDERING ---
        function renderModules() {
            const container = document.getElementById('modules-container');
            container.innerHTML = '';
            for (const key in game.modules) {
                const module = game.modules[key];
                const moduleWrapper = document.createElement('div');
                moduleWrapper.className = 'module';
                moduleWrapper.id = `module-${key}`;
                let contentHTML = '';
                switch(key) {
                    case 'wires': contentHTML = `<div class="wires-container">${module.data.currentWires.map((color, i) => `<div class="wire" style="background-color:${color}" onclick="cutWire(${i})"></div>`).join('')}</div>`; break;
                    case 'keypad': contentHTML = `<div class="keypad-display" id="keypad-display"></div><div class="keypad-grid">${[1,2,3,4,5,6,7,8,9,'C','0','S'].map(k => `<button onclick="pressKeypad('${k}')">${k}</button>`).join('')}</div>`; break;
                    case 'button': contentHTML = `<button id="big-button" class="big-button" onmousedown="pressBigButton()" onmouseup="releaseBigButton()" style="background-color:${module.data.currentColor}; color: #000;">${module.data.currentLabel}</button>`; break;
                }
                moduleWrapper.innerHTML = `<div class="module-header">${MODULE_GENERATORS[key].name}</div><div class="module-solved-light"></div><div class="module-content">${contentHTML}</div>`;
                container.appendChild(moduleWrapper);
            }
        }
        
        // --- MODULE INTERACTION HANDLERS ---
        function cutWire(index) {
            const module = game.modules.wires;
            if (!game.isActive || module.data.solved) return;
            const wireEl = document.querySelector(`#module-wires .wire:nth-child(${index + 1})`);
            if (wireEl.classList.contains('cut')) return;

            if (index === module.logic.getCorrectWire()) {
                wireEl.classList.add('cut');
                module.data.cutIndexes.push(index);
                module.data.solved = true;
                document.querySelector('#module-wires .module-solved-light').classList.add('solved');
                checkWinCondition();
            } else { handleStrike(); }
        }

        function pressKeypad(key) {
            const module = game.modules.keypad;
            if (!game.isActive || module.data.solved) return;
            const display = document.getElementById('keypad-display');
            if (key === 'C') { module.data.display = ""; }
            else if (key === 'S') {
                if(module.data.display === module.data.correctCode) {
                    module.data.solved = true;
                    document.querySelector('#module-keypad .module-solved-light').classList.add('solved');
                    checkWinCondition();
                } else { handleStrike(); }
            }
            else if(module.data.display.length < module.data.correctCode.length) { module.data.display += key; }
            display.textContent = module.data.display;
        }

        function pressBigButton() {
            const module = game.modules.button;
            if (!game.isActive || module.data.solved) return;
            module.data.isHeld = true;
        }

        function releaseBigButton() {
            const module = game.modules.button;
            if (!game.isActive || !module.data.isHeld) return;
            module.data.isHeld = false;

            const correctAction = module.logic.getCorrectAction();
            const timerStr = document.getElementById('timer').textContent;

            let success = false;
            if (correctAction === 'hold' && timerStr.includes(module.logic.getCorrectReleaseDigit())) {
                success = true;
            } else if (correctAction === 'release') {
                success = true;
            }
            
            if(success) {
                module.data.solved = true;
                document.querySelector('#module-button .module-solved-light').classList.add('solved');
                checkWinCondition();
            } else { handleStrike(); }
        }
        
        window.onload = initializeSetup;
    </script>
</body>
</html>
